<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>IL2CPP - P.Z&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

    <script src='//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'></script>

<meta name="generator" content="Hexo 6.0.0"></head>

<!-- //unpkg.com/@waline/client -->
<!--  -->
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">P.Z&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/Diary/Diary">Diary</a>
            
            
            
            <a class="nav-item" href="/Friends/Friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Book/Book">Book</a>
            
            
            
            <a class="nav-item" href="/Sundry/Sundry">Sundry</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/PoZeep" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://space.bilibili.com/39892350" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            <span>July</span>
            
            
            
            
            
            
            <span>20,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">IL2CPP</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="IL2CPP-逆向"><a href="#IL2CPP-逆向" class="headerlink" title="IL2CPP 逆向"></a>IL2CPP 逆向</h1><h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>il2cpp 将游戏 C# 代码转换为 C++ 代码，然后编译为各平台 Native 代码。</p>
<p><img src="/2023/07/20/IL2CPP/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpbnhpbmZh,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述"></p>
<p>虽然游戏逻辑是以 Native 代码运行, 但依然要实现 C# 某些语言特性（如GC、反射)，il2cpp将所有的 C# 中的类名、方法名、属性名、字符串等地址信息记录在 global-metadata.dat 文件。</p>
<p>il2cpp启动时会从这个文件读取所需要的类名、方法名、属性名、字符串等地址信息。<br><img src="/2023/07/20/IL2CPP/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpbnhpbmZh,size_16,color_FFFFFF,t_70-16885421872262.png" alt="在这里插入图片描述"></p>
<p>Unity 使用 Mono 方式打包出来的 apk，那么此类逆向我们需要先解压apk，然后利用 IL2CPPDumper 来获取主逻辑代码符号</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Perfare/Il2CppDumper">https://github.com/Perfare/Il2CppDumper</a></p>
</blockquote>
<h3 id="libil2cpp-so与global-metadata-dat"><a href="#libil2cpp-so与global-metadata-dat" class="headerlink" title="libil2cpp.so与global-metadata.dat"></a>libil2cpp.so与global-metadata.dat</h3><p>想要利用上述工具，首先是要拿到这两个文件</p>
<p><strong>Android</strong></p>
<p>源\lib\armeabi-v8a\libil2cpp.so</p>
<p>源\assets\bin\Data\Managed\Metadata\global-metadata.dat</p>
<p><strong>PC</strong></p>
<p><app-name>_Data/il2cpp_data/Metadata/global-metadata.dat</p>
<p>UnityPlayer.dll</p>
<p>随后放入 input 目录</p>
<p><img src="/2023/07/20/IL2CPP/image-20230705124928743.png" alt="image-20230705124928743"></p>
<p>点击该.dat即可</p>
<p><img src="/2023/07/20/IL2CPP/image-20230705124949292.png" alt="image-20230705124949292"></p>
<p>随后我们去 output 目录查看</p>
<p><img src="/2023/07/20/IL2CPP/image-20230705145551454.png" alt="image-20230705145551454"></p>
<p><strong>dump.cs</strong></p>
<p>这个文件会把 C# 的 dll 代码的类、方法、字段列出来</p>
<p><strong>IL2cpp.h</strong></p>
<p>生成的 cpp 头文件，从头文件里可以看到相关的数据结构</p>
<p><strong>script.json</strong></p>
<p>以 json 格式显示类的方法信息</p>
<p><strong>stringliteral.json</strong></p>
<p>以 json 的格式显示所有字符串信息</p>
<p><strong>DummyDll</strong></p>
<p>进入该目录，可以看到很多dll，其中就有 Assembly-CSharp.dll 和我们刚刚的 dump.cs 内容是一致的</p>
<h3 id="IDA-TIME"><a href="#IDA-TIME" class="headerlink" title="IDA TIME"></a>IDA TIME</h3><p>当进行 IL2CPP 打包时，选择 CPU 架构可以选择 ARMv7 和 ARM64，所以相对应我们在 apk 解压后所看到的就是 arm64-v8a 和 armeabi-v7a，简单来说就是 64位 和 32位</p>
<p>随后放入相对应的 IDA，再按 ALT + F7 选择该文件</p>
<p><img src="/2023/07/20/IL2CPP/image-20230705151745911.png" alt="image-20230705151745911"></p>
<p>再选该文件</p>
<p><img src="/2023/07/20/IL2CPP/image-20230705151815489.png" alt="image-20230705151815489"></p>
<p>再导入头文件</p>
<p><img src="/2023/07/20/IL2CPP/image-20230705151845520.png" alt="image-20230705151845520"></p>
<p>经过漫长的等待就成功恢复符号了</p>
<p><img src="/2023/07/20/IL2CPP/image-20230705152812835.png" alt="image-20230705152812835"></p>
<h2 id="Finding-loaders-for-obfuscated-global-metadata-dat-files"><a href="#Finding-loaders-for-obfuscated-global-metadata-dat-files" class="headerlink" title="Finding loaders for obfuscated global-metadata.dat files"></a>Finding loaders for obfuscated global-metadata.dat files</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://katyscode.wordpress.com/2021/02/23/il2cpp-finding-obfuscated-global-metadata/">https://katyscode.wordpress.com/2021/02/23/il2cpp-finding-obfuscated-global-metadata/</a></p>
</blockquote>
<p>然而刚刚那标准的一套用 IL2CPPDumper 的套路并不完全适用，很多厂商都采取了对抗措施，接下来讲解混淆 global-metadata.dat 的思路</p>
<h3 id="How-do-I-know-if-global-metadata-dat-is-obfuscated"><a href="#How-do-I-know-if-global-metadata-dat-is-obfuscated" class="headerlink" title="How do I know if global-metadata.dat is obfuscated?"></a>How do I know if global-metadata.dat is obfuscated?</h3><p>当拿到我们的 metadata 文件后，放入查找十六进制的文件，如果开头魔术字依然是 AF 1B B1 FA，那么一般来说是没有被混淆的</p>
<p><img src="/2023/07/20/IL2CPP/image-20230707111015533.png" alt="image-20230707111015533"></p>
<p>那如果不是这个魔术字，一般来说也是被混淆了，而就像平常的逆向一样，程序运行起来肯定是会解密数据然后使用，这个思路同样使用于这，程序运行起来直接搜索该魔术字即可拿到 针对运行时解密的混淆手段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">frida_Memory</span>(<span class="params">pattern</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;头部标识:&quot;</span> + pattern);</span><br><span class="line">    <span class="keyword">var</span> addrArray = Process.enumerateRanges(<span class="string">&quot;r--&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; addrArray.length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> addr = addrArray[i];</span><br><span class="line">        Memory.scan(addr.base, addr.size, pattern,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="function"><span class="keyword">function</span> (<span class="params">address, size</span>)</span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;搜索到 &#x27;</span> + pattern + <span class="string">&quot; 地址是:&quot;</span> + address.toString());</span><br><span class="line">                <span class="built_in">console</span>.log(hexdump(address,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">length</span>: <span class="number">64</span>,</span><br><span class="line">                        <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    ));</span><br><span class="line">                <span class="comment">//0x108，0x10C如果不行，换0x100，0x104</span></span><br><span class="line">                <span class="keyword">var</span> DefinitionsOffset = <span class="built_in">parseInt</span>(address, <span class="number">16</span>) + <span class="number">0x108</span>;</span><br><span class="line">                <span class="keyword">var</span> DefinitionsOffset_size = Memory.readInt(ptr(DefinitionsOffset));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> DefinitionsCount = <span class="built_in">parseInt</span>(address, <span class="number">16</span>) + <span class="number">0x10C</span>;</span><br><span class="line">                <span class="keyword">var</span> DefinitionsCount_size = Memory.readInt(ptr(DefinitionsCount));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//根据两个偏移得出global-metadata大小</span></span><br><span class="line">                <span class="keyword">var</span> global_metadata_size = DefinitionsOffset_size + DefinitionsCount_size</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;大小：&quot;</span>, global_metadata_size);</span><br><span class="line">                <span class="keyword">var</span> file = <span class="keyword">new</span> File(<span class="string">&quot;/data/data/&quot;</span> + get_self_process_name() + <span class="string">&quot;/global-metadata.dat&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">                file.write(Memory.readByteArray(address, global_metadata_size));</span><br><span class="line">                file.flush();</span><br><span class="line">                file.close();</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;导出完毕...&#x27;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">//console.log(&quot;搜索完毕&quot;)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(frida_Memory(<span class="string">&quot;AF 1B B1 FA&quot;</span>)); <span class="comment">//global-metadata.dat头部特征</span></span><br></pre></td></tr></table></figure>



<h3 id="Metadata-loader-code-path"><a href="#Metadata-loader-code-path" class="headerlink" title="Metadata loader code path"></a>Metadata loader code path</h3><p>然而也有几种情况是上述方法解决不了的，我们得了解一下 metadata 的加载过程，因为混淆手段就有可能混入其中</p>
<p>而加载的调用链如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">il2cpp_init</span><br><span class="line">  -&gt; il2cpp::vm::Runtime::Init</span><br><span class="line">    -&gt; il2cpp::vm::MetadataCache::Initialize</span><br><span class="line">      -&gt; il2cpp::vm::MetadataLoader::LoadMetadataFile</span><br></pre></td></tr></table></figure>

<p>而在我们逆向中，这些都是不带符号的，然而我们可以对着源码来找到相对应的函数（不同版本的源码有一些差别）</p>
<p>il2cpp_init (located in il2cpp-api.cpp, comments elided):</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">il2cpp_init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* domain_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">setlocale</span>(LC_ALL, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Runtime::<span class="built_in">Init</span>(domain_name, <span class="string">&quot;v4.0.30319&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>il2cpp::vm::Runtime::Init (located in vm/Runtime.cpp):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Runtime::Init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename, <span class="keyword">const</span> <span class="keyword">char</span> *runtime_version)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SanityChecks();</span><br><span class="line"> </span><br><span class="line">    os::Initialize();</span><br><span class="line">    os::Locale::Initialize();</span><br><span class="line">    MetadataAllocInitialize();</span><br><span class="line"> </span><br><span class="line">    s_FrameworkVersion = framework_version_for(runtime_version);</span><br><span class="line"> </span><br><span class="line">    os::Image::Initialize();</span><br><span class="line">    os::Thread::Init();</span><br><span class="line">    il2cpp::utils::RegisterRuntimeInitializeAndCleanup::ExecuteInitializations();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!MetadataCache::Initialize())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    Assembly::Initialize();</span><br><span class="line">    gc::GarbageCollector::Initialize();</span><br><span class="line"> </span><br><span class="line">    Thread::Initialize();</span><br><span class="line">    Reflection::Initialize();</span><br><span class="line"> </span><br><span class="line">    register_allocator(il2cpp::utils::Memory::Malloc);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">memset</span>(&amp;il2cpp_defaults, <span class="number">0</span>, <span class="keyword">sizeof</span>(Il2CppDefaults));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">const</span> Il2CppAssembly* assembly = Assembly::Load(<span class="string">&quot;mscorlib.dll&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    il2cpp_defaults.corlib = Assembly::GetImage(assembly);</span><br><span class="line">    DEFAULTS_INIT(object_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Object&quot;</span>);</span><br><span class="line">    DEFAULTS_INIT(void_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Void&quot;</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(boolean_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Boolean&quot;</span>, <span class="keyword">bool</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(byte_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Byte&quot;</span>, <span class="keyword">uint8_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(sbyte_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;SByte&quot;</span>, <span class="keyword">int8_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(int16_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Int16&quot;</span>, <span class="keyword">int16_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(uint16_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;UInt16&quot;</span>, <span class="keyword">uint16_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(int32_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Int32&quot;</span>, <span class="keyword">int32_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(uint32_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;UInt32&quot;</span>, <span class="keyword">uint32_t</span>);</span><br><span class="line">    DEFAULTS_INIT(uint_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;UIntPtr&quot;</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(int_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;IntPtr&quot;</span>, <span class="keyword">intptr_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(int64_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Int64&quot;</span>, <span class="keyword">int64_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(uint64_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;UInt64&quot;</span>, <span class="keyword">uint64_t</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(single_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Single&quot;</span>, <span class="keyword">float</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(double_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Double&quot;</span>, <span class="keyword">double</span>);</span><br><span class="line">    DEFAULTS_INIT_TYPE(char_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;Char&quot;</span>, Il2CppChar);</span><br><span class="line">    DEFAULTS_INIT(string_class, <span class="string">&quot;System&quot;</span>, <span class="string">&quot;String&quot;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>il2cpp::vm::MetadataCache::Initialize (located in vm/MetadataCache.cpp, comments elided):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> il2cpp::vm::MetadataCache::Initialize()</span><br><span class="line">&#123;</span><br><span class="line">    s_GlobalMetadata = vm::MetadataLoader::LoadMetadataFile(<span class="string">&quot;global-metadata.dat&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!s_GlobalMetadata)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> </span><br><span class="line">    s_GlobalMetadataHeader = (<span class="keyword">const</span> Il2CppGlobalMetadataHeader*)s_GlobalMetadata;</span><br><span class="line">    IL2CPP_ASSERT(s_GlobalMetadataHeader-&gt;sanity == <span class="number">0xFAB11BAF</span>);</span><br><span class="line">    IL2CPP_ASSERT(s_GlobalMetadataHeader-&gt;version == <span class="number">24</span>);</span><br><span class="line"> </span><br><span class="line">    s_TypeInfoTable = (Il2CppClass**)IL2CPP_CALLOC(s_Il2CppMetadataRegistration-&gt;typesCount, <span class="keyword">sizeof</span>(Il2CppClass*));</span><br><span class="line">    s_TypeInfoDefinitionTable = (Il2CppClass**)IL2CPP_CALLOC(s_GlobalMetadataHeader-&gt;typeDefinitionsCount / <span class="keyword">sizeof</span>(Il2CppTypeDefinition), <span class="keyword">sizeof</span>(Il2CppClass*));</span><br><span class="line">    s_MethodInfoDefinitionTable = (<span class="keyword">const</span> MethodInfo**)IL2CPP_CALLOC(s_GlobalMetadataHeader-&gt;methodsCount / <span class="keyword">sizeof</span>(Il2CppMethodDefinition), <span class="keyword">sizeof</span>(MethodInfo*));</span><br><span class="line">    s_GenericMethodTable = (<span class="keyword">const</span> Il2CppGenericMethod**)IL2CPP_CALLOC(s_Il2CppMetadataRegistration-&gt;methodSpecsCount, <span class="keyword">sizeof</span>(Il2CppGenericMethod*));</span><br><span class="line">    s_ImagesCount = s_GlobalMetadataHeader-&gt;imagesCount / <span class="keyword">sizeof</span>(Il2CppImageDefinition);</span><br><span class="line">    s_ImagesTable = (Il2CppImage*)IL2CPP_CALLOC(s_ImagesCount, <span class="keyword">sizeof</span>(Il2CppImage));</span><br><span class="line">    s_AssembliesCount = s_GlobalMetadataHeader-&gt;assembliesCount / <span class="keyword">sizeof</span>(Il2CppAssemblyDefinition);</span><br><span class="line">    s_AssembliesTable = (Il2CppAssembly*)IL2CPP_CALLOC(s_AssembliesCount, <span class="keyword">sizeof</span>(Il2CppAssembly));</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>il2cpp::vm::MetadataLoader::LoadMetadataFile (located in vm/MetadataLoader.cpp):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>* il2cpp::vm::MetadataLoader::LoadMetadataFile(<span class="keyword">const</span> <span class="keyword">char</span>* fileName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> resourcesDirectory = utils::PathUtils::Combine(utils::Runtime::GetDataDir(), utils::StringView&lt;<span class="keyword">char</span>&gt;(<span class="string">&quot;Metadata&quot;</span>));</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> resourceFilePath = utils::PathUtils::Combine(resourcesDirectory, utils::StringView&lt;<span class="keyword">char</span>&gt;(fileName, <span class="built_in">strlen</span>(fileName)));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> error = <span class="number">0</span>;</span><br><span class="line">    os::FileHandle* handle = os::File::Open(resourceFilePath, kFileModeOpen, kFileAccessRead, kFileShareRead, kFileOptionsNone, &amp;error);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        utils::Logging::Write(<span class="string">&quot;ERROR: Could not open %s&quot;</span>, resourceFilePath.c_str());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">void</span>* fileBuffer = utils::MemoryMappedFile::Map(handle);</span><br><span class="line"> </span><br><span class="line">    os::File::Close(handle, &amp;error);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        utils::MemoryMappedFile::Unmap(fileBuffer);</span><br><span class="line">        fileBuffer = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> fileBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了这些源码，我们只需要在 IDA 中对照他们识别出相对应的函数，而关键是后两个函数，分别是</p>
<p>il2cpp::vm::MetadataLoader::LoadMetadataFile 该函数将 metadata 的文件名文件映射入内存</p>
<p>il2cpp::vm::MetadataCache::Initialize 该函数将映射文件的指针存储在全局变量中，然后开始从这变量读取数据结构</p>
<p>所然！解混淆或是解密代码一般都在这两个函数里，我们只需要样本代码与源码对比差别即可。</p>
<p>特别指出在引用文中的一个例子，现在看一个 IDA 中的例子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> il2cpp::vm::MetadataCache::<span class="built_in">Initialize</span>()</span><br><span class="line">&#123;</span><br><span class="line">  v0 = <span class="built_in">sub_180261550</span>(<span class="string">&quot;global-metadata.dat&quot;</span>);</span><br><span class="line">  *&amp;xmmword_182B7C2D8 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(&amp;xmmword_182B7C2D8 + <span class="number">1</span>) = v0;</span><br><span class="line">    qword_182B7B948 = <span class="built_in">j_j__calloc_base</span>(*(qword_182B7C2C0 + <span class="number">48</span>), <span class="number">8</span>i64);</span><br><span class="line">    qword_182B7B950 = <span class="built_in">j_j__calloc_base</span>(*(*(&amp;xmmword_182B7C2D8 + <span class="number">1</span>) + <span class="number">164</span>i64) / <span class="number">0x5C</span>ui64, <span class="number">8</span>i64);</span><br><span class="line">    qword_182B7B958 = <span class="built_in">j_j__calloc_base</span>(*(*(&amp;xmmword_182B7C2D8 + <span class="number">1</span>) + <span class="number">52</span>i64) &gt;&gt; <span class="number">5</span>, <span class="number">8</span>i64);</span><br><span class="line">    qword_182B7B968 = <span class="built_in">j_j__calloc_base</span>(*(qword_182B7C2C0 + <span class="number">64</span>), <span class="number">8</span>i64);</span><br><span class="line">    dword_182B7B970 = *(*(&amp;xmmword_182B7C2D8 + <span class="number">1</span>) + <span class="number">172</span>i64) / <span class="number">0x28</span>ui64;</span><br><span class="line">    qword_182B7B978 = <span class="built_in">j_j__calloc_base</span>(dword_182B7B970, <span class="number">80</span>i64);</span><br><span class="line">    dword_182B7B980 = *(*(&amp;xmmword_182B7C2D8 + <span class="number">1</span>) + <span class="number">180</span>i64) / <span class="number">0x44</span>ui64;</span><br><span class="line">    qword_182B7B988 = <span class="built_in">j_j__calloc_base</span>(dword_182B7B980, <span class="number">96</span>i64);</span><br><span class="line">    v1 = *(&amp;xmmword_182B7C2D8 + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>对比下源码不难发现 sub_180261550 就是 il2cpp::vm::MetadataLoader::LoadMetadataFromFile</p>
<p>需要注意的是这个 v0 指针十分重要，因为解混淆或是解密都会调用到这个指针（一般是在加载前解密，而不是在加载后解密，这样会导致未解密的数据残余在内存中影响性能），通常来说应用程序在访问 metadata 前执行解密，或是在 il2cpp: : vm: : MetadataLoader: : LoadMetadataFromFile 之前或之中。</p>
<h3 id="Finding-the-metadata-loader-What-if-there-is-no-il2cpp-init"><a href="#Finding-the-metadata-loader-What-if-there-is-no-il2cpp-init" class="headerlink" title="Finding the metadata loader: What if there is no il2cpp_init?"></a>Finding the metadata loader: What if there is no il2cpp_init?</h3><p>那么以上套路是针对我们能在 il2cpp 里找到 il2cpp_init 的函数，但是如果没有，我们就要继续往上找 UnityPlayer.dll 或者 libunity.so，而这个我们没有办法用源码对照，不过我们可以创建一个 Unity 项目生成 PDB，就可以看到名字和符号那些。</p>
<p>对于这种情况我们主要关心 il2cpp_init.cpp 到底是哪里被引用与调用，那么未被混淆的流程如此</p>
<p><img src="/2023/07/20/IL2CPP/untitled-drawing-3.png" alt="img"></p>
<p>UnityMainImpl 有很多函数调用，不过我们可以通过字符串来寻找</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  winutils::DisplayErrorMessagesAndQuit(<span class="string">&quot;Data folder not found&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">DetectIL2CPPVersion();</span><br><span class="line">v78.m_data = <span class="number">0</span>i64;</span><br><span class="line">v78.m_size = <span class="number">0</span>i64;</span><br><span class="line">v78.m_label.identifier = <span class="number">68</span>;</span><br><span class="line">v78.m_internal[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">core::StringStorageDefault&lt;<span class="keyword">char</span>&gt;::assign(&amp;v78, <span class="string">&quot;GameAssembly.dll&quot;</span>, <span class="number">0x10</span>ui64);</span><br><span class="line">v27 = !LoadIl2Cpp(&amp;v78);</span><br><span class="line"><span class="keyword">if</span> ( v78.m_data &amp;&amp; v78.m_capacity &gt; <span class="number">0</span> )</span><br><span class="line">  <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v78.m_data, v78.m_label)</span></span>;</span><br><span class="line"><span class="keyword">if</span> ( v27 )</span><br><span class="line">  winutils::DisplayErrorMessagesAndQuit(<span class="string">&quot;Failed to load il2cpp&quot;</span>);</span><br><span class="line">v78.m_data = <span class="number">0</span>i64;</span><br><span class="line">v78.m_size = <span class="number">0</span>i64;</span><br><span class="line">v78.m_label.identifier = <span class="number">68</span>;</span><br><span class="line">v78.m_internal[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">core::StringStorageDefault&lt;<span class="keyword">char</span>&gt;::assign(&amp;v78, <span class="string">&quot;il2cpp_data&quot;</span>, <span class="number">0xB</span>ui64);</span><br></pre></td></tr></table></figure>

<p>LoadIl2Cpp 也同样可以字符串快速寻找</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">v2 = <span class="number">1</span>;</span><br><span class="line"> il2cpp_init = LookupSymbol(v1, <span class="string">&quot;il2cpp_init&quot;</span>, kSymbolRequired);</span><br><span class="line"> <span class="keyword">if</span> ( !il2cpp_init )</span><br><span class="line"> &#123;</span><br><span class="line">   v2 = <span class="number">0</span>;</span><br><span class="line">   printf_console(<span class="string">&quot;il2cpp: function il2cpp_init not found\n&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> il2cpp_init_utf16 = LookupSymbol(gIl2CppModule, <span class="string">&quot;il2cpp_init_utf16&quot;</span>, kSymbolRequired);</span><br><span class="line"> <span class="keyword">if</span> ( !il2cpp_init_utf16 )</span><br><span class="line"> &#123;</span><br><span class="line">   v2 = <span class="number">0</span>;</span><br><span class="line">   printf_console(<span class="string">&quot;il2cpp: function il2cpp_init_utf16 not found\n&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> il2cpp_shutdown = LookupSymbol(gIl2CppModule, <span class="string">&quot;il2cpp_shutdown&quot;</span>, kSymbolRequired);</span><br><span class="line"> <span class="keyword">if</span> ( !il2cpp_shutdown )</span><br><span class="line"> &#123;</span><br><span class="line">   v2 = <span class="number">0</span>;</span><br><span class="line">   printf_console(<span class="string">&quot;il2cpp: function il2cpp_shutdown not found\n&quot;</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>InitializeIl2CppFromMain</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> __fastcall <span class="title">InitializeIl2CppFromMain</span><span class="params">(<span class="keyword">const</span> core::basic_string&lt;<span class="keyword">char</span>,core::StringStorageDefault&lt;<span class="keyword">char</span>&gt; &gt; *monoConfigPath, <span class="keyword">const</span> core::basic_string&lt;<span class="keyword">char</span>,core::StringStorageDefault&lt;<span class="keyword">char</span>&gt; &gt; *dataPath, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v4 = argv;</span><br><span class="line">  v5 = argc;</span><br><span class="line">  v6 = dataPath;</span><br><span class="line">  v7 = monoConfigPath;</span><br><span class="line">  RegisterAllInternalCalls();</span><br><span class="line">  il2cpp_runtime_unhandled_exception_policy_set(IL2CPP_UNHANDLED_POLICY_LEGACY);</span><br><span class="line">  il2cpp_set_commandline_arguments(v5, v4, <span class="number">0</span>i64);</span><br><span class="line">  v8 = v7-&gt;m_data;</span><br><span class="line">  <span class="keyword">if</span> ( !v7-&gt;m_data )</span><br><span class="line">    v8 = &amp;v7-&gt;<span class="number">8</span>;</span><br><span class="line">  il2cpp_set_config_dir(v8);</span><br><span class="line">  v9 = v6-&gt;m_data;</span><br><span class="line">  <span class="keyword">if</span> ( !v6-&gt;m_data )</span><br><span class="line">    v9 = &amp;v6-&gt;<span class="number">8</span>;</span><br><span class="line">  il2cpp_set_data_dir(v9);</span><br><span class="line">  v10 = GetMonoDebuggerAgentOptions(&amp;result, <span class="number">0</span>);</span><br><span class="line">  v11 = v10-&gt;m_data;</span><br><span class="line">  <span class="keyword">if</span> ( !v10-&gt;m_data )</span><br><span class="line">    v11 = &amp;v10-&gt;<span class="number">8</span>;</span><br><span class="line">  il2cpp_debugger_set_agent_options(v11);</span><br><span class="line">  <span class="keyword">if</span> ( result.m_data &amp;&amp; result.m_capacity )</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(result.m_data, result.m_label)</span></span>;</span><br><span class="line">  il2cpp_init(<span class="string">&quot;IL2CPP Root Domain&quot;</span>);</span><br><span class="line">  il2cpp_set_config(<span class="string">&quot;unused_application_configuration&quot;</span>);</span><br><span class="line">  profiling::ScriptingProfiler::Initialize();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而有相当不同的变化在不同的版本中，他们的共同特点是对 il2cpp_init 的调用和 IL2CPP Root Domain 与 unused_application_configuration，所以通过这些我们也同样快速找到（如果没有混淆的话）。</p>
<h2 id="D3Mug"><a href="#D3Mug" class="headerlink" title="D3Mug"></a>D3Mug</h2><h3 id="0x00-Daily-Check-Shell"><a href="#0x00-Daily-Check-Shell" class="headerlink" title="0x00 Daily Check Shell"></a>0x00 Daily Check Shell</h3><p>IL2CPP逆向，无壳。</p>
<p>于是惯用套路查找 libil2cpp.so 和 global-metadata.dat 来恢复符号，metadata未被混淆，所以可以直接恢复。</p>
<p>接着可以配合 Assembly-CSharp.dll 或 dump.cs 来配合查看函数信息。</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709092933125.png" alt="image-20230709092933125"></p>
<h3 id="0x01-Track"><a href="#0x01-Track" class="headerlink" title="0x01 Track"></a>0x01 Track</h3><p>尝试 hook IL2CPP 的函数，可是都不行，看别人博客都是模拟器跳这个，我真机跳这个是为什么，hook 未果</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709145533094.png" alt="image-20230709145533094"></p>
<p>那么开始静态审计，既然是音游，通关调试肯定是全部按好即可，于是在 Assembly-CSharp.dll 很容易定位到 notehit notemiss 这些函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">GameManager__NoteHit</span><span class="params">(GameManager_o *<span class="keyword">this</span>, <span class="keyword">float</span> preciseTime, <span class="keyword">int32_t</span> level, <span class="keyword">const</span> MethodInfo *method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">TMPro_TMP_Text_o</span> *<span class="title">PerfectText</span>;</span> <span class="comment">// x19</span></span><br><span class="line">  System_String_o *v6; <span class="comment">// x0</span></span><br><span class="line">  System_String_o *v7; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">const</span> MethodInfo *v8; <span class="comment">// x1</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v9; <span class="comment">// w0</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [xsp+Ch] [xbp-14h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( level &gt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    PerfectText = <span class="keyword">this</span>-&gt;fields.PerfectText;</span><br><span class="line">    <span class="keyword">if</span> ( PerfectText )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">LABEL_8:</span><br><span class="line">    sub_560668();</span><br><span class="line">  &#125;</span><br><span class="line">  PerfectText = <span class="keyword">this</span>-&gt;fields.GoodText;</span><br><span class="line">  <span class="keyword">if</span> ( !PerfectText )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">LABEL_3:</span><br><span class="line">  v6 = (PerfectText-&gt;klass-&gt;vtable._65_get_text.method)(</span><br><span class="line">         PerfectText,</span><br><span class="line">         PerfectText-&gt;klass-&gt;vtable._66_set_text.methodPtr,</span><br><span class="line">         method);</span><br><span class="line">  v10 = System_Int32__Parse(v6, <span class="number">0LL</span>) + <span class="number">1</span>;</span><br><span class="line">  v7 = System_Int32__ToString(&amp;v10, <span class="number">0LL</span>);</span><br><span class="line">  (PerfectText-&gt;klass-&gt;vtable._66_set_text.method)(</span><br><span class="line">    PerfectText,</span><br><span class="line">    v7,</span><br><span class="line">    PerfectText-&gt;klass-&gt;vtable._67_get_fontSharedMaterial.methodPtr);</span><br><span class="line">  <span class="keyword">if</span> ( (preciseTime * <span class="number">1000.0</span>) &gt;= <span class="number">0.0</span> )</span><br><span class="line">    v9 = (preciseTime * <span class="number">1000.0</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v9 = (preciseTime * <span class="number">1000.0</span>);</span><br><span class="line">  GameManager__update(v9, v8);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>共同点就是算好分数，就直接调用 GameManager__update，而该函数往里查找可以发现调用了 d3mug.so 文件里的 update 函数</p>
<p>那么可以得出结论每次点击到 preciseTime 就会正确 update，而该 update 函数会把值更新到 Server:instance 里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">update</span><span class="params">(<span class="keyword">char</span> note_bit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// x8</span></span><br><span class="line">  __int64 enc; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// x10</span></span><br><span class="line">  __int64 v5; <span class="comment">// x9</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// x10</span></span><br><span class="line">  __int64 v7; <span class="comment">// x9</span></span><br><span class="line"></span><br><span class="line">  v2 = Server::instance;</span><br><span class="line">  <span class="keyword">if</span> ( !Server::instance )</span><br><span class="line">  &#123;</span><br><span class="line">    enc = <span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">0x13B0</span>uLL);</span><br><span class="line">    v2 = enc;</span><br><span class="line">    v4 = <span class="number">0x1571</span>LL;</span><br><span class="line">    v5 = <span class="number">6LL</span>;</span><br><span class="line">    *(enc + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">    *enc = *ENC;</span><br><span class="line">    *(enc + <span class="number">16</span>) = *&amp;ENC[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = v5 + <span class="number">0x6C078965</span> * ((v4 &gt;&gt; <span class="number">30</span>) ^ v4) - <span class="number">5</span>;</span><br><span class="line">      *(enc + <span class="number">8</span> * v5++) = v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v5 != <span class="number">629</span> );</span><br><span class="line">    v6 = <span class="number">0xF44EB78E</span>LL;</span><br><span class="line">    v7 = <span class="number">6LL</span>;</span><br><span class="line">    *(enc + <span class="number">40</span>) = <span class="number">0xF44EB78E</span>LL;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v7 + <span class="number">0x6C078965</span> * ((v6 &gt;&gt; <span class="number">30</span>) ^ v6) - <span class="number">5</span>;</span><br><span class="line">      *(enc + <span class="number">8</span> * v7++) = v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v7 != <span class="number">629</span> );</span><br><span class="line">    *(enc + <span class="number">5032</span>) = <span class="number">0LL</span>;</span><br><span class="line">    Server::instance = enc;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Server::run(v2, note_bit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而之后的分数结算的函数 ScoreScene__Start 只是检测了 Server::instance 前缀是否位 D3CTF</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709153136124.png" alt="image-20230709153136124"></p>
<p>那么怎么点才是 preciseTime 呢，而音游落下的方法并不是随即的，而是固定的，所以我们可以找一下加载这个数据的地方</p>
<p>既然有符号，看到可疑的直接看即可，于是发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall BeatScroller__ParseBeatTampoMap(</span><br><span class="line">        BeatScroller_o *this,</span><br><span class="line">        System_String_o *map_data,</span><br><span class="line">        System_String_o *hit_data,</span><br><span class="line">        const MethodInfo *method)</span><br></pre></td></tr></table></figure>

<p>往上找，于是发现加载路径</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709153507209.png" alt="image-20230709153507209"></p>
<p>于是利用 AssetStudio 来提取数据</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709153806209.png" alt="image-20230709153806209"></p>
<p>于是我们大概审一下生成地图的函数，可知后面那个就是我们要的 preciseTime</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">BeatScroller__GenerateNote</span><span class="params">(BeatScroller_o *<span class="keyword">this</span>, System_String_o *hit_data, <span class="keyword">const</span> MethodInfo *method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v5; <span class="comment">// x1</span></span><br><span class="line">  __int64 v6; <span class="comment">// x1</span></span><br><span class="line">  UnityEngine_Transform_o *transform; <span class="comment">// x0</span></span><br><span class="line">  UnityEngine_Transform_o *v8; <span class="comment">// x21</span></span><br><span class="line">  UnityEngine_Transform_o *v9; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// s0</span></span><br><span class="line">  __int64 v13; <span class="comment">// x1</span></span><br><span class="line">  UnityEngine_Transform_o *v14; <span class="comment">// x21</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">UnityEngine_Vector3_StaticFields</span> *<span class="title">static_fields</span>;</span> <span class="comment">// x8</span></span><br><span class="line">  System_String_array *split_hit_data; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">int</span> max_length; <span class="comment">// w8</span></span><br><span class="line">  System_String_array *split_hit_data1; <span class="comment">// x20</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v19; <span class="comment">// w24</span></span><br><span class="line">  System_String_o *v20; <span class="comment">// x0</span></span><br><span class="line">  System_String_array *v21; <span class="comment">// x0</span></span><br><span class="line">  System_String_array *v22; <span class="comment">// x22</span></span><br><span class="line">  <span class="keyword">int32_t</span> v23; <span class="comment">// w0</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// w21</span></span><br><span class="line">  <span class="keyword">float</span> last; <span class="comment">// s0</span></span><br><span class="line">  Il2CppObject *PrefabNote; <span class="comment">// x22</span></span><br><span class="line">  <span class="keyword">float</span> last1; <span class="comment">// s8</span></span><br><span class="line">  Il2CppObject *v28; <span class="comment">// x0</span></span><br><span class="line">  UnityEngine_GameObject_o *v29; <span class="comment">// x22</span></span><br><span class="line">  UnityEngine_Transform_o *v30; <span class="comment">// x23</span></span><br><span class="line">  UnityEngine_Transform_o *v31; <span class="comment">// x0</span></span><br><span class="line">  UnityEngine_Transform_o *v32; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">float</span> cameraXSize; <span class="comment">// s11</span></span><br><span class="line">  <span class="keyword">float</span> OriginBeatTampo_k__BackingField; <span class="comment">// s12</span></span><br><span class="line">  UnityEngine_Transform_o *v35; <span class="comment">// x23</span></span><br><span class="line">  UnityEngine_Transform_o *v36; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">int</span> v37; <span class="comment">// s2</span></span><br><span class="line">  <span class="keyword">float</span> last1_div_1000; <span class="comment">// s8</span></span><br><span class="line">  <span class="keyword">float</span> v39; <span class="comment">// s1</span></span><br><span class="line">  <span class="keyword">float</span> v40; <span class="comment">// s0</span></span><br><span class="line">  Il2CppObject *Component_object; <span class="comment">// x0</span></span><br><span class="line">  UnityEngine_Vector3_o v42; <span class="comment">// 0:s0.4,4:s1.4,8:s2.4</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (byte_198F173 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_56055C(&amp;Method_UnityEngine_GameObject_GetComponent_NoteObject___, hit_data);</span><br><span class="line">    sub_56055C(&amp;Method_UnityEngine_Object_Instantiate_GameObject___, v5);</span><br><span class="line">    sub_56055C(&amp;UnityEngine_Object_TypeInfo, v6);</span><br><span class="line">    byte_198F173 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  transform = UnityEngine_Component__get_transform(<span class="keyword">this</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="keyword">this</span>-&gt;fields.Line )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  v8 = transform;</span><br><span class="line">  v9 = UnityEngine_GameObject__get_transform(<span class="keyword">this</span>-&gt;fields.Line, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  *&amp;v10 = UnityEngine_Transform__get_position(v9, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v8 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  UnityEngine_Transform__set_position(v8, *&amp;v10, <span class="number">0LL</span>);</span><br><span class="line">  v14 = UnityEngine_Component__get_transform(<span class="keyword">this</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !byte_198F1BC )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_56055C(&amp;UnityEngine_Vector3_TypeInfo, v13);</span><br><span class="line">    byte_198F1BC = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v14 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  static_fields = UnityEngine_Vector3_TypeInfo-&gt;static_fields;</span><br><span class="line">  v42.fields.x = static_fields-&gt;backVector.fields.x + static_fields-&gt;backVector.fields.x;</span><br><span class="line">  v42.fields.y = static_fields-&gt;backVector.fields.y + static_fields-&gt;backVector.fields.y;</span><br><span class="line">  v42.fields.z = static_fields-&gt;backVector.fields.z + static_fields-&gt;backVector.fields.z;</span><br><span class="line">  UnityEngine_Transform__Translate_16881896(v14, v42, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !hit_data )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  split_hit_data = System_String__Split(hit_data, <span class="number">0xA</span>u, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !split_hit_data )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">  max_length = split_hit_data-&gt;max_length;</span><br><span class="line">  split_hit_data1 = split_hit_data;</span><br><span class="line">  <span class="keyword">if</span> ( max_length &gt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v19 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v19 &gt;= max_length )</span><br><span class="line">LABEL_28:</span><br><span class="line">        sub_560670();</span><br><span class="line">      v20 = split_hit_data1-&gt;m_Items[v19];</span><br><span class="line">      <span class="keyword">if</span> ( !v20 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v21 = System_String__Split(v20, <span class="number">0x2C</span>u, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v21 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v22 = v21;</span><br><span class="line">      <span class="keyword">if</span> ( !v21-&gt;max_length )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">      v23 = System_Int32__Parse(v21-&gt;m_Items[<span class="number">0</span>], <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v22-&gt;max_length &lt;= <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">      v24 = v23;</span><br><span class="line">      last = System_Single__Parse(v22-&gt;m_Items[<span class="number">1</span>], <span class="number">0LL</span>);</span><br><span class="line">      PrefabNote = <span class="keyword">this</span>-&gt;fields.PrefabNote;</span><br><span class="line">      last1 = last;</span><br><span class="line">      <span class="keyword">if</span> ( !UnityEngine_Object_TypeInfo-&gt;_2.cctor_finished )</span><br><span class="line">        j_il2cpp_runtime_class_init_0(UnityEngine_Object_TypeInfo);</span><br><span class="line">      v28 = UnityEngine_Object__Instantiate_object_(PrefabNote, Method_UnityEngine_Object_Instantiate_GameObject___);</span><br><span class="line">      <span class="keyword">if</span> ( !v28 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v29 = v28;</span><br><span class="line">      v30 = UnityEngine_GameObject__get_transform(v28, <span class="number">0LL</span>);</span><br><span class="line">      v31 = UnityEngine_Component__get_transform(<span class="keyword">this</span>, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v30 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      UnityEngine_Transform__set_parent(v30, v31, <span class="number">0LL</span>);</span><br><span class="line">      v32 = UnityEngine_GameObject__get_transform(v29, <span class="number">0LL</span>);</span><br><span class="line">      cameraXSize = <span class="keyword">this</span>-&gt;fields.cameraXSize;</span><br><span class="line">      OriginBeatTampo_k__BackingField = <span class="keyword">this</span>-&gt;fields._OriginBeatTampo_k__BackingField;</span><br><span class="line">      v35 = v32;</span><br><span class="line">      v36 = UnityEngine_Component__get_transform(<span class="keyword">this</span>, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v36 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      *(&amp;v37 - <span class="number">2</span>) = UnityEngine_Transform__get_position(v36, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v35 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      last1_div_1000 = last1 / <span class="number">1000.0</span>;</span><br><span class="line">      v39 = last1_div_1000 * OriginBeatTampo_k__BackingField;</span><br><span class="line">      v40 = ((cameraXSize / <span class="number">5.0</span>) * v24) + (cameraXSize * <span class="number">-0.5</span>);</span><br><span class="line">      UnityEngine_Transform__set_position(v35, *(&amp;v37 - <span class="number">2</span>), <span class="number">0LL</span>);</span><br><span class="line">      Component_object = UnityEngine_GameObject__GetComponent_object_(</span><br><span class="line">                           v29,</span><br><span class="line">                           Method_UnityEngine_GameObject_GetComponent_NoteObject___);</span><br><span class="line">      <span class="keyword">if</span> ( !Component_object )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      *(&amp;Component_object[<span class="number">1</span>].monitor + <span class="number">1</span>) = last1_div_1000;</span><br><span class="line">      max_length = split_hit_data1-&gt;max_length;</span><br><span class="line">      <span class="keyword">if</span> ( ++v19 &gt;= max_length )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_27:</span><br><span class="line">    sub_560668();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="0x02-Get-Flag"><a href="#0x02-Get-Flag" class="headerlink" title="0x02 Get Flag"></a>0x02 Get Flag</h3><p>于是总结一下</p>
<ol>
<li>程序只有一个界面入口，也就是只有这一个地图，于是我们拿到 preciseTime 的数据</li>
<li>随后程序检测我们的 notehit 是否和 preciseTime 吻合</li>
<li>最后在 ScoreScene__Start 做了个检测是否正确解密为 D3CTF</li>
</ol>
<p>所以其中一个解密思路就是我们主动调用每次 notehit 会调用的 update 函数，将 preciseTime 数据传入，最后再读取一下解密完的数据即可</p>
<p>于是用下 Frida 即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> soBase = Module.findBaseAddress(<span class="string">&quot;libd3mug.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = <span class="keyword">new</span> NativeFunction(soBase.add(<span class="number">0x0000780</span>), <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;char&quot;</span>]);</span><br><span class="line">    <span class="keyword">const</span> instance = soBase.add(<span class="number">0x02D18</span>); </span><br><span class="line"></span><br><span class="line">    instance.writePointer(<span class="keyword">new</span> NativePointer(<span class="number">0</span>)); </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> t <span class="keyword">of</span> hitpoints) &#123;</span><br><span class="line">        update(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(instance.readPointer().readCString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">session = device.attach(<span class="number">2327</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;hook.js&quot;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span>()</span><br></pre></td></tr></table></figure>

<p>Get Flag!</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709163140635.png" alt="image-20230709163140635"></p>
<h2 id="BabyUnity3d"><a href="#BabyUnity3d" class="headerlink" title="BabyUnity3d"></a>BabyUnity3d</h2><h3 id="0x00-Daily-Check-Shell-1"><a href="#0x00-Daily-Check-Shell-1" class="headerlink" title="0x00 Daily Check Shell"></a>0x00 Daily Check Shell</h3><p>IL2CPP逆向，无壳。</p>
<p>但是这次 metadata 混淆了，可以发现一开始的魔术字的不是原来的样子了，于是两个思路</p>
<p>第一就是运行后内存中直接搜索魔术字</p>
<p>第二就是本文刚开始写的，对比源代码找加载 metadata 的部分既然加密了，在那也许就能找到解密的地方</p>
<h3 id="0x01-Deobfuscate-metadata"><a href="#0x01-Deobfuscate-metadata" class="headerlink" title="0x01 Deobfuscate metadata"></a>0x01 Deobfuscate metadata</h3><p>而该题没法直接在内存中直接搜索到原本的魔术字，于是采用第二种方法，再回忆下调用链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">il2cpp_init</span><br><span class="line">  -&gt; il2cpp::vm::Runtime::Init</span><br><span class="line">    -&gt; il2cpp::vm::MetadataCache::Initialize</span><br><span class="line">      -&gt; il2cpp::vm::MetadataLoader::LoadMetadataFile</span><br></pre></td></tr></table></figure>

<p>于是直接搜 init 即可找到 il2cpp::vm::Runtime::Init</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709164756647.png" alt="image-20230709164756647"></p>
<p>随后进入该函数后一个个查找对比源码可以发现 sub_4B5564 为 il2cpp::vm::MetadataCache::Initialize</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709165212395.png" alt="image-20230709165212395"></p>
<p>那么看该函数可以很明显发现，global-metadata.dat 字符串变成了其他字符串，但程序运行 sub_4B5518 会自动解密回去</p>
<p>于是对应着源码 sub_513060 就是 il2cpp::vm::MetadataLoader::LoadMetadataFile，返回一个指针完全吻合</p>
<p>那么解密的 metadata 的地方就只可能是 LoadMetadataFile 该函数了，于是将该函数与原函数对比说实话看不太出来到底哪里变了，当然我们也可以一个个点进去看看哪个比较可疑，当然还有个方法找个没被混淆的对比即可，如图</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709171050120.png" alt="image-20230709171050120"></p>
<p>很明显 sub_512FDC 就是不一样的地方（刚刚调试了一下这几个符号全恢复了？？是巧合吗）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">sub_C409CFDC</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">size_t</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *result; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">size_t</span> v5; <span class="comment">// r2</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(a2);</span><br><span class="line">  <span class="keyword">if</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)&amp;result[v5 &amp; <span class="number">0xFFFFFFFC</span>] = *(_DWORD *)(a1 + (v5 &amp; <span class="number">0xFFFFFFFC</span>)) ^ dword_C4166F6C[(v5 + v5 / <span class="number">0x84</span>) % <span class="number">0x84</span>];</span><br><span class="line">      v5 += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v5 &lt; a2 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写出解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;global-metadata.dat&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">a = <span class="string">&quot;&quot;</span></span><br><span class="line">a = f.read()</span><br><span class="line">key = [<span class="number">0xF83DA249</span>, <span class="number">0x15D12772</span>, <span class="number">0x40C50697</span>, <span class="number">0x984E2B6B</span>, <span class="number">0x14EC5FF8</span>, <span class="number">0xB2E24927</span>,</span><br><span class="line">       <span class="number">0x3B8F77AE</span>, <span class="number">0x472474CD</span>, <span class="number">0x5B0CE524</span>, <span class="number">0xA17E1A31</span>, <span class="number">0x6C60852C</span>, <span class="number">0xD86AD267</span>, <span class="number">0x832612B7</span>, <span class="number">0x1CA03645</span>, <span class="number">0x5515ABC8</span>,</span><br><span class="line">       <span class="number">0xC5FEFF52</span>, <span class="number">0xFFFFAC00</span>, <span class="number">0x0FE95CB6</span>, <span class="number">0x79CF43DD</span>, <span class="number">0xAA48A3FB</span>, <span class="number">0xE1D71788</span>, <span class="number">0x97663D3A</span>, <span class="number">0xF5CFFEA7</span>, <span class="number">0xEE617632</span>,</span><br><span class="line">       <span class="number">0x4B11A7EE</span>, <span class="number">0x040EF0B5</span>, <span class="number">0x0606FC00</span>, <span class="number">0xC1530FAE</span>, <span class="number">0x7A827441</span>, <span class="number">0xFCE91D44</span>, <span class="number">0x8C4CC1B1</span>, <span class="number">0x7294C28D</span>, <span class="number">0x8D976162</span>,</span><br><span class="line">       <span class="number">0x8315435A</span>, <span class="number">0x3917A408</span>, <span class="number">0xAF7F1327</span>, <span class="number">0xD4BFAED7</span>, <span class="number">0x80D0ABFC</span>, <span class="number">0x63923DC3</span>, <span class="number">0xB0E6B35A</span>, <span class="number">0xB815088F</span>, <span class="number">0x9BACF123</span>,</span><br><span class="line">       <span class="number">0xE32411C3</span>, <span class="number">0xA026100B</span>, <span class="number">0xBCF2FF58</span>, <span class="number">0x641C5CFC</span>, <span class="number">0xC4A2D7DC</span>, <span class="number">0x99E05DCA</span>, <span class="number">0x9DC699F7</span>, <span class="number">0xB76A8621</span>, <span class="number">0x8E40E03C</span>,</span><br><span class="line">       <span class="number">0x28F3C2D4</span>, <span class="number">0x40F91223</span>, <span class="number">0x67A952E0</span>, <span class="number">0x505F3621</span>, <span class="number">0xBAF13D33</span>, <span class="number">0xA75B61CC</span>, <span class="number">0xAB6AEF54</span>, <span class="number">0xC4DFB60D</span>, <span class="number">0xD29D873A</span>,</span><br><span class="line">       <span class="number">0x57A77146</span>, <span class="number">0x393F86B8</span>, <span class="number">0x2A734A54</span>, <span class="number">0x31A56AF6</span>, <span class="number">0x0C5D9160</span>, <span class="number">0xAF83A19A</span>, <span class="number">0x7FC9B41F</span>, <span class="number">0xD079EF47</span>, <span class="number">0xE3295281</span>,</span><br><span class="line">       <span class="number">0x5602E3E5</span>, <span class="number">0xAB915E69</span>, <span class="number">0x225A1992</span>, <span class="number">0xA387F6B2</span>, <span class="number">0x7E981613</span>, <span class="number">0xFC6CF59A</span>, <span class="number">0xD34A7378</span>, <span class="number">0xB608B7D6</span>, <span class="number">0xA9EB93D9</span>,</span><br><span class="line">       <span class="number">0x26DDB218</span>, <span class="number">0x65F33F5F</span>, <span class="number">0xF9314442</span>, <span class="number">0x5D5C0599</span>, <span class="number">0xEA72E774</span>, <span class="number">0x1605A502</span>, <span class="number">0xEC6CBC9F</span>, <span class="number">0x7F8A1BD1</span>, <span class="number">0x4DD8CF07</span>,</span><br><span class="line">       <span class="number">0x2E6D79E0</span>, <span class="number">0x6990418F</span>, <span class="number">0xCF77BAD9</span>, <span class="number">0xD4FE0147</span>, <span class="number">0xFEF4A3E8</span>, <span class="number">0x85C45BDE</span>, <span class="number">0xB58F8E67</span>, <span class="number">0xA63EB8D7</span>, <span class="number">0xC69BD19B</span>,</span><br><span class="line">       <span class="number">0xDA442DCA</span>, <span class="number">0x3C0C1743</span>, <span class="number">0xE6F39D49</span>, <span class="number">0x33568804</span>, <span class="number">0x85EB6320</span>, <span class="number">0xDA223445</span>, <span class="number">0x36C4A941</span>, <span class="number">0xA9185589</span>, <span class="number">0x71B22D67</span>,</span><br><span class="line">       <span class="number">0xF59A2647</span>, <span class="number">0x3C8B583E</span>, <span class="number">0xD7717DED</span>, <span class="number">0xDF05699C</span>, <span class="number">0x4378367D</span>, <span class="number">0x1C459339</span>, <span class="number">0x85133B7F</span>, <span class="number">0x49800CE2</span>, <span class="number">0x3666CA0D</span>,</span><br><span class="line">       <span class="number">0xAF7AB504</span>, <span class="number">0x4FF5B8F1</span>, <span class="number">0xC23772E3</span>, <span class="number">0x3544F31E</span>, <span class="number">0x0F673A57</span>, <span class="number">0xF40600E1</span>, <span class="number">0x7E967417</span>, <span class="number">0x15A26203</span>, <span class="number">0x5F2E34CE</span>,</span><br><span class="line">       <span class="number">0x70C7921A</span>, <span class="number">0xD1C190DF</span>, <span class="number">0x5BB5DA6B</span>, <span class="number">0x60979C75</span>, <span class="number">0x4EA758A4</span>, <span class="number">0x078FE359</span>, <span class="number">0x1664639C</span>, <span class="number">0xAE14E73B</span>, <span class="number">0x2070FF03</span>]</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;decrypt&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="built_in">len</span>(a):</span><br><span class="line">        num = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, a[n:n + <span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        num = num ^ key[(n + n // <span class="number">0x84</span>) % <span class="number">0x84</span>]</span><br><span class="line">        d = struct.pack(<span class="string">&#x27;I&#x27;</span>, num)</span><br><span class="line">        fp.write(d)</span><br><span class="line">        n = n + <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>恢复了之后，魔术字还是不对，不过很明显是人为写上去的魔术字了，直接改回原来的魔术字即可</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709172536078.png" alt="image-20230709172536078"></p>
<h3 id="0x02-Get-Flag-1"><a href="#0x02-Get-Flag-1" class="headerlink" title="0x02 Get Flag"></a>0x02 Get Flag</h3><p>那么恢复了就很简单了，直接定位到关键函数</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709175040565.png" alt="image-20230709175040565"></p>
<p>发现只是个AES加密，密钥 IV直接交叉引用找赋值给 Check_TypeInfo 即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> __fastcall <span class="title">Check__CheckFlag</span><span class="params">(Check_o *<span class="keyword">this</span>, System_String_o *input, <span class="keyword">const</span> MethodInfo *method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Check_c *v4; <span class="comment">// r0</span></span><br><span class="line">  System_String_o *v5; <span class="comment">// r4</span></span><br><span class="line">  <span class="keyword">const</span> MethodInfo *v7; <span class="comment">// [sp+0h] [bp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !byte_C4226825 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_C40422BC(<span class="number">1279</span>);</span><br><span class="line">    byte_C4226825 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = Check_TypeInfo;</span><br><span class="line">  <span class="keyword">if</span> ( (Check_TypeInfo-&gt;_2.bitflags2 &amp; <span class="number">1</span>) != <span class="number">0</span> &amp;&amp; !Check_TypeInfo-&gt;_2.cctor_finished )</span><br><span class="line">  &#123;</span><br><span class="line">    il2cpp_runtime_class_init_0((<span class="keyword">int</span>)Check_TypeInfo);</span><br><span class="line">    v4 = Check_TypeInfo;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = Check__AESEncrypt(</span><br><span class="line">         (Il2CppObject *)v4-&gt;static_fields,</span><br><span class="line">         input,</span><br><span class="line">         v4-&gt;static_fields-&gt;AESKEY,</span><br><span class="line">         v4-&gt;static_fields-&gt;AES_IV591,</span><br><span class="line">         v7);</span><br><span class="line">  <span class="keyword">if</span> ( (string_TypeInfo-&gt;_2.bitflags2 &amp; <span class="number">1</span>) != <span class="number">0</span> &amp;&amp; !string_TypeInfo-&gt;_2.cctor_finished )</span><br><span class="line">    il2cpp_runtime_class_init_0((<span class="keyword">int</span>)string_TypeInfo);</span><br><span class="line">  <span class="keyword">return</span> System_String__op_Equality(<span class="number">0</span>, v5, (System_String_o *)StringLiteral_2814, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是搓一个解密脚本（cyberChef的AES是真不行啊）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span>(<span class="params">ciphertext, key</span>):</span></span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, <span class="string">b&#x27;58f3a445939aeb79&#x27;</span>)</span><br><span class="line">    ciphertext = base64.b64decode(ciphertext)</span><br><span class="line">    plaintext = unpad(cipher.decrypt(ciphertext), AES.block_size)</span><br><span class="line">    <span class="keyword">return</span> plaintext.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;91c775fa0f6a1cba&#x27;</span>  </span><br><span class="line">ciphertext = <span class="string">&#x27;w0ZyUZAHhn16/MRWie63lK+PuVpZObu/NpQ/E/ucplc=&#x27;</span> </span><br><span class="line"></span><br><span class="line">decrypted_text = aes_decrypt(ciphertext, key)</span><br><span class="line"><span class="built_in">print</span>(decrypted_text)</span><br></pre></td></tr></table></figure>

<p>Get Flag!</p>
<p><img src="/2023/07/20/IL2CPP/image-20230709175229791.png" alt="image-20230709175229791"></p>
<p><strong>Reference</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://katyscode.wordpress.com/2021/02/23/il2cpp-finding-obfuscated-global-metadata/">https://katyscode.wordpress.com/2021/02/23/il2cpp-finding-obfuscated-global-metadata/</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2216959">https://cloud.tencent.com/developer/article/2216959</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.shi1011.cn/ctf/2223">https://blog.shi1011.cn/ctf/2223</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/linxinfa/article/details/116572369">https://blog.csdn.net/linxinfa/article/details/116572369</a></p>
</blockquote>

    </div>

    <p style= "text-align:center">
        让我看看我被读了 
    <b><span id="/2023/07/20/IL2CPP/" class="waline-visitor-count"/>...</b> 次呢🎉</p>
    
    <div id = "frozen-btn" class = "center">
    <!-- <button class="green" onclick = "Change()">🎉☕一杯咖啡~</button> -->
    <button class="purple" onclick = "Change()">🍰</button>
    </div>
    
    <div class = "hide" id = "img">
        <div class="post-list">
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/AliPay.png" alt="DASCTF X SU">
                    <div class="center">
                        🍬
                    </div>
                </div>
            </article>
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/WeChat.png" alt="HFCTF2022">
                    <div class="center">
                        🍪
                    </div>
                </div>
            </article>
        </div>
    </div>
    <script>
            function Change()
            {
                var img = document.getElementById("img");
                if(img.className == "hide")
                {
                    img.className="";
                }
                else
                {
                    img.className="hide";
                }
            }
    </script>

    <div class="about">
        <h1>About this Post</h1>
        <p>This post is written by P.Z, licensed under <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>
    <!-- 
        
     -->
<div class="container">
<!-- <div id="waline"></div>
  <script>
    Waline({
      el: '#waline',
      serverURL: 'https://blog-api-pozeep.vercel.app/',  
      visitor: true,
      emoji: [   //这里加了一些表情 
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba',
      ],
       avatar: 'robohash',   //自定义默认头像为随机的机器人
       placeholder: '🍟🍰🧊🍔🍓🍫🍦🍗🍇🍉🍑🥐🍕',   //占位符
    });
  </script>
</div> -->

<!-- <span id="/2023/07/20/IL2CPP/" class="leancloud_visitors" data-flag-title="IL2CPP">
    <em class="post-meta-item-text">阅读量 </em>
    <i class="waline-visitor-count"></i>
</span> -->

</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Home</a>
                
                <a href="/Diary/Diary.html" class="item">Diary</a>
                
                <a href="/Friends/Friends.html" class="item">Friends</a>
                
                <a href="/CTF/CTF.html" class="item">CTF</a>
                
                <a href="/Book/Book.html" class="item">Book</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/PoZeep" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/39892350" class="item">BiliBili</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 P.Z<br >Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
        
    <span id="sitetime" style="text-align: center;display:block;"></span>


</footer>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 12, 27, 12, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "我已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了*/
    siteTime();
</script>

<!-- 在线通讯Tidio -->

<script src="//code.tidio.co/zmdcv08a6racnaer2so7xybdwby41fsa.js"></script>



        
<script src="/js/main.js"></script>

        
    </body>
</html>