<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>WMCTF2023 REVERSE - P.Z&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

    <script src='//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'></script>

<meta name="generator" content="Hexo 6.0.0"></head>

<!-- //unpkg.com/@waline/client -->
<!--  -->
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">P.Z&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/Diary/Diary">Diary</a>
            
            
            
            <a class="nav-item" href="/Friends/Friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Book/Book">Book</a>
            
            
            
            <a class="nav-item" href="/Sundry/Sundry">Sundry</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/PoZeep" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://space.bilibili.com/39892350" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            
            <span>August</span>
            
            
            
            
            
            <span>26,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">WMCTF2023 REVERSE</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="ezAndroid"><a href="#ezAndroid" class="headerlink" title="ezAndroid"></a>ezAndroid</h1><h2 id="0x00-Daily-Shell-Check"><a href="#0x00-Daily-Shell-Check" class="headerlink" title="0x00 Daily Shell Check"></a>0x00 Daily Shell Check</h2><p>无壳安卓逆向</p>
<h2 id="0x01-Java层"><a href="#0x01-Java层" class="headerlink" title="0x01 Java层"></a>0x01 Java层</h2><p>找到主活动，逻辑比较简单，就是对我们的用户名和密码分别进行 check1 和 check2，这两个函数是 native 层的，所以转到 so 层</p>
<p><img src="/WMCTF2023-REVERSE/image-20230826142540764.png" alt="image-20230826142540764"></p>
<h2 id="0x02-So-层"><a href="#0x02-So-层" class="headerlink" title="0x02 So 层"></a>0x02 So 层</h2><h3 id="Anti-Frida"><a href="#Anti-Frida" class="headerlink" title="Anti Frida"></a>Anti Frida</h3><p>在 so 层里搜这两个函数，发现没搜到，所以猜测是动态注册的，于是我们尝试打印出所有动态注册的 native 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_RegisterNatives</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _symbols = Process.getModuleByName(<span class="string">&#x27;libart.so&#x27;</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">var</span> RegisterNativesAddr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _symbols.length; i++ ) &#123;</span><br><span class="line">      <span class="keyword">var</span> _symbol = _symbols[i];</span><br><span class="line">      <span class="keyword">if</span> (_symbol.name.indexOf(<span class="string">&quot;RegisterNatives&quot;</span>) != -<span class="number">1</span> &amp;&amp; _symbol.name.indexOf(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span>)&#123;</span><br><span class="line">        RegisterNativesAddr = _symbol.address;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    Interceptor.attach(RegisterNativesAddr, &#123;</span><br><span class="line">      <span class="attr">onEnter</span>:<span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Attach success!&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> env = Java.vm.tryGetEnv();</span><br><span class="line">        <span class="keyword">var</span> className = env.getClassName(args[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> methodCount = args[<span class="number">3</span>].toInt32();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</span><br><span class="line">          <span class="keyword">var</span> methodName = args[<span class="number">2</span>].add(Process.pointerSize * <span class="number">3</span> * i).readPointer().readCString();</span><br><span class="line">          <span class="keyword">var</span> signature = args[<span class="number">2</span>].add(Process.pointerSize * <span class="number">3</span> * i).add(Process.pointerSize).readPointer().readCString();</span><br><span class="line">          <span class="keyword">var</span> fnPtr = args[<span class="number">2</span>].add(Process.pointerSize * <span class="number">3</span> * i).add(Process.pointerSize * <span class="number">2</span>).readPointer();</span><br><span class="line">          <span class="keyword">var</span> <span class="built_in">module</span> = Process.findModuleByAddress(fnPtr);</span><br><span class="line">          <span class="built_in">console</span>.log(className, methodName, signature, fnPtr, <span class="built_in">module</span>.name, fnPtr.sub(<span class="built_in">module</span>.base));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而 frida 直接闪退了，可以猜到可以 frida 反调试，检查 init 段发现该函数中 pthread_create 启了个子线程</p>
<p><img src="/WMCTF2023-REVERSE/image-20230826150901977.png" alt="image-20230826150901977"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_3538</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> newthread[<span class="number">2</span>]; <span class="comment">// [xsp+20h] [xbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  newthread[<span class="number">1</span>] = *(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  <span class="keyword">return</span> pthread_create(newthread, <span class="number">0LL</span>, sub_34C8, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是我们去 hook 该启动线程的函数，将用于反调试函数的线程取消</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_AntiFrida_func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    Interceptor.attach(pthread_create_addr, &#123;</span><br><span class="line">        <span class="function"><span class="title">onEnter</span>(<span class="params">args</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> func_addr = args[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">if</span> (args[<span class="number">3</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                Interceptor.replace(func_addr, <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Replace antiFrida success!&quot;</span>);</span><br><span class="line">                &#125;, <span class="string">&#x27;void&#x27;</span>, []))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后再以 spawn 方式启动来挂钩得到回显，得知注册了这两个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] Replace antiFrida success!</span><br><span class="line">Attach success!</span><br><span class="line">com.wmctf.ezandroid.MainActivity CheckUsername (Ljava/lang/String;)I 0x75c420e5a4 libezandroid.so 0x35a4</span><br><span class="line">com.wmctf.ezandroid.MainActivity check2 (Ljava/lang/String;)I 0x75c420ef0c libezandroid.so 0x3f0c</span><br></pre></td></tr></table></figure>



<h3 id="sub-35A4"><a href="#sub-35A4" class="headerlink" title="sub_35A4"></a>sub_35A4</h3><p>经过了 OLLVM 的混淆，开启 D810 会稍微好看一点，不过稍微浏览也能很快定位到这里的数据比较，而这里的数据在</p>
<p><img src="/WMCTF2023-REVERSE/image-20230826151434860.png" alt="image-20230826151434860"></p>
<p>不难猜测应该是我们的输入经过了 6C2C 函数后与该数据进行比较，于是查看 6C2C 函数，可以发现就是 RC4 函数，经过唯一经过的改变就是多明文多异或了个下标</p>
<p><img src="/WMCTF2023-REVERSE/image-20230826151603813.png" alt="image-20230826151603813"></p>
<p>于是去取到密文与密钥即可解密，密文直接按X比较的数据发现是在 init 段初始化了，而密钥可以通过 frida 直接 hook 该函数进行打印</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_sub_6C2C</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = Module.findBaseAddress(<span class="string">&quot;libezandroid.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> sub_6C2C = soAddr.add(<span class="number">0x6C2C</span>);</span><br><span class="line">    Interceptor.attach(sub_6C2C, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] sub_6C2C called!&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg0: &quot;</span> + args[<span class="number">0</span>].readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg1: &quot;</span> + args[<span class="number">1</span>].readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg2: &quot;</span> + args[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg3: &quot;</span> + args[<span class="number">3</span>].readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg4: &quot;</span> + args[<span class="number">4</span>]);</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入十位用户名得到结果，12345678 就是我们的密钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] sub_6C2C called!</span><br><span class="line">arg0: 1231231231</span><br><span class="line">arg1:</span><br><span class="line">arg2: 0xa       </span><br><span class="line">arg3: 12345678</span><br><span class="line">arg4: 0x8</span><br></pre></td></tr></table></figure>

<p>于是 RC4 解密再异或下标得到用户名 Re_1s_eaSy</p>
<h3 id="sub-3F0C"><a href="#sub-3F0C" class="headerlink" title="sub_3F0C"></a>sub_3F0C</h3><p>同样翻一下很快能定位到比较函数，那么同样密文可以从 init 里获取</p>
<p><img src="/WMCTF2023-REVERSE/image-20230826152331205.png" alt="image-20230826152331205"></p>
<p>而该加密函数（虽然我已经写了）我们可以通过里面的常量和大概的操作可以判断出是AES，findcrypt插件同样也可以定位到这里面，那么一样我们通过 frida 来获取密钥，可以回忆下 java 层是先判断用户名，再判断密码，所以在用户名输入刚刚解密出的正确用户名，再随意输入 16 位密码即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_sub_AFC</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = Module.findBaseAddress(<span class="string">&quot;libezandroid.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> sub_AFC = soAddr.add(<span class="number">0xAFC</span>);</span><br><span class="line">    Interceptor.attach(sub_AFC, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] sub_AFC called!&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg0: &quot;</span> + args[<span class="number">0</span>].readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg1: &quot;</span> + args[<span class="number">1</span>]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg2: &quot;</span> + args[<span class="number">2</span>].readCString());</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到回显</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] sub_AFC called!</span><br><span class="line">arg0: 1234123412341234</span><br><span class="line">arg1: 0x10</span><br><span class="line">arg2: Re_1s_eaSy123456</span><br></pre></td></tr></table></figure>



<h2 id="0x03-Get-Flag"><a href="#0x03-Get-Flag" class="headerlink" title="0x03 Get Flag"></a>0x03 Get Flag</h2><p>随后我们进行 AES 解密，发现不成功，于是去查看哪里魔改了，发现只是魔改了我们的 Sbox，同样可以在 init 段找到我们魔改的 SBOX，拿出来逆一下 S 盒即可解密拿到我们的 flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WMCTF&#123;Re_1s_eaSy_eZ_Rc4_@nd_AES!&#125;</span><br></pre></td></tr></table></figure>





<h1 id="RightBack"><a href="#RightBack" class="headerlink" title="RightBack"></a>RightBack</h1><h2 id="0x00-Daily-Shell-Check-1"><a href="#0x00-Daily-Shell-Check-1" class="headerlink" title="0x00 Daily Shell Check"></a>0x00 Daily Shell Check</h2><p>pyc文件，查看Read可知运行在python3.9下</p>
<h2 id="0x01-Deobfuscation"><a href="#0x01-Deobfuscation" class="headerlink" title="0x01 Deobfuscation"></a>0x01 Deobfuscation</h2><h3 id="Find-Flower"><a href="#Find-Flower" class="headerlink" title="Find Flower"></a>Find Flower</h3><p>Pyc文件直接使用pycdc进行反编译，不过可以发现直接报错，所以去观察一下python的字节码</p>
<p><img src="/WMCTF2023-REVERSE/image-20230726153928565.png" alt="image-20230726153928565"></p>
<p>不难发现有大量花指令，看似好像每个花指令都不一样，但其实形式都是一样的，形如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># JUMP_FORWARD  0       6E 0</span><br><span class="line"># JUMP_FORWARD  4       6E 4</span><br><span class="line"># 4个无意义字节          1 2 3 4   </span><br><span class="line"># JUMP_FORWARD  2       6E 2</span><br><span class="line"># 两个无意义字节         5 6   </span><br><span class="line"># org</span><br></pre></td></tr></table></figure>

<p>所以我们只需要把这些全部nop就能解决了？对于这种类型的花是可以全部 nop 解决，而有些样本的花不能解决，因为会影响到 co_lnotab</p>
<ol>
<li>这是指令与行号的对应表</li>
<li>Python通过<code>co_lnotab</code>将字节码和源码行数对齐，服务于源码调试</li>
<li>当我们改成了nop后，带参数的指令变成不带参数的指令定然会导致字节码偏移计算错误</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://svn.python.org/projects/python/branches/pep-0384/Objects/lnotab_notes.txt">https://svn.python.org/projects/python/branches/pep-0384/Objects/lnotab_notes.txt</a></p>
</blockquote>
<h3 id="Remove-Flower"><a href="#Remove-Flower" class="headerlink" title="Remove Flower"></a>Remove Flower</h3><p>于是我就换了个思路，就是直接去除花指令的字节码，但同时也要考虑python的结构体的修复，其中与我们字节码长度相关的结构体就是co_code</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x27;co_argcount&#x27;      # code需要的位置参数个数,不包括变长参数(*args 和 **kwargs)</span><br><span class="line">&#x27;co_cellvars&#x27;      # code 所用到的 cellvar 的变量名,tuple 类型, 元素是 PyStringObject(&#x27;s/t/R&#x27;)</span><br><span class="line">&#x27;co_code&#x27;          # PyStringObject(&#x27;s&#x27;), code对应的字节码</span><br><span class="line">&#x27;co_consts&#x27;        # 所有常量组成的 tuple</span><br><span class="line">&#x27;co_filename&#x27;      # PyStringObject(&#x27;s&#x27;), 此 code 对应的 py 文件名</span><br><span class="line">&#x27;co_firstlineno&#x27;   # 此 code 对应的 py 文件里的第一行的行号</span><br><span class="line">&#x27;co_flags&#x27;         # 一些标识位,也在 code.h 里定义,注释很清楚,比如 CO_NOFREE(64) 表示此 PyCodeObject 内无 freevars 和 cellvars 等</span><br><span class="line">&#x27;co_freevars&#x27;      # code 所用到的 freevar 的变量名,tuple 类型, 元素是 PyStringObject(&#x27;s/t/R&#x27;)</span><br><span class="line">&#x27;co_lnotab&#x27;        # PyStringObject(&#x27;s&#x27;),指令与行号的对应表</span><br><span class="line">&#x27;co_name&#x27;          # 此 code 的名称</span><br><span class="line">&#x27;co_names&#x27;         # code 所用的到符号表, tuple 类型,元素是字符串</span><br><span class="line">&#x27;co_nlocals&#x27;       # code内所有的局部变量的个数,包括所有参数</span><br><span class="line">&#x27;co_stacksize&#x27;     # code段运行时所需要的最大栈深度</span><br><span class="line">&#x27;co_varnames&#x27;      # code 所用到的局部变量名, tuple 类型, 元素是 PyStringObject(&#x27;s/t/R&#x27;)</span><br></pre></td></tr></table></figure>

<p>那边这里举一个简单的例子，VNCTF2022的BabyMaze</p>
<p>直接uncompyle6 发现直接G，那就是在字节码上动了什么手脚</p>
<p><img src="/WMCTF2023-REVERSE/image-20220208173840212-16931045113371.png" alt="BabyMaze/image-20220208173840212"></p>
<p>于是我们去看看字节码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> marshal, dis</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;BabyMaze.pyc&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">code = marshal.loads(f[<span class="number">16</span>:])			<span class="comment">#这边从16位开始取因为是python3 python2从8位开始取</span></span><br><span class="line"></span><br><span class="line">dis.dis(code)</span><br></pre></td></tr></table></figure>

<p>发现开头就是花指令</p>
<p><img src="/WMCTF2023-REVERSE/image-20220208174202488-16931045113372.png" alt="BabyMaze/image-20220208174202488"></p>
<p>通过python的opcode.h文件 翻译成十六进制</p>
<p><img src="/WMCTF2023-REVERSE/image-20220208174615675-16931045113373.png" alt="BabyMaze/image-20220208174615675"></p>
<p>发现就是这6个十六进制在来回跳</p>
<p><img src="/WMCTF2023-REVERSE/image-20220208174655142-16931045113374.png" alt="BabyMaze/image-20220208174655142"></p>
<p>去掉花的同时也要改co_code，这个是记录字节码的长度，所以我们减去6个这个也要减6</p>
<p><img src="/WMCTF2023-REVERSE/image-20220208174817071-16931045113375.png" alt="BabyMaze/image-20220208174817071"></p>
<p>于是去掉那6个，再把co_code减6即可</p>
<p><img src="/WMCTF2023-REVERSE/image-20220208174937176-16931045113376.png" alt="BabyMaze/image-20220208174937176"></p>
<p>成功uncompyle6</p>
<p><img src="/WMCTF2023-REVERSE/image-20220208175032919-16931045113377.png" alt="BabyMaze/image-20220208175032919"></p>
<p>也就是在修改了字节码后，同时要改co_code的长度，而根据python字节码的机制，每个函数会分成一个个代码段，在我们去除了每个代码段花的同时同时也要修改相对应的co_code，同时我们也可以根据每个代码段的头都是 0x73 来读取每个代码段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">slice_code</span>(<span class="params">code</span>):</span></span><br><span class="line">    <span class="comment"># 记录代码段的 开头 与 长度</span></span><br><span class="line">    code_attribute = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="keyword">if</span> code[i] == <span class="number">0x73</span>:</span><br><span class="line">            size = <span class="built_in">int</span>(struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, <span class="built_in">bytes</span>(code[i + <span class="number">1</span>:i + <span class="number">5</span>]))[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> code[size + i + <span class="number">5</span> - <span class="number">2</span>] == <span class="number">0x53</span>:</span><br><span class="line">                    code_attribute.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;index&#x27;</span>: i + <span class="number">5</span>,</span><br><span class="line">                        <span class="string">&#x27;len&#x27;</span>: size</span><br><span class="line">                    &#125;)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># 取出每个代码段    </span></span><br><span class="line">    code_list = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code_attribute)):</span><br><span class="line">        code_list.append(code[code_attribute[i][<span class="string">&#x27;index&#x27;</span>]: code_attribute[i][<span class="string">&#x27;index&#x27;</span>] + code_attribute[i][<span class="string">&#x27;len&#x27;</span>]])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> code_attribute, code_list</span><br></pre></td></tr></table></figure>

<p>读取完毕后，就可以开始修复代码段了，要注意的点有</p>
<ol>
<li>记录去除的指令长度修改co_code</li>
<li>修复跳转语句</li>
<li>去除所有的花指令</li>
</ol>
<p>由于python的跳转是硬编码进去的，所以当我们去除了字节，整个跳转就乱掉了，于是要修改每个跳转语句，而跳转语句总结一下就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">两类跳转</span><br><span class="line">1. 相对跳转</span><br><span class="line">  1.1 检测当前地址到目标地址中间的cnt</span><br><span class="line">2. 绝对跳转</span><br><span class="line">  2.1 检测起始地址到目标地址之前的cnt</span><br></pre></td></tr></table></figure>

<p>那么按照这个思路就可以完整的去除整个文件了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sliceCode</span>(<span class="params">code</span>):</span></span><br><span class="line">    code_attribute = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="keyword">if</span> code[i] == <span class="number">0x73</span> :</span><br><span class="line">            size = <span class="built_in">int</span>(struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, <span class="built_in">bytes</span>(code[i + <span class="number">1</span>:i + <span class="number">5</span>]))[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                num = <span class="number">3</span> + i</span><br><span class="line">                <span class="keyword">if</span> code[size + num] == <span class="number">0x53</span>:</span><br><span class="line">                    code_attribute.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;index&#x27;</span>: i + <span class="number">5</span>,</span><br><span class="line">                        <span class="string">&#x27;len&#x27;</span>: size</span><br><span class="line">                    &#125;)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span>   </span><br><span class="line">    code_list = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code_attribute)):</span><br><span class="line">        code_list.append(code[code_attribute[i][<span class="string">&#x27;index&#x27;</span>]: code_attribute[i][<span class="string">&#x27;index&#x27;</span>] + code_attribute[i][<span class="string">&#x27;len&#x27;</span>]])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> code_attribute, code_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repaitJump</span>(<span class="params">code</span>):</span></span><br><span class="line">    flower_target = [<span class="number">0x6E</span>, <span class="number">0x0</span>]</span><br><span class="line">    relative_jump_list = [<span class="number">0x6E</span>, <span class="number">0x78</span>, <span class="number">0x5D</span>]</span><br><span class="line">    absolute_jump_list = [<span class="number">0x6F</span>, <span class="number">0x70</span>, <span class="number">0x71</span>, <span class="number">0x72</span>, <span class="number">0x73</span>, <span class="number">0x77</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="keyword">if</span> code[i] <span class="keyword">in</span> relative_jump_list:</span><br><span class="line">            cnt = <span class="number">0</span></span><br><span class="line">            jmp_range = code[i + <span class="number">1</span>] + i + <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> jmp_range &gt; <span class="built_in">len</span>(code):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">2</span>, jmp_range):</span><br><span class="line">                <span class="keyword">if</span> code[j] == flower_target[<span class="number">0</span>] <span class="keyword">and</span> code[j + <span class="number">1</span>] == flower_target[<span class="number">1</span>] <span class="keyword">and</span> j % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                    cnt += <span class="number">1</span></span><br><span class="line">            code[i + <span class="number">1</span>] -= cnt * <span class="number">12</span></span><br><span class="line">        <span class="keyword">elif</span> code[i] <span class="keyword">in</span> absolute_jump_list:</span><br><span class="line">                cnt = <span class="number">0</span></span><br><span class="line">                jmp_range = code[i + <span class="number">1</span>]</span><br><span class="line">                <span class="keyword">if</span> jmp_range &gt; <span class="built_in">len</span>(code):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(jmp_range):</span><br><span class="line">                    <span class="keyword">if</span> code[j] == flower_target[<span class="number">0</span>] <span class="keyword">and</span> code[j + <span class="number">1</span>] == flower_target[<span class="number">1</span>] <span class="keyword">and</span> j % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                        cnt += <span class="number">1</span></span><br><span class="line">                code[i + <span class="number">1</span>] -= cnt * <span class="number">12</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">removeFlower</span>(<span class="params">code</span>):</span></span><br><span class="line">    org_code = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    flowerTarget = [<span class="number">0x6E</span>, <span class="number">0x0</span>]</span><br><span class="line">    flower_index = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code)):</span><br><span class="line">        <span class="keyword">if</span> code[i] == flowerTarget[<span class="number">0</span>] <span class="keyword">and</span> code[i + <span class="number">1</span>] == flowerTarget[<span class="number">1</span>] <span class="keyword">and</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            flower_index.append(i)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        org_code += <span class="built_in">bytes</span>(code[:flower_index[<span class="number">0</span>]])</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(flower_index)):</span><br><span class="line">            org_code += <span class="built_in">bytes</span>(code[flower_index[i - <span class="number">1</span>] + <span class="number">12</span>:flower_index[i]])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            org_code += <span class="built_in">bytes</span>(code[flower_index[i] + <span class="number">12</span>:])</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        org_code = <span class="built_in">bytes</span>(code)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> org_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    filename = <span class="string">&quot;obf_RightBack.pyc&quot;</span></span><br><span class="line">    f = <span class="built_in">list</span>(<span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    code_attribute, code_list = sliceCode(f)</span><br><span class="line">    file = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code_attribute)):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(code_list[i]) &lt;= <span class="number">0x100</span>:</span><br><span class="line">            code_list[i] = repaitJump(code_list[i])</span><br><span class="line">            code_list[i] = removeFlower(code_list[i])</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            file += <span class="built_in">bytes</span>(f[:code_attribute[i][<span class="string">&#x27;index&#x27;</span>] - <span class="number">4</span>]) + struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="built_in">len</span>(code_list[i])) + <span class="built_in">bytes</span>(code_list[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            file += <span class="built_in">bytes</span>(f[code_attribute[i - <span class="number">1</span>][<span class="string">&#x27;index&#x27;</span>] + code_attribute[i - <span class="number">1</span>][<span class="string">&#x27;len&#x27;</span>]:code_attribute[i][<span class="string">&#x27;index&#x27;</span>] - <span class="number">4</span>]) + struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="built_in">len</span>(code_list[i])) + <span class="built_in">bytes</span>(code_list[i])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        file += <span class="built_in">bytes</span>(f[code_attribute[i][<span class="string">&#x27;index&#x27;</span>] + code_attribute[i][<span class="string">&#x27;len&#x27;</span>]:])</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    filename = <span class="string">&#x27;rev_&#x27;</span> + filename</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(file)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;OK!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>随后成功反编译</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T</span>(<span class="params">num, <span class="built_in">round</span></span>):</span></span><br><span class="line">    numArr = <span class="built_in">bytearray</span>(struct.pack(<span class="string">&quot;&lt;I&quot;</span>, num))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span>  <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        numArr[i] = Sbox[numArr[i]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, numArr)[<span class="number">0</span>] ^ Rcon[<span class="built_in">round</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p1</span>(<span class="params">s, key</span>):</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    k = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        s.append(i)</span><br><span class="line">        k.append(key[i % <span class="built_in">len</span>(key)])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s[i] + <span class="built_in">ord</span>(k[i])) % <span class="number">256</span></span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p2</span>(<span class="params">key</span>):</span></span><br><span class="line">    w = [<span class="number">0</span>] * <span class="number">44</span> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        w[i] = struct.unpack(<span class="string">&#x27;&lt;I&#x27;</span>, key[i * <span class="number">4</span>:i * <span class="number">4</span> + <span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, <span class="number">44</span>, <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> ( i % <span class="number">4</span> == <span class="number">0</span> ):</span><br><span class="line">            w[i] = w[i - <span class="number">4</span>] ^ T(w[i - <span class="number">1</span>], cnt)</span><br><span class="line">            cnt += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            w[i] = w[i - <span class="number">4</span>] ^ w[i - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> w</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p3</span>(<span class="params">s, p</span>):</span></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(p)):</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + s[i]) % <span class="number">256</span></span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">        p[z] ^= s[(s[i] + s[j]) % <span class="number">256</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F1</span>(<span class="params">part1, part2</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line">    REG = &#123;<span class="string">&#x27;EAX&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;EBX&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;ECX&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;EDX&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;R8&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;CNT&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;EIP&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line">    REG[<span class="string">&#x27;EAX&#x27;</span>] = part1</span><br><span class="line">    REG[<span class="string">&#x27;EBX&#x27;</span>] = part2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F2</span>(<span class="params">v1, v2, v3</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v1 == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">global</span> extendKey</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] = extendKey[REG[reg_table[<span class="built_in">str</span>(v3)]]]</span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">2</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] = REG[reg_table[<span class="built_in">str</span>(v3)]]</span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">3</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] = v3</span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F3</span>(<span class="params">v1, v2, v3</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v1 == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">global</span> extendKey</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] = (REG[reg_table[<span class="built_in">str</span>(v2)]] + extendKey[REG[reg_table[<span class="built_in">str</span>(v3)]]]) &amp; <span class="number">0xFFFFFFFF</span> </span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">2</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] = (REG[reg_table[<span class="built_in">str</span>(v2)]] + REG[reg_table[<span class="built_in">str</span>(v3)]]) &amp; <span class="number">0xFFFFFFFF</span> </span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">3</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] = (REG[reg_table[<span class="built_in">str</span>(v2)]] + v3) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F4</span>(<span class="params">v1, v2</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    REG[reg_table[<span class="built_in">str</span>(v1)]] ^= REG[reg_table[<span class="built_in">str</span>(v2)]]</span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F5</span>(<span class="params">v1, v2</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    REG[reg_table[<span class="built_in">str</span>(v1)]] &amp;= v2</span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F6</span>(<span class="params">v1, v2, v3</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v1 == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">global</span> extendKey</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] -= extendKey[v3]</span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">2</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] -= REG[reg_table[<span class="built_in">str</span>(v3)]]</span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">3</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] -= v3</span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F7</span>(<span class="params">v1, v2</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    REG[reg_table[<span class="built_in">str</span>(v1)]] |= REG[reg_table[<span class="built_in">str</span>(v2)]]</span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F8</span>(<span class="params">v1, v2</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    REG[reg_table[<span class="built_in">str</span>(v1)]] = (REG[reg_table[<span class="built_in">str</span>(v1)]] &gt;&gt; REG[reg_table[<span class="built_in">str</span>(v2)]]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F9</span>(<span class="params">v1, v2</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    REG[reg_table[<span class="built_in">str</span>(v1)]] = (REG[reg_table[<span class="built_in">str</span>(v1)]] &lt;&lt; REG[reg_table[<span class="built_in">str</span>(v2)]]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FA</span>(<span class="params">v1, v2, v3</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v1 == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">global</span> extendKey</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] *= extendKey[v3]</span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">2</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] *= REG[reg_table[<span class="built_in">str</span>(v3)]]</span><br><span class="line">    <span class="keyword">elif</span> v1 == <span class="number">3</span>:</span><br><span class="line">        REG[reg_table[<span class="built_in">str</span>(v2)]] *= v3</span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FB</span>():</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;R8&#x27;</span>] = REG[<span class="string">&#x27;CNT&#x27;</span>] == <span class="number">21</span></span><br><span class="line"></span><br><span class="line">    REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 16</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">WC</span>():</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> REG[<span class="string">&#x27;R8&#x27;</span>]:</span><br><span class="line">        REG[<span class="string">&#x27;EIP&#x27;</span>] = <span class="number">16</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        REG[<span class="string">&#x27;EIP&#x27;</span>] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">VM</span>(<span class="params">part1, part2</span>):</span></span><br><span class="line">    <span class="keyword">global</span> REG</span><br><span class="line">    <span class="keyword">global</span> opcode</span><br><span class="line">    </span><br><span class="line">    F1(part1, part2)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        EIP = REG[<span class="string">&#x27;EIP&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> opcode[EIP] == <span class="number">0x50</span>:</span><br><span class="line">            F2(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>], opcode[EIP + <span class="number">3</span>])</span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x1D</span>:</span><br><span class="line">            F3(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>], opcode[EIP + <span class="number">3</span>])</span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x71</span>:</span><br><span class="line">            F4(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>])</span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x72</span>:</span><br><span class="line">            F5(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>]) </span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x96</span>:</span><br><span class="line">            F6(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>], opcode[EIP + <span class="number">3</span>])</span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x57</span>:</span><br><span class="line">            F7(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>]) </span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x74</span>:</span><br><span class="line">            F8(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>]) </span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x29</span>:</span><br><span class="line">            F9(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>]) </span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0xDC</span>:</span><br><span class="line">            FA(opcode[EIP + <span class="number">1</span>], opcode[EIP + <span class="number">2</span>], opcode[EIP + <span class="number">3</span>]) </span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x7</span>:</span><br><span class="line">            FB()</span><br><span class="line">        <span class="keyword">elif</span> opcode[EIP] == <span class="number">0x99</span>:</span><br><span class="line">            WC()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Have</span>():</span></span><br><span class="line">    Hello = <span class="string">&quot;&quot;&quot;                                                                                                                                                                                                                                                </span></span><br><span class="line"><span class="string">||   / |  / /                                                                     </span></span><br><span class="line"><span class="string">||  /  | / /  ___     //  ___      ___      _   __      ___       __  ___  ___    </span></span><br><span class="line"><span class="string">|| / /||/ / //___) ) // //   ) ) //   ) ) // ) )  ) ) //___) )     / /   //   ) ) </span></span><br><span class="line"><span class="string">||/ / |  / //       // //       //   / / // / /  / / //           / /   //   / /  </span></span><br><span class="line"><span class="string">|  /  | / ((____   // ((____   ((___/ / // / /  / / ((____       / /   ((___/ /   </span></span><br><span class="line"><span class="string">                                                                                            </span></span><br><span class="line"><span class="string">                                                                                            </span></span><br><span class="line"><span class="string">||   / |  / / /|    //| |     //   ) ) /__  ___/ //   / / ___      ___      ___      ___    </span></span><br><span class="line"><span class="string">||  /  | / / //|   // | |    //          / /    //___   //   ) ) //   ) ) //   ) ) //   ) ) </span></span><br><span class="line"><span class="string">|| / /||/ / // |  //  | |   //          / /    / ___     ___/ / //   / /   ___/ /   __ / /  </span></span><br><span class="line"><span class="string">||/ / |  / //  | //   | |  //          / /    //       / ____/ //   / /  / ____/       ) )  </span></span><br><span class="line"><span class="string">|  /  | / //   |//    | | ((____/ /   / /    //       / /____ ((___/ /  / /____  ((___/ /     </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(Hello)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">input</span>(<span class="string">&#x27;RightBack: &#x27;</span>).encode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Fun</span>(<span class="params">right</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(right) != <span class="number">64</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;XD&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    back = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(right), <span class="number">8</span>):</span><br><span class="line">        part1 = struct.unpack(<span class="string">&#x27;&gt;I&#x27;</span>, right[i + <span class="number">0</span>:i + <span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        part2 = struct.unpack(<span class="string">&#x27;&gt;I&#x27;</span>, right[i + <span class="number">4</span>:i + <span class="number">8</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">            part1 ^= struct.unpack(<span class="string">&#x27;&gt;I&#x27;</span>, back[i - <span class="number">8</span>:i - <span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">            part2 ^= struct.unpack(<span class="string">&#x27;&gt;I&#x27;</span>, back[i - <span class="number">4</span>:i])[<span class="number">0</span>]</span><br><span class="line">        VM(part1, part2)</span><br><span class="line">        back += struct.pack(<span class="string">&quot;&gt;I&quot;</span>, REG[<span class="string">&#x27;EAX&#x27;</span>])</span><br><span class="line">        back += struct.pack(<span class="string">&quot;&gt;I&quot;</span>, REG[<span class="string">&#x27;EBX&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> back</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    REG = &#123;&#125;</span><br><span class="line">    EIP = <span class="number">0</span></span><br><span class="line">    reg_table = &#123;<span class="string">&#x27;1&#x27;</span>: <span class="string">&#x27;EAX&#x27;</span>, <span class="string">&#x27;2&#x27;</span>: <span class="string">&#x27;EBX&#x27;</span>, <span class="string">&#x27;3&#x27;</span>: <span class="string">&#x27;ECX&#x27;</span>, <span class="string">&#x27;4&#x27;</span>: <span class="string">&#x27;EDX&#x27;</span>, <span class="string">&#x27;5&#x27;</span>: <span class="string">&#x27;R8&#x27;</span>, <span class="string">&#x27;6&#x27;</span>: <span class="string">&#x27;CNT&#x27;</span>, <span class="string">&#x27;7&#x27;</span>: <span class="string">&#x27;EIP&#x27;</span>&#125;</span><br><span class="line">    Sbox = [<span class="number">0x52</span>, <span class="number">0x09</span>, <span class="number">0x6a</span>, <span class="number">0xd5</span>, <span class="number">0x30</span>, <span class="number">0x36</span>, <span class="number">0xa5</span>, <span class="number">0x38</span>, <span class="number">0xbf</span>, <span class="number">0x40</span>, <span class="number">0xa3</span>, <span class="number">0x9e</span>, <span class="number">0x81</span>, <span class="number">0xf3</span>, <span class="number">0xd7</span>, <span class="number">0xfb</span>,	<span class="number">0x7c</span>, <span class="number">0xe3</span>, <span class="number">0x39</span>, <span class="number">0x82</span>, <span class="number">0x9b</span>, <span class="number">0x2f</span>, <span class="number">0xff</span>, <span class="number">0x87</span>, <span class="number">0x34</span>, <span class="number">0x8e</span>, <span class="number">0x43</span>, <span class="number">0x44</span>, <span class="number">0xc4</span>, <span class="number">0xde</span>, <span class="number">0xe9</span>, <span class="number">0xcb</span>,	<span class="number">0x54</span>, <span class="number">0x7b</span>, <span class="number">0x94</span>, <span class="number">0x32</span>, <span class="number">0xa6</span>, <span class="number">0xc2</span>, <span class="number">0x23</span>, <span class="number">0x3d</span>, <span class="number">0xee</span>, <span class="number">0x4c</span>, <span class="number">0x95</span>, <span class="number">0x0b</span>, <span class="number">0x42</span>, <span class="number">0xfa</span>, <span class="number">0xc3</span>, <span class="number">0x4e</span>,	<span class="number">0x08</span>, <span class="number">0x2e</span>, <span class="number">0xa1</span>, <span class="number">0x66</span>, <span class="number">0x28</span>, <span class="number">0xd9</span>, <span class="number">0x24</span>, <span class="number">0xb2</span>, <span class="number">0x76</span>, <span class="number">0x5b</span>, <span class="number">0xa2</span>, <span class="number">0x49</span>, <span class="number">0x6d</span>, <span class="number">0x8b</span>, <span class="number">0xd1</span>, <span class="number">0x25</span>,	<span class="number">0x72</span>, <span class="number">0xf8</span>, <span class="number">0xf6</span>, <span class="number">0x64</span>, <span class="number">0x86</span>, <span class="number">0x68</span>, <span class="number">0x98</span>, <span class="number">0x16</span>, <span class="number">0xd4</span>, <span class="number">0xa4</span>, <span class="number">0x5c</span>, <span class="number">0xcc</span>, <span class="number">0x5d</span>, <span class="number">0x65</span>, <span class="number">0xb6</span>, <span class="number">0x92</span>,	<span class="number">0x6c</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x50</span>, <span class="number">0xfd</span>, <span class="number">0xed</span>, <span class="number">0xb9</span>, <span class="number">0xda</span>, <span class="number">0x5e</span>, <span class="number">0x15</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0xa7</span>, <span class="number">0x8d</span>, <span class="number">0x9d</span>, <span class="number">0x84</span>,	<span class="number">0x90</span>, <span class="number">0xd8</span>, <span class="number">0xab</span>, <span class="number">0x00</span>, <span class="number">0x8c</span>, <span class="number">0xbc</span>, <span class="number">0xd3</span>, <span class="number">0x0a</span>, <span class="number">0xf7</span>, <span class="number">0xe4</span>, <span class="number">0x58</span>, <span class="number">0x05</span>, <span class="number">0xb8</span>, <span class="number">0xb3</span>, <span class="number">0x45</span>, <span class="number">0x06</span>,	<span class="number">0xd0</span>, <span class="number">0x2c</span>, <span class="number">0x1e</span>, <span class="number">0x8f</span>, <span class="number">0xca</span>, <span class="number">0x3f</span>, <span class="number">0x0f</span>, <span class="number">0x02</span>, <span class="number">0xc1</span>, <span class="number">0xaf</span>, <span class="number">0xbd</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x13</span>, <span class="number">0x8a</span>, <span class="number">0x6b</span>,	<span class="number">0x3a</span>, <span class="number">0x91</span>, <span class="number">0x11</span>, <span class="number">0x41</span>, <span class="number">0x4f</span>, <span class="number">0x67</span>, <span class="number">0xdc</span>, <span class="number">0xea</span>, <span class="number">0x97</span>, <span class="number">0xf2</span>, <span class="number">0xcf</span>, <span class="number">0xce</span>, <span class="number">0xf0</span>, <span class="number">0xb4</span>, <span class="number">0xe6</span>, <span class="number">0x73</span>,	<span class="number">0x96</span>, <span class="number">0xac</span>, <span class="number">0x74</span>, <span class="number">0x22</span>, <span class="number">0xe7</span>, <span class="number">0xad</span>, <span class="number">0x35</span>, <span class="number">0x85</span>, <span class="number">0xe2</span>, <span class="number">0xf9</span>, <span class="number">0x37</span>, <span class="number">0xe8</span>, <span class="number">0x1c</span>, <span class="number">0x75</span>, <span class="number">0xdf</span>, <span class="number">0x6e</span>,	<span class="number">0x47</span>, <span class="number">0xf1</span>, <span class="number">0x1a</span>, <span class="number">0x71</span>, <span class="number">0x1d</span>, <span class="number">0x29</span>, <span class="number">0xc5</span>, <span class="number">0x89</span>, <span class="number">0x6f</span>, <span class="number">0xb7</span>, <span class="number">0x62</span>, <span class="number">0x0e</span>, <span class="number">0xaa</span>, <span class="number">0x18</span>, <span class="number">0xbe</span>, <span class="number">0x1b</span>,	<span class="number">0xfc</span>, <span class="number">0x56</span>, <span class="number">0x3e</span>, <span class="number">0x4b</span>, <span class="number">0xc6</span>, <span class="number">0xd2</span>, <span class="number">0x79</span>, <span class="number">0x20</span>, <span class="number">0x9a</span>, <span class="number">0xdb</span>, <span class="number">0xc0</span>, <span class="number">0xfe</span>, <span class="number">0x78</span>, <span class="number">0xcd</span>, <span class="number">0x5a</span>, <span class="number">0xf4</span>,	<span class="number">0x1f</span>, <span class="number">0xdd</span>, <span class="number">0xa8</span>, <span class="number">0x33</span>, <span class="number">0x88</span>, <span class="number">0x07</span>, <span class="number">0xc7</span>, <span class="number">0x31</span>, <span class="number">0xb1</span>, <span class="number">0x12</span>, <span class="number">0x10</span>, <span class="number">0x59</span>, <span class="number">0x27</span>, <span class="number">0x80</span>, <span class="number">0xec</span>, <span class="number">0x5f</span>,	<span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x7f</span>, <span class="number">0xa9</span>, <span class="number">0x19</span>, <span class="number">0xb5</span>, <span class="number">0x4a</span>, <span class="number">0x0d</span>, <span class="number">0x2d</span>, <span class="number">0xe5</span>, <span class="number">0x7a</span>, <span class="number">0x9f</span>, <span class="number">0x93</span>, <span class="number">0xc9</span>, <span class="number">0x9c</span>, <span class="number">0xef</span>,	<span class="number">0xa0</span>, <span class="number">0xe0</span>, <span class="number">0x3b</span>, <span class="number">0x4d</span>, <span class="number">0xae</span>, <span class="number">0x2a</span>, <span class="number">0xf5</span>, <span class="number">0xb0</span>, <span class="number">0xc8</span>, <span class="number">0xeb</span>, <span class="number">0xbb</span>, <span class="number">0x3c</span>, <span class="number">0x83</span>, <span class="number">0x53</span>, <span class="number">0x99</span>, <span class="number">0x61</span>,	<span class="number">0x17</span>, <span class="number">0x2b</span>, <span class="number">0x04</span>, <span class="number">0x7e</span>, <span class="number">0xba</span>, <span class="number">0x77</span>, <span class="number">0xd6</span>, <span class="number">0x26</span>, <span class="number">0xe1</span>, <span class="number">0x69</span>, <span class="number">0x14</span>, <span class="number">0x63</span>, <span class="number">0x55</span>, <span class="number">0x21</span>, <span class="number">0x0c</span>, <span class="number">0x7d</span>]</span><br><span class="line">    Rcon = [<span class="number">0x01000000</span>, <span class="number">0x02000000</span>, <span class="number">0x04000000</span>, <span class="number">0x08000000</span>, <span class="number">0x10000000</span>, <span class="number">0x20000000</span>, <span class="number">0x40000000</span>, <span class="number">0x80000000</span>, <span class="number">0x1b000000</span>, <span class="number">0x36000000</span>]</span><br><span class="line">    s = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    key = <span class="string">&quot;CalmDownBelieveU&quot;</span></span><br><span class="line">    p1(s, key)</span><br><span class="line"></span><br><span class="line">    key = [<span class="number">61</span>, <span class="number">15</span>, <span class="number">58</span>, <span class="number">65</span>, <span class="number">177</span>, <span class="number">180</span>, <span class="number">182</span>, <span class="number">248</span>, <span class="number">192</span>, <span class="number">143</span>, <span class="number">37</span>, <span class="number">238</span>, <span class="number">50</span>, <span class="number">29</span>, <span class="number">215</span>, <span class="number">190</span>]</span><br><span class="line">    key = <span class="built_in">bytes</span>(p3(s, key))</span><br><span class="line"></span><br><span class="line">    extendKey = p2(<span class="built_in">bytes</span>(key))</span><br><span class="line"></span><br><span class="line">    opcode = [<span class="number">69</span>, <span class="number">136</span>, <span class="number">121</span>, <span class="number">24</span>, <span class="number">179</span>, <span class="number">67</span>, <span class="number">209</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">169</span>, <span class="number">205</span>, <span class="number">146</span>, <span class="number">212</span>, <span class="number">160</span>, <span class="number">124</span>, <span class="number">49</span>, <span class="number">20</span>, <span class="number">155</span>, <span class="number">157</span>, <span class="number">253</span>, <span class="number">52</span>, <span class="number">71</span>, <span class="number">174</span>, <span class="number">164</span>, <span class="number">134</span>, <span class="number">60</span>, <span class="number">184</span>, <span class="number">203</span>, <span class="number">131</span>, <span class="number">210</span>, <span class="number">57</span>, <span class="number">151</span>, <span class="number">77</span>, <span class="number">241</span>, <span class="number">61</span>, <span class="number">6</span>, <span class="number">13</span>, <span class="number">52</span>, <span class="number">235</span>, <span class="number">37</span>, <span class="number">100</span>, <span class="number">178</span>, <span class="number">8</span>, <span class="number">238</span>, <span class="number">205</span>, <span class="number">27</span>, <span class="number">194</span>, <span class="number">159</span>, <span class="number">230</span>, <span class="number">165</span>, <span class="number">211</span>, <span class="number">221</span>, <span class="number">100</span>, <span class="number">217</span>, <span class="number">111</span>, <span class="number">202</span>, <span class="number">185</span>, <span class="number">207</span>, <span class="number">226</span>, <span class="number">50</span>, <span class="number">88</span>, <span class="number">4</span>, <span class="number">58</span>, <span class="number">73</span>, <span class="number">10</span>, <span class="number">92</span>, <span class="number">24</span>, <span class="number">230</span>, <span class="number">246</span>, <span class="number">245</span>, <span class="number">21</span>, <span class="number">110</span>, <span class="number">182</span>, <span class="number">151</span>, <span class="number">85</span>, <span class="number">28</span>, <span class="number">181</span>, <span class="number">191</span>, <span class="number">185</span>, <span class="number">236</span>, <span class="number">92</span>, <span class="number">98</span>, <span class="number">222</span>, <span class="number">85</span>, <span class="number">228</span>, <span class="number">14</span>, <span class="number">235</span>, <span class="number">93</span>, <span class="number">77</span>, <span class="number">161</span>, <span class="number">61</span>, <span class="number">140</span>, <span class="number">222</span>, <span class="number">74</span>, <span class="number">124</span>, <span class="number">13</span>, <span class="number">211</span>, <span class="number">75</span>, <span class="number">134</span>, <span class="number">235</span>, <span class="number">164</span>, <span class="number">228</span>, <span class="number">235</span>, <span class="number">16</span>, <span class="number">29</span>, <span class="number">41</span>, <span class="number">49</span>, <span class="number">105</span>, <span class="number">188</span>, <span class="number">51</span>, <span class="number">232</span>, <span class="number">65</span>, <span class="number">209</span>, <span class="number">165</span>, <span class="number">35</span>, <span class="number">182</span>, <span class="number">248</span>, <span class="number">245</span>, <span class="number">69</span>, <span class="number">18</span>, <span class="number">152</span>, <span class="number">71</span>, <span class="number">223</span>, <span class="number">85</span>, <span class="number">114</span>]</span><br><span class="line">    opcode = p3(s, opcode)</span><br><span class="line"></span><br><span class="line">    right = Have()</span><br><span class="line">    back = Fun(right)</span><br><span class="line"></span><br><span class="line">    data1 = [<span class="number">228</span>, <span class="number">244</span>, <span class="number">207</span>, <span class="number">251</span>, <span class="number">194</span>, <span class="number">124</span>, <span class="number">252</span>, <span class="number">61</span>, <span class="number">198</span>, <span class="number">145</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">89</span>, <span class="number">25</span>, <span class="number">92</span>, <span class="number">208</span>, <span class="number">155</span>, <span class="number">38</span>, <span class="number">34</span>, <span class="number">225</span>, <span class="number">98</span>, <span class="number">206</span>, <span class="number">234</span>, <span class="number">245</span>, <span class="number">223</span>, <span class="number">54</span>, <span class="number">214</span>, <span class="number">137</span>, <span class="number">35</span>, <span class="number">86</span>, <span class="number">180</span>, <span class="number">66</span>, <span class="number">223</span>, <span class="number">234</span>, <span class="number">90</span>, <span class="number">136</span>, <span class="number">5</span>, <span class="number">189</span>, <span class="number">166</span>, <span class="number">117</span>, <span class="number">111</span>, <span class="number">222</span>, <span class="number">39</span>, <span class="number">156</span>, <span class="number">163</span>, <span class="number">173</span>, <span class="number">36</span>, <span class="number">174</span>, <span class="number">47</span>, <span class="number">144</span>, <span class="number">15</span>, <span class="number">160</span>, <span class="number">45</span>, <span class="number">239</span>, <span class="number">211</span>, <span class="number">11</span>, <span class="number">190</span>, <span class="number">181</span>, <span class="number">24</span>, <span class="number">164</span>, <span class="number">234</span>, <span class="number">114</span>, <span class="number">174</span>, <span class="number">27</span>]</span><br><span class="line">    data1 = <span class="built_in">bytes</span>(p3(s, data1))</span><br><span class="line"></span><br><span class="line">    data2 = [<span class="number">165</span>, <span class="number">83</span>, <span class="number">203</span>, <span class="number">51</span>, <span class="number">99</span>, <span class="number">164</span>, <span class="number">30</span>, <span class="number">91</span>, <span class="number">230</span>, <span class="number">64</span>, <span class="number">181</span>, <span class="number">55</span>, <span class="number">190</span>, <span class="number">47</span>, <span class="number">125</span>, <span class="number">240</span>, <span class="number">186</span>, <span class="number">173</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">89</span>, <span class="number">64</span>, <span class="number">68</span>, <span class="number">215</span>, <span class="number">124</span>, <span class="number">138</span>, <span class="number">34</span>, <span class="number">175</span>, <span class="number">60</span>, <span class="number">136</span>, <span class="number">77</span>, <span class="number">216</span>, <span class="number">250</span>, <span class="number">127</span>, <span class="number">14</span>, <span class="number">14</span>, <span class="number">66</span>, <span class="number">168</span>, <span class="number">198</span>, <span class="number">247</span>, <span class="number">252</span>, <span class="number">189</span>, <span class="number">243</span>, <span class="number">239</span>, <span class="number">25</span>, <span class="number">63</span>, <span class="number">143</span>, <span class="number">7</span>, <span class="number">177</span>, <span class="number">13</span>, <span class="number">99</span>, <span class="number">226</span>, <span class="number">100</span>, <span class="number">6</span>, <span class="number">207</span>, <span class="number">77</span>, <span class="number">46</span>, <span class="number">136</span>, <span class="number">251</span>, <span class="number">123</span>, <span class="number">225</span>, <span class="number">27</span>, <span class="number">76</span>, <span class="number">183</span>]</span><br><span class="line">    data2 = <span class="built_in">bytes</span>(p3(s, data2))</span><br><span class="line"></span><br><span class="line">    data3 = [<span class="number">95</span>, <span class="number">219</span>, <span class="number">46</span>, <span class="number">178</span>, <span class="number">111</span>, <span class="number">141</span>, <span class="number">17</span>, <span class="number">168</span>, <span class="number">254</span>, <span class="number">60</span>, <span class="number">68</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">183</span>, <span class="number">182</span>, <span class="number">118</span>, <span class="number">3</span>, <span class="number">47</span>, <span class="number">150</span>, <span class="number">240</span>, <span class="number">140</span>, <span class="number">159</span>, <span class="number">110</span>, <span class="number">238</span>]</span><br><span class="line">    data3 = <span class="built_in">bytes</span>(p3(s, data3))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> back == data2:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">bytes</span>(data1).decode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">bytes</span>(data3).decode())</span><br></pre></td></tr></table></figure>



<h2 id="0x02-Decryption"><a href="#0x02-Decryption" class="headerlink" title="0x02 Decryption"></a>0x02 Decryption</h2><p>那么在解混淆后来审计python代码就比较容易了，所有字符串都经过了RC4加密，不过恢复了源码就可以直接打印出来看字符串或是所需要的数据，稍微审计则可发现程序只经过一个 Have 函数的加密，而这里面一个 VM 加密</p>
<p><img src="/WMCTF2023-REVERSE/image-20230726161233485.png" alt="image-20230726161233485"></p>
<p>而有源码所有的中间数据都可以调试获取，有了正确的opcode，写出一个解释器即可得知程序对输入进行了什么样的加密，当然加密不是很长直接手动分析也可，于是可以得知加密过程如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">初始化寄存器</span><br><span class="line"></span><br><span class="line">mov ecx, 0												   ; 0x50, 3, 3, 0</span><br><span class="line">add eax, key ecx	eax += key0								; 0x1D, 1, 1, 3	</span><br><span class="line">mov ecx, 1												   ; 0x50, 3, 3, 1</span><br><span class="line">add ebx, key ecx	ebx += key1								; 0x1D, 1, 2, 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add cnt, 1		循环开始  								; 0x1D, 3, 6, 1</span><br><span class="line">xor eax, ebx	A^B										; 0x71, 1, 2</span><br><span class="line">mov ecx, eax	ecx = A ^ B	 							 ; 0x50, 2, 3, 1</span><br><span class="line">mov r8, ebx		r8 = B									; 0x50, 2, 5, 2</span><br><span class="line">and ebx, 0x1F	B &amp; 0x1F								; 0x72, 2, 0x1F</span><br><span class="line">shl eax, ebx	eax = (A^B) &lt;&lt; (B &amp; 0x1F)				  ; 0x29, 1, 2</span><br><span class="line">mov edx, 32												; 0x50, 3, 4, 32</span><br><span class="line">sub edx, ebx	32 - (B &amp; 0x1F)							 ; 0x96, 2, 4, 2</span><br><span class="line">shr ecx, edx	ecx = (A^B) &gt;&gt; (32 - (B &amp; 0x1F))		   ; 0x74, 3, 4</span><br><span class="line">or eax, ecx	A = (A^B) &lt;&lt; (B &amp; 0x1F) | (A^B) &gt;&gt; (32 - (B &amp; 0x1F)) ; 0x57, 1, 3</span><br><span class="line">mov ebx, cnt											; 0x50, 2, 2, 6				</span><br><span class="line">mul ebx, 2												; 0xDC, 3, 2, 2</span><br><span class="line">mov ecx, key ebx										; 0x50, 1, 3, 2</span><br><span class="line">add eax, ecx	A += roundkey[2 * i] 					 ; 0x1D, 2, 1, 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mov ebx, r8											    ; 0x50, 2, 2, 5</span><br><span class="line">xor ebx, eax	B ^ A									; 0x71, 2, 1</span><br><span class="line">mov ecx, ebx	ecx = B ^ A								; 0x50, 2, 3, 2</span><br><span class="line">mov edx, eax											; 0x50, 2, 4, 1</span><br><span class="line">and edx, 0x1F	A &amp; 0x1F								; 0x72, 4, 0x1F</span><br><span class="line">shl ebx, edx	ebx = (B ^ A) &lt;&lt; (A &amp; 0x1F)				  ; 0x29, 2, 4</span><br><span class="line">mov r8, 32												; 0x50, 3, 5, 32</span><br><span class="line">sub r8, edx	r8 = 32 - (A &amp; 0x1F)						 ; 0x96, 2, 5, 4</span><br><span class="line">shr ecx, r8												; 0x74, 3, 5</span><br><span class="line">or ebx, ecx	ebx = (B^A) &lt;&lt; (A &amp; 0x1F) | (B^A) &gt;&gt; (32 - (A &amp; 0x1F)) ; 0x57, 2, 3</span><br><span class="line">mov ecx, cnt											; 0x50, 2, 3, 6</span><br><span class="line">mul ecx, 2												; 0xDC, 3, 3, 2</span><br><span class="line">add ecx, 1												; 0x1D, 3, 3, 1</span><br><span class="line">mov edx, key ecx										; 0x50, 1, 4, 3</span><br><span class="line">add ebx, edx	B += roundkey[2 * i + 1]				  ; 0x1D, 2, 2, 4</span><br><span class="line"></span><br><span class="line">cmp cnt, 21												; 0x7</span><br><span class="line">jnz add cnt, 1</span><br><span class="line">exit														0xFF				</span><br></pre></td></tr></table></figure>



<h2 id="0x03-GetFlag"><a href="#0x03-GetFlag" class="headerlink" title="0x03 GetFlag"></a>0x03 GetFlag</h2><p>还原成C语言代码不难发现这是个RC5加密，唯一修改的地方就是轮数改成了21轮，所需要的key在原程序中可以直接打印获得，于是搓出脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD_SIZE 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_SIZE 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_ROUNDS 21</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RC5_Decrypt</span><span class="params">(<span class="keyword">uint32_t</span> *ct, <span class="keyword">uint32_t</span> *pt, <span class="keyword">uint32_t</span> *roundKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">uint32_t</span> B = ct[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> A = ct[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = NUM_ROUNDS; i &gt;= <span class="number">1</span>; i--) &#123;</span><br><span class="line">        B -= roundKey[<span class="number">2</span> * i + <span class="number">1</span>];</span><br><span class="line">        B = (B &lt;&lt; (WORD_SIZE - (A &amp; (WORD_SIZE - <span class="number">1</span>)))) | (B &gt;&gt; (A &amp; (WORD_SIZE - <span class="number">1</span>)));</span><br><span class="line">        B ^= A;</span><br><span class="line">        A -= roundKey[<span class="number">2</span> * i];</span><br><span class="line">        A = (A &lt;&lt; (WORD_SIZE - (B &amp; (WORD_SIZE - <span class="number">1</span>)))) | (A &gt;&gt; (B &amp; (WORD_SIZE - <span class="number">1</span>)));</span><br><span class="line">        A ^= B;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pt[<span class="number">1</span>] = B - roundKey[<span class="number">1</span>];</span><br><span class="line">    pt[<span class="number">0</span>] = A - roundKey[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ciphertext[] = &#123;<span class="number">0x43af236</span>, <span class="number">0x56b19afc</span>, <span class="number">0xf71e21dc</span>, <span class="number">0xdb8f8e94</span>, <span class="number">0x4d34e79d</span>, <span class="number">0x9c520c6e</span>, <span class="number">0xfbfad5fd</span>, <span class="number">0x32f9782c</span>, <span class="number">0xbbbe39c1</span>, <span class="number">0xd98575b6</span>, <span class="number">0x28f8cc78</span>, <span class="number">0xa4e48592</span>, <span class="number">0xebd72c5</span>, <span class="number">0xaf87912a</span>, <span class="number">0x8bf1ef96</span>, <span class="number">0x1660d112</span>&#125;;</span><br><span class="line">    <span class="keyword">uint32_t</span> roundKey[] = &#123;<span class="number">1835819331</span>, <span class="number">1853321028</span>, <span class="number">1768711490</span>, <span class="number">1432712805</span>, <span class="number">2177920767</span>, <span class="number">4020699579</span>, <span class="number">2261476601</span>, <span class="number">3551400604</span>, <span class="number">711874531</span>, <span class="number">3318306392</span>, <span class="number">1124217505</span>, <span class="number">2427199549</span>, <span class="number">3099853672</span>, <span class="number">2098025776</span>, <span class="number">1041196945</span>, <span class="number">2929936300</span>, <span class="number">246748610</span>, <span class="number">1941455090</span>, <span class="number">1303848803</span>, <span class="number">3809763535</span>, <span class="number">1395557789</span>, <span class="number">546751855</span>, <span class="number">1830937100</span>, <span class="number">2385871555</span>, <span class="number">2516030638</span>, <span class="number">3043054017</span>, <span class="number">3628118989</span>, <span class="number">1450520846</span>, <span class="number">1825094265</span>, <span class="number">3651791800</span>, <span class="number">32069749</span>, <span class="number">1469868411</span>, <span class="number">919887482</span>, <span class="number">4017993154</span>, <span class="number">4002737591</span>, <span class="number">3104343244</span>, <span class="number">4134211933</span>, <span class="number">420914335</span>, <span class="number">4152510760</span>, <span class="number">1317719524</span>, <span class="number">1990496755</span>, <span class="number">1873950060</span>, <span class="number">2553314372</span>, <span class="number">3602559392</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">uint32_t</span> flag[<span class="number">16</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">    	RC5_Decrypt(ciphertext + <span class="number">2</span> * i, flag + <span class="number">2</span> * i, roundKey);</span><br><span class="line">    	<span class="keyword">if</span> (i != <span class="number">0</span>)</span><br><span class="line">    	&#123;</span><br><span class="line">    		flag[i * <span class="number">2</span>] ^= ciphertext[<span class="number">2</span> * i - <span class="number">2</span>];</span><br><span class="line">    		flag[i * <span class="number">2</span> + <span class="number">1</span>] ^= ciphertext[<span class="number">2</span> * i - <span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> ( j = <span class="number">3</span>; j &gt;= <span class="number">0</span>; j-- )</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, (flag[i * <span class="number">2</span>] &gt;&gt; (j * <span class="number">8</span>)) &amp; <span class="number">0xFF</span>);</span><br><span class="line">		<span class="keyword">for</span> ( j = <span class="number">3</span>; j &gt;= <span class="number">0</span>; j-- )</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, (flag[i * <span class="number">2</span> + <span class="number">1</span>] &gt;&gt; (j * <span class="number">8</span>)) &amp; <span class="number">0xFF</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Get Flag!</p>
<p><img src="/WMCTF2023-REVERSE/image-20230726161738691.png" alt="image-20230726161738691"></p>
<h1 id="Gohunt"><a href="#Gohunt" class="headerlink" title="Gohunt"></a>Gohunt</h1><h2 id="0x00-Daily-Shell-Check-2"><a href="#0x00-Daily-Shell-Check-2" class="headerlink" title="0x00 Daily Shell Check"></a>0x00 Daily Shell Check</h2><p>无壳64位</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827171838072.png" alt="image-20230827171838072"></p>
<h2 id="0x01-Main"><a href="#0x01-Main" class="headerlink" title="0x01 Main"></a>0x01 Main</h2><p>拖进 IDA，打开主函数发现是个 go 题，没有去符号，然而 main 函数有两千多行，所以要配合动调来解题</p>
<p>首先是字符串都经过了加密，通过这个base64动态解密，注意的是base64是换了码表，不过直接点进去取即可</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827172035193.png" alt="image-20230827172035193"></p>
<p>随后我们的输入进入了 xxtea 的加密，密钥也是动态解密，直接自己解密即可得到密钥</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827172128136.png" alt="image-20230827172128136"></p>
<p>可以发现 xxtea 非常长，而且字符串的提示可以确定是导入的 xxtea 的包到底这么长，并不是出题人写了这么长，赛后可以参考源码其实就一句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">encrypted := xxtea.Encrypt([]byte(flag), []byte(key))</span><br></pre></td></tr></table></figure>

<p>随后对我们的 input 按 x 交叉引用追踪到 xxtea 结束的位置进行了异或的操作，该异或的密钥也可以直接解密即可</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827172418207.png" alt="image-20230827172418207"></p>
<p>随后把我们的输入转成了大数，进行的操作转成了 base 系列的字符串，我们通过附件扫描到的二维码得到的数据也是类似的，不难猜测这就是 base58 限定的字符集，然而直接解密发现不对，我们可以通过动调或者查找字符串的方式拿到修改后的码表</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827172813359.png" alt="image-20230827172813359"></p>
<p>随后的操作就是把密文生成二维码了</p>
<h2 id="0x02-Get-Flag"><a href="#0x02-Get-Flag" class="headerlink" title="0x02 Get Flag"></a>0x02 Get Flag</h2><p>那么我们只需要 base58，xor，xxtea 即可拿到 flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base58</span><br><span class="line"><span class="keyword">import</span> xxtea</span><br><span class="line"> </span><br><span class="line">flag = base58.b58decode(<span class="string">&#x27;YMQHsYFQu7kkTqu3Xmt1ruYUDLU8uaMoPpsfjqYF4TQMMKtw5KF7cpWrkWpk3&#x27;</span>, alphabet=<span class="string">b&#x27;nY7TwcE41bzWvMQZXa8fyeprJoBdmhsu9DqVgxRPtFLKN65UH2CikG3SAj&#x27;</span>)</span><br><span class="line">flag = <span class="built_in">bytearray</span>(flag)</span><br><span class="line"></span><br><span class="line">xor_key = <span class="string">b&#x27;NPWrpd1CEJH2QcJ3&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flag)):</span><br><span class="line">    flag[i] ^= xor_key[i % <span class="built_in">len</span>(xor_key)]</span><br><span class="line">xxtea_key = <span class="string">b&#x27;FMT2ZCEHS6pcfD2R&#x27;</span></span><br><span class="line">flag = xxtea.decrypt(flag, xxtea_key, padding=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<p>Get Flag!</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827173136742.png" alt="image-20230827173136742"></p>
<h1 id="EzIOS"><a href="#EzIOS" class="headerlink" title="EzIOS"></a>EzIOS</h1><h2 id="0x00-Daily-Shell-Check-3"><a href="#0x00-Daily-Shell-Check-3" class="headerlink" title="0x00 Daily Shell Check"></a>0x00 Daily Shell Check</h2><p>IOS逆向，和安卓一样是个zip文件，直接解包分析与目录同名的文件</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827194549888.png" alt="image-20230827194549888"></p>
<h2 id="0x01-Trace"><a href="#0x01-Trace" class="headerlink" title="0x01 Trace"></a>0x01 Trace</h2><p>由于没有IOS手机，只能嗯审 + 模拟执行，不过先要找到主要的代码逻辑，通过搜索字符串找到按钮相应的处理函数</p>
<p><img src="/WMCTF2023-REVERSE/image-20230827194722115.png" alt="image-20230827194722115"></p>
<p>然而几乎每个函数都上了 ollvm 混淆，用 D810 会稍微好一点，然而还有字符串混淆，一般是采用运行起来再 patch 回去，现在跑不起来只能通过模拟执行来恢复，或者修改 data const 段的写权限去掉，会恢复一些字符串，xmmm类型的恢复不了</p>

    </div>
    
    <div id = "frozen-btn" class = "center">
    <!-- <button class="green" onclick = "Change()">🎉☕一杯咖啡~</button> -->
    <button class="purple" onclick = "Change()">🍰</button>
    </div>
    
    <div class = "hide" id = "img">
        <div class="post-list">
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/AliPay.png" alt="DASCTF X SU">
                    <div class="center">
                        🍬
                    </div>
                </div>
            </article>
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/WeChat.png" alt="HFCTF2022">
                    <div class="center">
                        🍪
                    </div>
                </div>
            </article>
        </div>
    </div>
    <script>
            function Change()
            {
                var img = document.getElementById("img");
                if(img.className == "hide")
                {
                    img.className="";
                }
                else
                {
                    img.className="hide";
                }
            }
    </script>

    <div class="about">
        <h1>About this Post</h1>
        <p>This post is written by P.Z, licensed under <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>
    <!-- 
        
     -->
<div class="container">
<!-- <div id="waline"></div>
  <script>
    Waline({
      el: '#waline',
      serverURL: 'https://blog-api-pozeep.vercel.app/',  
      visitor: true,
      emoji: [   //这里加了一些表情 
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba',
      ],
       avatar: 'robohash',   //自定义默认头像为随机的机器人
       placeholder: '🍟🍰🧊🍔🍓🍫🍦🍗🍇🍉🍑🥐🍕',   //占位符
    });
  </script>
</div> -->

<!-- <span id="/2023/08/26/WMCTF2023-REVERSE/" class="leancloud_visitors" data-flag-title="WMCTF2023 REVERSE">
    <em class="post-meta-item-text">阅读量 </em>
    <i class="waline-visitor-count"></i>
</span> -->

</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Home</a>
                
                <a href="/Diary/Diary.html" class="item">Diary</a>
                
                <a href="/Friends/Friends.html" class="item">Friends</a>
                
                <a href="/CTF/CTF.html" class="item">CTF</a>
                
                <a href="/Book/Book.html" class="item">Book</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/PoZeep" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/39892350" class="item">BiliBili</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 P.Z<br >Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
        
    <span id="sitetime" style="text-align: center;display:block;"></span>


</footer>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 12, 27, 12, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "我已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了*/
    siteTime();
</script>

<!-- 在线通讯Tidio -->

<script src="//code.tidio.co/zmdcv08a6racnaer2so7xybdwby41fsa.js"></script>



        
<script src="/js/main.js"></script>

        
    </body>
</html>