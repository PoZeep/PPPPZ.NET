<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>IDApython LEARNING - P.Z&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

    <script src='//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'></script>

<meta name="generator" content="Hexo 6.0.0"></head>

<!-- //unpkg.com/@waline/client -->
<!--  -->
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">P.Z&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/Diary/Diary">Diary</a>
            
            
            
            <a class="nav-item" href="/Friends/Friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Book/Book">Book</a>
            
            
            
            <a class="nav-item" href="/Sundry/Sundry">Sundry</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/PoZeep" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://space.bilibili.com/39892350" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            
            
            <span>September</span>
            
            
            
            
            <span>14,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">IDApython LEARNING</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>由于之前存放的脚本都太乱了，突然想起我可以开个笔记整理一下）</p>
<p>有网先看文章）</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://wonderkun.cc/2020/12/11/idapython%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/">https://wonderkun.cc/2020/12/11/idapython%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/</a></p>
<p>…</p>
</blockquote>
<p>断点设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addr = <span class="number">0x0056457AE08CA6</span></span><br><span class="line">idc.add_bpt( addr )</span><br></pre></td></tr></table></figure>

<h1 id="Norm"><a href="#Norm" class="headerlink" title="Norm"></a>Norm</h1><h2 id="TakeResource"><a href="#TakeResource" class="headerlink" title="TakeResource"></a>TakeResource</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ida_bytes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x00000140003040</span></span><br><span class="line"><span class="built_in">len</span> = <span class="number">0x34166</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;ans.exe&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>):</span><br><span class="line">    f.write(<span class="built_in">bytes</span>([get_byte(addr)]))</span><br><span class="line">    addr += <span class="number">1</span></span><br><span class="line">f.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;OK!&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="单字节SMC"><a href="#单字节SMC" class="headerlink" title="单字节SMC"></a>单字节SMC</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">st = <span class="number">0x40107C</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">121</span>):</span><br><span class="line">	ch = get_wide_byte(st + i)						</span><br><span class="line">	patch_byte(st + i, (ch ^ <span class="number">0xA2</span>) + <span class="number">34</span>)	</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;OK!&#x27;</span>)	</span><br></pre></td></tr></table></figure>



<h2 id="四字节SMC"><a href="#四字节SMC" class="headerlink" title="四字节SMC"></a>四字节SMC</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xorKey = &#123;<span class="number">8723</span>: <span class="number">2533025110152939745</span>, <span class="number">8739</span>: <span class="number">5590097037203163468</span>, <span class="number">8755</span>: <span class="number">17414346542877855401</span>, <span class="number">8771</span>: <span class="number">17520503086133755340</span>, <span class="number">8787</span>: <span class="number">12492599841064285544</span>, <span class="number">8803</span>: <span class="number">12384833368350302160</span>, <span class="number">8819</span>: <span class="number">11956541642520230699</span>, <span class="number">8835</span>: <span class="number">12628929057681570616</span>, <span class="number">8851</span>: <span class="number">910654967627959011</span>, <span class="number">8867</span>: <span class="number">5684234031469876551</span>, <span class="number">8883</span>: <span class="number">6000358478182005051</span>, <span class="number">8899</span>: <span class="number">3341586462889168127</span>, <span class="number">8915</span>: <span class="number">11094889238442167020</span>, <span class="number">8931</span>: <span class="number">17237527861538956365</span>, <span class="number">8947</span>: <span class="number">17178915143649401084</span>, <span class="number">8963</span>: <span class="number">11176844209899222046</span>, <span class="number">8979</span>: <span class="number">18079493192679046363</span>, <span class="number">8995</span>: <span class="number">7090159446630928781</span>, <span class="number">9011</span>: <span class="number">863094436381699168</span>, <span class="number">9027</span>: <span class="number">6906972144372600884</span>, <span class="number">9043</span>: <span class="number">16780793948225765908</span>, <span class="number">9059</span>: <span class="number">7086655467811962655</span>, <span class="number">9075</span>: <span class="number">13977154540038163446</span>, <span class="number">9091</span>: <span class="number">7066662532691991888</span>, <span class="number">9107</span>: <span class="number">15157921356638311270</span>, <span class="number">9123</span>: <span class="number">12585839823593393444</span>, <span class="number">9139</span>: <span class="number">1360651393631625694</span>, <span class="number">9155</span>: <span class="number">2139328426318955142</span>, <span class="number">9171</span>: <span class="number">2478274715212481947</span>, <span class="number">9187</span>: <span class="number">12876028885252459748</span>, <span class="number">9203</span>: <span class="number">18132176846268847269</span>, <span class="number">9219</span>: <span class="number">17242441603067001509</span>, <span class="number">9235</span>: <span class="number">8492111998925944081</span>, <span class="number">9251</span>: <span class="number">14679986489201789069</span>, <span class="number">9267</span>: <span class="number">13188777131396593592</span>, <span class="number">9283</span>: <span class="number">5298970373130621883</span>, <span class="number">9299</span>: <span class="number">525902164359904478</span>, <span class="number">9315</span>: <span class="number">2117701741234018776</span>, <span class="number">9331</span>: <span class="number">9158760851580517972</span>&#125;</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x2213</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = get_qword(addr)</span><br><span class="line">    key = xorKey[addr]</span><br><span class="line">    dec = data ^ key</span><br><span class="line">    idc.patch_qword(addr, dec)</span><br><span class="line">    addr += <span class="number">16</span></span><br></pre></td></tr></table></figure>

<h1 id="常见花？"><a href="#常见花？" class="headerlink" title="常见花？"></a>常见花？</h1><h2 id="MRCTF-shit"><a href="#MRCTF-shit" class="headerlink" title="MRCTF-shit"></a>MRCTF-shit</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">st = <span class="number">0x004812F0</span></span><br><span class="line">end = <span class="number">0x00481452</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patchNop</span>(<span class="params">start, end</span>):</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end):</span><br><span class="line">		ida_bytes.patch_byte(i, <span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nextInstr</span>(<span class="params">addr</span>):</span></span><br><span class="line">	<span class="keyword">return</span> addr + idc.get_item_size(addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">addr = st</span><br><span class="line"><span class="keyword">while</span> ( addr &lt; end ):</span><br><span class="line">	<span class="built_in">next</span> = nextInstr(addr)</span><br><span class="line">	addnext = idc.get_operand_value(<span class="built_in">next</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment">#	print(hex(anext))</span></span><br><span class="line">	<span class="keyword">if</span> idc.print_insn_mnem(<span class="built_in">next</span>) == <span class="string">&quot;call&quot;</span> <span class="keyword">and</span> idc.print_insn_mnem(addnext) == <span class="string">&quot;add&quot;</span>:</span><br><span class="line">		retnext = nextInstr(addnext)</span><br><span class="line">		addr = nextInstr(retnext)</span><br><span class="line">		patchNop(<span class="built_in">next</span>, addr)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Patch: %X&quot;</span> %<span class="built_in">next</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		addr = <span class="built_in">next</span></span><br></pre></td></tr></table></figure>

<h2 id="CCB-Hole"><a href="#CCB-Hole" class="headerlink" title="CCB-Hole"></a>CCB-Hole</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addr = <span class="number">0x4011E0</span></span><br><span class="line">end = <span class="number">0x401A3B</span></span><br><span class="line"><span class="keyword">while</span> ( addr &lt; end ):</span><br><span class="line">	<span class="keyword">if</span> ( get_wide_byte(addr) == <span class="number">0xEB</span> <span class="keyword">and</span> get_wide_byte(addr + <span class="number">1</span>) == <span class="number">0xFF</span> ):</span><br><span class="line">		patch_byte(addr, <span class="number">0x90</span>)</span><br><span class="line">	<span class="keyword">elif</span> ( get_wide_byte(addr) == <span class="number">0x66</span> <span class="keyword">and</span> get_wide_byte(addr + <span class="number">1</span>) == <span class="number">0xB8</span> ):</span><br><span class="line">		nop(addr, addr + <span class="number">9</span>)</span><br><span class="line">	addr += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;OK!&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h1 id="OLLVM-虚假控制流"><a href="#OLLVM-虚假控制流" class="headerlink" title="OLLVM-虚假控制流"></a>OLLVM-虚假控制流</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">st = <span class="number">0x4007E0</span></span><br><span class="line">end = <span class="number">0x401154</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_nop</span>(<span class="params">start, end</span>):</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end):</span><br><span class="line">		ida_bytes.patch_byte(i, <span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next_instr</span>(<span class="params">addr</span>):</span>					            		<span class="comment">#get_item_size 获取指令或数据长度，这个函数的作用就是去往下一条指令</span></span><br><span class="line">	<span class="keyword">return</span> addr + idc.get_item_size(addr)</span><br><span class="line"></span><br><span class="line">addr = st</span><br><span class="line"><span class="keyword">while</span> (addr &lt; end):</span><br><span class="line">	<span class="built_in">next</span> = next_instr(addr)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&quot;ds:x&quot;</span> <span class="keyword">in</span> idc.GetDisasm(addr):	        			<span class="comment">#idc.GetDisasm(addr)得到addr的反汇编语句</span></span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">			addr = <span class="built_in">next</span></span><br><span class="line">			<span class="built_in">next</span> = next_instr(addr)</span><br><span class="line">			<span class="keyword">if</span> <span class="string">&quot;jnz&quot;</span> <span class="keyword">in</span> idc.GetDisasm(addr):</span><br><span class="line">				dest = idc.get_operand_value(addr, <span class="number">0</span>)       <span class="comment">#得到操作数,即指令后的数 例如 jz 偏移地址 于是get_oprand_value获得偏移地址</span></span><br><span class="line">				ida_bytes.patch_byte(addr, <span class="number">0xE9</span>)            <span class="comment">#改addr地址的机器码为jmp</span></span><br><span class="line">				ida_bytes.patch_byte(addr + <span class="number">5</span>, <span class="number">0x90</span>)        <span class="comment">#addr + 5的位置改成nop</span></span><br><span class="line">				offset = dest - (addr + <span class="number">5</span>)                  <span class="comment">#调整为正确的偏移地址 也就是相对偏移地址 - 当前指令后的地址</span></span><br><span class="line">				ida_bytes.patch_dword(addr + <span class="number">1</span>, offset)     <span class="comment">#把偏移地址放到 jmp xxxx nop</span></span><br><span class="line">				<span class="built_in">print</span>(<span class="string">&quot;patch bcf: 0x%x&quot;</span> % addr)</span><br><span class="line">				addr = <span class="built_in">next</span></span><br><span class="line">				patch_nop(<span class="built_in">next</span>, <span class="built_in">next</span> + <span class="number">3</span>)					<span class="comment">#把无用的jmp xxx全部nop掉</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		addr = <span class="built_in">next</span></span><br></pre></td></tr></table></figure>



<h1 id="栈混淆"><a href="#栈混淆" class="headerlink" title="栈混淆"></a>栈混淆</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">start = <span class="number">0x807FEC0</span></span><br><span class="line">end = <span class="number">0x8080AD1</span></span><br><span class="line"></span><br><span class="line">address = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">callTarget = [<span class="string">&quot;lea&quot;</span>, <span class="string">&quot;lea&quot;</span>, <span class="string">&quot;mov&quot;</span>, <span class="string">&quot;jmp&quot;</span>]</span><br><span class="line">retnTarget = [<span class="string">&quot;lea&quot;</span>, <span class="string">&quot;mov&quot;</span>, <span class="string">&quot;and&quot;</span>, <span class="string">&quot;lea&quot;</span>, <span class="string">&quot;jmp&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop</span>(<span class="params">s, e</span>):</span></span><br><span class="line">	<span class="keyword">while</span> (s &lt; e):</span><br><span class="line">		patch_byte(s, <span class="number">0x90</span>)</span><br><span class="line">		s += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">turnCall</span>(<span class="params">s, e, h</span>):</span></span><br><span class="line">	<span class="comment"># nop掉call之前的值</span></span><br><span class="line">	nop(s, e)</span><br><span class="line">	patch_byte(e, <span class="number">0xE8</span>)</span><br><span class="line">	<span class="comment"># 把后面的花指令去掉 重新计算去花长度</span></span><br><span class="line">	huaStart = next_head(e)</span><br><span class="line">	huaEnd = h</span><br><span class="line">	nop(huaStart, huaEnd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">turnRetn</span>(<span class="params">s, e</span>):</span></span><br><span class="line">	nop(s, e)</span><br><span class="line">	<span class="comment"># 注意原来是jmp xxx</span></span><br><span class="line">	<span class="comment"># 所以前面nop掉一个 后面改成retn</span></span><br><span class="line">	patch_byte(e, <span class="number">0x90</span>)</span><br><span class="line">	patch_byte(e + <span class="number">1</span>, <span class="number">0xC3</span>)</span><br><span class="line"></span><br><span class="line">p = start</span><br><span class="line"><span class="keyword">while</span> p &lt; end:</span><br><span class="line">	address[<span class="number">0</span>] = p</span><br><span class="line">	address[<span class="number">1</span>] = next_head(p)</span><br><span class="line">	address[<span class="number">2</span>] = next_head(address[<span class="number">1</span>])</span><br><span class="line">	address[<span class="number">3</span>] = next_head(address[<span class="number">2</span>])</span><br><span class="line">	address[<span class="number">4</span>] = next_head(address[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">4</span>):</span><br><span class="line">		<span class="keyword">if</span> print_insn_mnem(address[i]) != callTarget[i]:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		turnCall(address[<span class="number">0</span>], address[<span class="number">3</span>], get_operand_value(address[<span class="number">1</span>], <span class="number">1</span>))</span><br><span class="line">		p = next_head(next_head(address[<span class="number">3</span>]))</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">5</span>):</span><br><span class="line">		<span class="keyword">if</span> print_insn_mnem(address[i]) != retnTarget[i]:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		turnRetn(address[<span class="number">0</span>], address[<span class="number">4</span>])</span><br><span class="line">		p = next_head(next_head(address[<span class="number">4</span>]))</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">	p = next_head(p)</span><br></pre></td></tr></table></figure>



<h1 id="tttree"><a href="#tttree" class="headerlink" title="tttree"></a>tttree</h1><p>还没去明白的一个花，SUSCTF2022的该题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">start = <span class="number">0x140001000</span></span><br><span class="line">end = <span class="number">0x14001C694</span></span><br><span class="line"></span><br><span class="line">address_m = [<span class="number">0</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>)]</span><br><span class="line">address_target = [<span class="string">&#x27;push    rax&#x27;</span>,<span class="string">&#x27;push    rax&#x27;</span>,<span class="string">&#x27;pushfq&#x27;</span>,<span class="string">&#x27;call    $+5&#x27;</span>,<span class="string">&#x27;pop     rax&#x27;</span>,<span class="string">&#x27;add     rax,&#x27;</span>,<span class="string">&#x27;mov     &#x27;</span>,<span class="string">&#x27;popfq&#x27;</span>,<span class="string">&#x27;pop     rax&#x27;</span>,<span class="string">&#x27;retn&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check1</span>():</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">5</span> <span class="keyword">or</span> i == <span class="number">6</span>:</span><br><span class="line">            cnt += GetDisasm(address_m[i]).find(address_target[i]) != -<span class="number">1</span> <span class="comment"># 找不到就是返回-1了</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cnt += GetDisasm(address_m[i]) == address_target[i]</span><br><span class="line">    <span class="keyword">return</span> cnt == <span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check2</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    cnt += print_insn_mnem(x) == <span class="string">&quot;push&quot;</span></span><br><span class="line">    cnt += print_insn_mnem(y) == <span class="string">&quot;pop&quot;</span></span><br><span class="line">    cnt += print_operand(x,<span class="number">0</span>) == print_operand(y,<span class="number">0</span>) <span class="comment"># print_operand获取操作数    </span></span><br><span class="line">    <span class="keyword">return</span> cnt == <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check3</span>():</span> <span class="comment"># 如果 push 的是一个立即数</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    cnt += print_insn_mnem(address_m[<span class="number">0</span>]) == <span class="string">&quot;push&quot;</span></span><br><span class="line">    cnt += get_operand_type(address_m[<span class="number">0</span>], <span class="number">0</span>) == o_imm</span><br><span class="line">    <span class="keyword">return</span> cnt == <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop</span>(<span class="params">u,v</span>):</span></span><br><span class="line">    patch_add = u</span><br><span class="line">    <span class="keyword">while</span>(patch_add &lt; v):</span><br><span class="line">        patch_byte(patch_add,<span class="number">0x90</span>) </span><br><span class="line">        patch_add += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">p = start</span><br><span class="line"><span class="keyword">while</span> p &lt;= end:</span><br><span class="line">    address_m[<span class="number">0</span>] = p</span><br><span class="line">    p = next_head(p) <span class="comment"># next_head取当前指令的下条指令地址</span></span><br><span class="line">    <span class="keyword">while</span> print_insn_mnem(p) == <span class="string">&quot;nop&quot;</span>: <span class="comment"># print_insn_mnem获取指定地址的助记符</span></span><br><span class="line">        p = next_head(p)</span><br><span class="line">    <span class="keyword">if</span> check2(address_m[<span class="number">0</span>],p) == <span class="number">1</span>: <span class="comment"># 这段就是把混淆2去掉</span></span><br><span class="line">        p = next_head(p)</span><br><span class="line">        nop(address_m[<span class="number">0</span>],p)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = address_m[<span class="number">0</span>]</span><br><span class="line">    address_m[<span class="number">0</span>] = p</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>):</span><br><span class="line">        address_m[i] = next_head(address_m[i-<span class="number">1</span>]) <span class="comment"># 放入数组的下一条地址 也就是混淆1形式的九条指令 加形式之外的一条</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> check1() == <span class="number">1</span>:</span><br><span class="line">        addri = get_operand_value(address_m[<span class="number">5</span>], <span class="number">1</span>)</span><br><span class="line">        addri += address_m[<span class="number">4</span>] <span class="comment"># 算出要跳转的绝对地址</span></span><br><span class="line">        <span class="keyword">if</span> address_target[<span class="number">9</span>] == GetDisasm(address_m[<span class="number">9</span>]):</span><br><span class="line">            addri -= (address_m[<span class="number">0</span>] + <span class="number">5</span>) <span class="comment"># 算出相对第一条指令的相对地址</span></span><br><span class="line">            patch_byte(address_m[<span class="number">0</span>],<span class="number">0xE9</span>)</span><br><span class="line">            patch_dword(address_m[<span class="number">0</span>]+<span class="number">1</span>,addri &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">            nop(address_m[<span class="number">0</span>]+<span class="number">5</span>,address_m[<span class="number">10</span>])</span><br><span class="line">            p = address_m[<span class="number">10</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            patch_byte(address_m[<span class="number">0</span>],<span class="number">0x68</span>) <span class="comment"># 还有一种形式就是push一个值</span></span><br><span class="line">            patch_dword(address_m[<span class="number">0</span>]+<span class="number">1</span>,addri &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">            nop(address_m[<span class="number">0</span>]+<span class="number">5</span>,address_m[<span class="number">9</span>])</span><br><span class="line">            p = address_m[<span class="number">9</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = address_m[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">p = start</span><br><span class="line"><span class="keyword">while</span> p &lt;= end:   </span><br><span class="line">    address_m[<span class="number">0</span>] = p</span><br><span class="line">    address_m[<span class="number">1</span>] = next_head(p)</span><br><span class="line">    <span class="keyword">if</span> check3() == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(address_m[<span class="number">0</span>]))</span><br><span class="line">        addri = get_operand_value(address_m[<span class="number">0</span>], <span class="number">0</span>) + <span class="number">2</span> ** <span class="number">32</span></span><br><span class="line">        p = address_m[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">while</span> print_insn_mnem(p) == <span class="string">&quot;nop&quot;</span>:</span><br><span class="line">            p += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> print_insn_mnem(p) == <span class="string">&quot;jmp&quot;</span>:</span><br><span class="line">            addrj = struct.unpack(<span class="string">&#x27;&lt;I&#x27;</span>, get_bytes(p + <span class="number">1</span>, <span class="number">4</span>))[<span class="number">0</span>] + p - address_m[<span class="number">0</span>]</span><br><span class="line">            addri -= p + <span class="number">5</span></span><br><span class="line">            <span class="keyword">if</span> addri &lt; <span class="number">0</span>:</span><br><span class="line">                addri += <span class="number">2</span> ** <span class="number">32</span></span><br><span class="line">            patch_byte(address_m[<span class="number">0</span>], <span class="number">0xe8</span>)</span><br><span class="line">            patch_dword(address_m[<span class="number">0</span>]+<span class="number">1</span>, addrj &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">            patch_byte(p, <span class="number">0xe9</span>)</span><br><span class="line">            p += <span class="number">1</span></span><br><span class="line">            patch_dword(p, addri)</span><br><span class="line">            p += <span class="number">4</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = address_m[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Finish&quot;</span>)</span><br></pre></td></tr></table></figure>


    </div>

    <p style= "text-align:center">
        让我看看我被读了 
    <b><span id="/2022/09/14/IDApython-LEARNING/" class="waline-visitor-count"/>...</b> 次呢🎉</p>
    
    <div id = "frozen-btn" class = "center">
    <!-- <button class="green" onclick = "Change()">🎉☕一杯咖啡~</button> -->
    <button class="purple" onclick = "Change()">🍰</button>
    </div>
    
    <div class = "hide" id = "img">
        <div class="post-list">
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/AliPay.png" alt="DASCTF X SU">
                    <div class="center">
                        支付宝
                    </div>
                </div>
            </article>
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/WeChat.png" alt="HFCTF2022">
                    <div class="center">
                        微信
                    </div>
                </div>
            </article>
        </div>
    </div>
    <script>
            function Change()
            {
                var img = document.getElementById("img");
                if(img.className == "hide")
                {
                    img.className="";
                }
                else
                {
                    img.className="hide";
                }
            }
    </script>

    <div class="about">
        <h1>About this Post</h1>
        <p>This post is written by P.Z, licensed under <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>
    <!-- 
        
     -->
<div class="container">
<div id="waline"></div>
  <script>
    Waline({
      el: '#waline',
      serverURL: 'https://blog-api-5rvxh62nz-pozeep.vercel.app/',  
      visitor: true,
      emoji: [   //这里加了一些表情 
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba',
      ],
       avatar: 'robohash',   //自定义默认头像为随机的机器人
       placeholder: '评论什么好呢',   //占位符
    });
  </script>
</div>

<!-- <span id="/2022/09/14/IDApython-LEARNING/" class="leancloud_visitors" data-flag-title="IDApython LEARNING">
    <em class="post-meta-item-text">阅读量 </em>
    <i class="waline-visitor-count"></i>
</span> -->

</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Home</a>
                
                <a href="/Diary/Diary.html" class="item">Diary</a>
                
                <a href="/Friends/Friends.html" class="item">Friends</a>
                
                <a href="/CTF/CTF.html" class="item">CTF</a>
                
                <a href="/Book/Book.html" class="item">Book</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/PoZeep" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/39892350" class="item">BiliBili</a>
                
            </div>
            
        </div>
        <span>&copy; 2022 P.Z<br >Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
        
    <span id="sitetime" style="text-align: center;display:block;"></span>


</footer>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 12, 27, 12, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "我已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了*/
    siteTime();
</script>

<!-- 在线通讯Tidio -->

<script src="//code.tidio.co/zmdcv08a6racnaer2so7xybdwby41fsa.js"></script>



        
<script src="/js/main.js"></script>

        
    </body>
</html>