<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>QWB2022-GameMaster &amp; EasyRe - P.Z&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

    <script src='//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'></script>

<meta name="generator" content="Hexo 6.0.0"></head>

<!-- //unpkg.com/@waline/client -->
<!--  -->
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">P.Z&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/Diary/Diary">Diary</a>
            
            
            
            <a class="nav-item" href="/Friends/Friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Book/Book">Book</a>
            
            
            
            <a class="nav-item" href="/Sundry/Sundry">Sundry</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/PoZeep" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://space.bilibili.com/39892350" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            
            <span>August</span>
            
            
            
            
            
            <span>3,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">QWB2022-GameMaster &amp; EasyRe</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>应该是今年在家的最后一天了，暑假结束了呜呜呜呜呜呜。–2022 8.3 23:06</p>
<h1 id="GameMaster"><a href="#GameMaster" class="headerlink" title="GameMaster"></a>GameMaster</h1><h2 id="0x00-Daily-Shell-Check"><a href="#0x00-Daily-Shell-Check" class="headerlink" title="0x00 Daily Shell Check"></a>0x00 Daily Shell Check</h2><p>无壳32位 .NET 程序，拉进dnspy32</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803230750970.png" alt="image-20220803230750970"></p>
<p><del>双击程序，用20块赢到2000万</del></p>
<h2 id="0x01-Analyze"><a href="#0x01-Analyze" class="headerlink" title="0x01 Analyze"></a>0x01 Analyze</h2><p>程序有亿点长，但其实关注关键位置就好了</p>
<p>首先比较在意的是 gamemessage 这个附件，这个大小估计就是加密的什么文件，而且在 BlackjackConsole.exe 用到了这个文件</p>
<p>注意存储到了 Program.memory</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803231200988.png" alt="image-20220803231200988"></p>
<p>随后就是一排按键的不同效果，有趣的是当我们按 esc 的时候会有个特殊操作</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803231437213.png" alt="image-20220803231437213"></p>
<p>在这个 verifyCode 又调用了 goldFunc，调用测试发现，按我们输入这些字符串再按 ESC 就是这个input</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803231525287.png" alt="image-20220803231525287"></p>
<p>而在长长的 goldFunc 中有三个值得注意的 AchivePoint，对我们的 gamemessage 存储的东西进行了操作</p>
<p>（第三个没有，就不截图了）</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803231723399.png" alt="image-20220803231723399"></p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803231808014.png" alt="image-20220803231808014"></p>
<p>然而我并不会动调取（呜呜呜有谁来教教我）</p>
<p>因为只是异或和AES解密，直接手动来好了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;gamemessage&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line">dataArr = [t <span class="keyword">for</span> t <span class="keyword">in</span> data]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dataArr)):</span><br><span class="line">    dataArr[i] ^= <span class="number">34</span></span><br><span class="line">data = <span class="built_in">bytes</span>(dataArr)</span><br><span class="line"></span><br><span class="line">key = [<span class="number">66</span>,<span class="number">114</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">115</span>,<span class="number">116</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">109</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">103</span>,<span class="number">33</span>,<span class="number">33</span>,<span class="number">33</span>]</span><br><span class="line">key = <span class="built_in">bytes</span>(key)</span><br><span class="line"></span><br><span class="line">cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line">p = cipher.decrypt(data)</span><br><span class="line"><span class="comment"># print(p)</span></span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;DEC.exe&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(p)</span><br></pre></td></tr></table></figure>



<h2 id="0x02-GameMessage"><a href="#0x02-GameMessage" class="headerlink" title="0x02 GameMessage"></a>0x02 GameMessage</h2><p>写出来的文件，拉进010，往下找MZ，把上面都删掉</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803232306264.png" alt="image-20220803232306264"></p>
<p>再次拉进dnspy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Windows.Forms;</span><br><span class="line"></span><br><span class="line">namespace T1Class</span><br><span class="line">&#123;</span><br><span class="line">	// Token: 0x02000002 RID: 2</span><br><span class="line">	public class T1</span><br><span class="line">	&#123;</span><br><span class="line">		// Token: 0x06000001 RID: 1 RVA: 0x00002050 File Offset: 0x00000250</span><br><span class="line">		private static void Check1(ulong x, ulong y, ulong z, byte[] KeyStream)</span><br><span class="line">		&#123;</span><br><span class="line">			int num = -1;</span><br><span class="line">			for (int i = 0; i &lt; 320; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				x = (((x &gt;&gt; 29 ^ x &gt;&gt; 28 ^ x &gt;&gt; 25 ^ x &gt;&gt; 23) &amp; 1UL) | x &lt;&lt; 1);</span><br><span class="line">				y = (((y &gt;&gt; 30 ^ y &gt;&gt; 27) &amp; 1UL) | y &lt;&lt; 1);</span><br><span class="line">				z = (((z &gt;&gt; 31 ^ z &gt;&gt; 30 ^ z &gt;&gt; 29 ^ z &gt;&gt; 28 ^ z &gt;&gt; 26 ^ z &gt;&gt; 24) &amp; 1UL) | z &lt;&lt; 1);</span><br><span class="line">				bool flag = i % 8 == 0;</span><br><span class="line">				if (flag)</span><br><span class="line">				&#123;</span><br><span class="line">					num++;</span><br><span class="line">				&#125;</span><br><span class="line">				KeyStream[num] = (byte)((long)((long)KeyStream[num] &lt;&lt; 1) | (long)((ulong)((uint)((z &gt;&gt; 32 &amp; 1UL &amp; (x &gt;&gt; 30 &amp; 1UL)) ^ (((z &gt;&gt; 32 &amp; 1UL) ^ 1UL) &amp; (y &gt;&gt; 31 &amp; 1UL))))));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Token: 0x06000002 RID: 2 RVA: 0x00002110 File Offset: 0x00000310</span><br><span class="line">		private static void ParseKey(ulong[] L, byte[] Key)</span><br><span class="line">		&#123;</span><br><span class="line">			for (int i = 0; i &lt; 3; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				for (int j = 0; j &lt; 4; j++)</span><br><span class="line">				&#123;</span><br><span class="line">					Key[i * 4 + j] = (byte)(L[i] &gt;&gt; j * 8 &amp; 255UL);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Token: 0x06000003 RID: 3 RVA: 0x0000215C File Offset: 0x0000035C</span><br><span class="line">		public T1()</span><br><span class="line">		&#123;</span><br><span class="line">			try</span><br><span class="line">			&#123;</span><br><span class="line">				string environmentVariable = Environment.GetEnvironmentVariable(&quot;AchivePoint1&quot;);</span><br><span class="line">				string environmentVariable2 = Environment.GetEnvironmentVariable(&quot;AchivePoint2&quot;);</span><br><span class="line">				string environmentVariable3 = Environment.GetEnvironmentVariable(&quot;AchivePoint3&quot;);</span><br><span class="line">				bool flag = environmentVariable == null || environmentVariable2 == null || environmentVariable3 == null;</span><br><span class="line">				if (!flag)</span><br><span class="line">				&#123;</span><br><span class="line">					ulong num = ulong.Parse(environmentVariable);</span><br><span class="line">					ulong num2 = ulong.Parse(environmentVariable2);</span><br><span class="line">					ulong num3 = ulong.Parse(environmentVariable3);</span><br><span class="line">					ulong[] array = new ulong[3];</span><br><span class="line">					byte[] array2 = new byte[40];</span><br><span class="line">					byte[] array3 = new byte[40];</span><br><span class="line">					byte[] array4 = new byte[12];</span><br><span class="line">					byte[] first = new byte[]</span><br><span class="line">					&#123;</span><br><span class="line">						101,</span><br><span class="line">						5,</span><br><span class="line">						80,</span><br><span class="line">						213,</span><br><span class="line">						163,</span><br><span class="line">						26,</span><br><span class="line">						59,</span><br><span class="line">						38,</span><br><span class="line">						19,</span><br><span class="line">						6,</span><br><span class="line">						173,</span><br><span class="line">						189,</span><br><span class="line">						198,</span><br><span class="line">						166,</span><br><span class="line">						140,</span><br><span class="line">						183,</span><br><span class="line">						42,</span><br><span class="line">						247,</span><br><span class="line">						223,</span><br><span class="line">						24,</span><br><span class="line">						106,</span><br><span class="line">						20,</span><br><span class="line">						145,</span><br><span class="line">						37,</span><br><span class="line">						24,</span><br><span class="line">						7,</span><br><span class="line">						22,</span><br><span class="line">						191,</span><br><span class="line">						110,</span><br><span class="line">						179,</span><br><span class="line">						227,</span><br><span class="line">						5,</span><br><span class="line">						62,</span><br><span class="line">						9,</span><br><span class="line">						13,</span><br><span class="line">						17,</span><br><span class="line">						65,</span><br><span class="line">						22,</span><br><span class="line">						37,</span><br><span class="line">						5</span><br><span class="line">					&#125;;</span><br><span class="line">					byte[] array5 = new byte[]</span><br><span class="line">					&#123;</span><br><span class="line">						60,</span><br><span class="line">						100,</span><br><span class="line">						36,</span><br><span class="line">						86,</span><br><span class="line">						51,</span><br><span class="line">						251,</span><br><span class="line">						167,</span><br><span class="line">						108,</span><br><span class="line">						116,</span><br><span class="line">						245,</span><br><span class="line">						207,</span><br><span class="line">						223,</span><br><span class="line">						40,</span><br><span class="line">						103,</span><br><span class="line">						34,</span><br><span class="line">						62,</span><br><span class="line">						22,</span><br><span class="line">						251,</span><br><span class="line">						227</span><br><span class="line">					&#125;;</span><br><span class="line">					array[0] = num;</span><br><span class="line">					array[1] = num2;</span><br><span class="line">					array[2] = num3;</span><br><span class="line">					T1.Check1(array[0], array[1], array[2], array2);</span><br><span class="line">					bool flag2 = first.SequenceEqual(array2);</span><br><span class="line">					if (flag2)</span><br><span class="line">					&#123;</span><br><span class="line">						T1.ParseKey(array, array4);</span><br><span class="line">						for (int i = 0; i &lt; array5.Length; i++)</span><br><span class="line">						&#123;</span><br><span class="line">							array5[i] ^= array4[i % array4.Length];</span><br><span class="line">						&#125;</span><br><span class="line">						MessageBox.Show(&quot;flag&#123;&quot; + Encoding.Default.GetString(array5) + &quot;&#125;&quot;, &quot;Congratulations!&quot;, MessageBoxButtons.OK);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception)</span><br><span class="line">			&#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现3个环境变量不知（变量就是我们的存储的金额，打到正确的金额就是我们的flag），其他值都是已知的，然而这个check手逆有点麻，直接上Z3</p>
<h2 id="0x03-GetFlag"><a href="#0x03-GetFlag" class="headerlink" title="0x03 GetFlag!"></a>0x03 GetFlag!</h2><p>算法照抄即可，这一个个换行的数据强迫症患者表示很难受</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">enc = [<span class="number">101</span>, <span class="number">5</span>, <span class="number">80</span>, <span class="number">213</span>, <span class="number">163</span>, <span class="number">26</span>, <span class="number">59</span>, <span class="number">38</span>, <span class="number">19</span>,</span><br><span class="line"><span class="number">6</span>,</span><br><span class="line"><span class="number">173</span>,</span><br><span class="line"><span class="number">189</span>,</span><br><span class="line"><span class="number">198</span>,</span><br><span class="line"><span class="number">166</span>,</span><br><span class="line"><span class="number">140</span>,</span><br><span class="line"><span class="number">183</span>,</span><br><span class="line"><span class="number">42</span>,</span><br><span class="line"><span class="number">247</span>,</span><br><span class="line"><span class="number">223</span>,</span><br><span class="line"><span class="number">24</span>,</span><br><span class="line"><span class="number">106</span>,</span><br><span class="line"><span class="number">20</span>,</span><br><span class="line"><span class="number">145</span>,</span><br><span class="line"><span class="number">37</span>,</span><br><span class="line"><span class="number">24</span>,</span><br><span class="line"><span class="number">7</span>,</span><br><span class="line"><span class="number">22</span>,</span><br><span class="line"><span class="number">191</span>,</span><br><span class="line"><span class="number">110</span>,</span><br><span class="line"><span class="number">179</span>,</span><br><span class="line"><span class="number">227</span>,</span><br><span class="line"><span class="number">5</span>,</span><br><span class="line"><span class="number">62</span>,</span><br><span class="line"><span class="number">9</span>,</span><br><span class="line"><span class="number">13</span>,</span><br><span class="line"><span class="number">17</span>,</span><br><span class="line"><span class="number">65</span>,</span><br><span class="line"><span class="number">22</span>,</span><br><span class="line"><span class="number">37</span>,</span><br><span class="line"><span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">num = -<span class="number">1</span></span><br><span class="line">sol = Solver()</span><br><span class="line">xx = BitVec(<span class="string">&#x27;xx&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">yy = BitVec(<span class="string">&#x27;yy&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">zz = BitVec(<span class="string">&#x27;zz&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">key = [BitVec(<span class="string">&#x27;key%d&#x27;</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc))]</span><br><span class="line"></span><br><span class="line">x = xx</span><br><span class="line">y = yy</span><br><span class="line">z = zz</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">320</span>):</span><br><span class="line">    x = (((x &gt;&gt; <span class="number">29</span> ^ x &gt;&gt; <span class="number">28</span> ^ x &gt;&gt; <span class="number">25</span> ^ x &gt;&gt; <span class="number">23</span>) &amp; <span class="number">1</span>) | x &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    y = (((y &gt;&gt; <span class="number">30</span> ^ y &gt;&gt; <span class="number">27</span>) &amp; <span class="number">1</span>) | y &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    z = (((z &gt;&gt; <span class="number">31</span> ^ z &gt;&gt; <span class="number">30</span> ^ z &gt;&gt; <span class="number">29</span> ^ z &gt;&gt; <span class="number">28</span> ^ z &gt;&gt; <span class="number">26</span> ^ z &gt;&gt; <span class="number">24</span>) &amp; <span class="number">1</span>) | z &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> ( i % <span class="number">8</span> == <span class="number">0</span> ):    </span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        key[num] = ZeroExt(<span class="number">56</span>, key[num])</span><br><span class="line">    key[num] = ((key[num] &lt;&lt; <span class="number">1</span>) | ( (z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span> &amp; (x &gt;&gt; <span class="number">30</span> &amp; <span class="number">1</span>)) ^ (((z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span>) ^ <span class="number">1</span>) &amp; (y &gt;&gt; <span class="number">31</span> &amp; <span class="number">1</span>)))) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    sol.add(key[i] == enc[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> sol.check() == sat</span><br><span class="line">ans = sol.model()</span><br><span class="line"></span><br><span class="line">s = [ans[xx].as_long(), ans[yy].as_long(), ans[zz].as_long()] </span><br><span class="line">k = [<span class="number">0</span>] * <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetData</span>(<span class="params">s, k</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            k[i * <span class="number">4</span> + j] = (s[i] &gt;&gt; j * <span class="number">8</span> &amp; <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">GetData(s, k)</span><br><span class="line">data = [<span class="number">60</span>,</span><br><span class="line">						<span class="number">100</span>,</span><br><span class="line">						<span class="number">36</span>,</span><br><span class="line">						<span class="number">86</span>,</span><br><span class="line">						<span class="number">51</span>,</span><br><span class="line">						<span class="number">251</span>,</span><br><span class="line">						<span class="number">167</span>,</span><br><span class="line">						<span class="number">108</span>,</span><br><span class="line">						<span class="number">116</span>,</span><br><span class="line">						<span class="number">245</span>,</span><br><span class="line">						<span class="number">207</span>,</span><br><span class="line">						<span class="number">223</span>,</span><br><span class="line">						<span class="number">40</span>,</span><br><span class="line">						<span class="number">103</span>,</span><br><span class="line">						<span class="number">34</span>,</span><br><span class="line">						<span class="number">62</span>,</span><br><span class="line">						<span class="number">22</span>,</span><br><span class="line">						<span class="number">251</span>,</span><br><span class="line">						<span class="number">227</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(data[i] ^ k[i % <span class="built_in">len</span>(k)]), end = <span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>GetFlag!</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803234233024.png" alt="image-20220803234233024"></p>
<h1 id="EasyRe"><a href="#EasyRe" class="headerlink" title="EasyRe"></a>EasyRe</h1><h2 id="0x00-Daily-Shell-Check-1"><a href="#0x00-Daily-Shell-Check-1" class="headerlink" title="0x00 Daily Shell Check"></a>0x00 Daily Shell Check</h2><p>无壳64位</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803235131091.png" alt="image-20220803235131091"></p>
<h2 id="0x01-Analyze-EasyRe"><a href="#0x01-Analyze-EasyRe" class="headerlink" title="0x01 Analyze EasyRe"></a>0x01 Analyze EasyRe</h2><p>先把finger恢复符号表，然后看我们的主函数</p>
<h3 id="MAIN"><a href="#MAIN" class="headerlink" title="MAIN"></a>MAIN</h3><p>fork函数在主进程返回的是子进程的PID，在子进程返回的是0</p>
<ul>
<li>所以在主进程我们会进入 if 分支</li>
<li>在子进程会进入 else 分支</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> v3; <span class="comment">// xmm0_8</span></span><br><span class="line">  <span class="keyword">double</span> v4; <span class="comment">// xmm1_8</span></span><br><span class="line">  <span class="keyword">double</span> v5; <span class="comment">// xmm2_8</span></span><br><span class="line">  <span class="keyword">double</span> v6; <span class="comment">// xmm3_8</span></span><br><span class="line">  <span class="keyword">double</span> v7; <span class="comment">// xmm6_8</span></span><br><span class="line">  <span class="keyword">double</span> v8; <span class="comment">// xmm7_8</span></span><br><span class="line">  __int64 v9; <span class="comment">// r8</span></span><br><span class="line">  __int64 v10; <span class="comment">// r9</span></span><br><span class="line">  <span class="keyword">double</span> v11; <span class="comment">// xmm4_8</span></span><br><span class="line">  <span class="keyword">double</span> v12; <span class="comment">// xmm5_8</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v15; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  openRe3();</span><br><span class="line">  v15 = fork();                                 <span class="comment">// 返回子进程ID</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( v15 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_401F2F(v15);</span><br><span class="line">    remove(<span class="string">&quot;re3&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sys_ptrace(PTRACE_TRACEME, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, v9, v10, argv);</span><br><span class="line">    sub_44B680(<span class="string">&quot;re3&quot;</span>, <span class="string">&quot;re3&quot;</span>, v3, v4, v5, v6, v11, v12, v7, v8, *(v14 + <span class="number">8</span>), <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="401F2F"><a href="#401F2F" class="headerlink" title="401F2F"></a>401F2F</h3><p>而主进程与子进程通信与控制主要通过 ptrace 函数，可以看看这篇</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-265924.htm#msg_header_h2_1">https://bbs.pediy.com/thread-265924.htm#msg_header_h2_1</a></p>
</blockquote>
<p>函数原型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> ptrace（<span class="class"><span class="keyword">enum</span> _<span class="title">ptrace_request</span> <span class="title">request</span>,<span class="title">pid_t</span> <span class="title">pid</span>,<span class="title">void</span> * <span class="title">addr</span> ,<span class="title">void</span> *<span class="title">data</span>）;</span></span><br></pre></td></tr></table></figure>

<p>ptrace最重要的就是第一个参数，借用该文中的图</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220803235602533.png" alt="image-20220803235602533"></p>
<p>光标在第一个参数上按M，搜索 ptrace，即可方便审计</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220804000116267.png" alt="image-20220804000116267"></p>
<p>于是阅读可知，也可以直接动调更清楚数据的走向，因为部分变量是结构体的原因其实F5的代码并不能直接确定</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_401F2F</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> Pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  sys_wait(Pid, <span class="number">0LL</span>, <span class="number">0</span>);                        <span class="comment">// 等待子进程来信号</span></span><br><span class="line">  sys_ptrace(PTRACE_CONT, Pid, <span class="number">0LL</span>, <span class="number">0LL</span>, v1, v2, v20);<span class="comment">// 重新运行</span></span><br><span class="line">  some = f1(Pid, Pid, v3, v4, v5, v6);</span><br><span class="line">  len = sub_4017E5();                           <span class="comment">// 将一组数据调整完存放到arr</span></span><br><span class="line">  arr = v8;</span><br><span class="line">  len1 = len;</span><br><span class="line">  v25 = v8;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v26 = <span class="number">0</span>;</span><br><span class="line">    sys_wait(Pid, &amp;v26, <span class="number">0</span>);</span><br><span class="line">    arr = v26 &amp; <span class="number">0x7F</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (v26 &amp; <span class="number">0x7F</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    sys_ptrace(PTRACE_GETREGS, Pid, <span class="number">0LL</span>, context, v10, v11, v21);<span class="comment">// 复制通用寄存器</span></span><br><span class="line">    exAddr = v28 - <span class="number">1</span>;</span><br><span class="line">    childData = sys_ptrace(PTRACE_PEEKTEXT, Pid, v28 - <span class="number">1</span>, <span class="number">0LL</span>, v12, v13, v22);<span class="comment">// 读取子进程的数据</span></span><br><span class="line">    <span class="keyword">if</span> ( childData == <span class="number">0xCAFEB055BFCC</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      v33 = exAddr;</span><br><span class="line">      SMC(Pid, exAddr, some, len1, v25, v15);</span><br><span class="line">      v28 = exAddr + <span class="number">10</span>;</span><br><span class="line">      sys_ptrace(PTRACE_SETREGS, Pid, <span class="number">0LL</span>, context, v16, v17, v23);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( childData == <span class="number">0xCAFE1055BFCC</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      RESMC(Pid, v33, exAddr, some, len1, v25);</span><br><span class="line">      v28 = exAddr + <span class="number">10</span>;</span><br><span class="line">      sys_ptrace(PTRACE_SETREGS, Pid, <span class="number">0LL</span>, context, v18, v19, v23);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    arr = sys_ptrace(PTRACE_CONT, Pid, <span class="number">0LL</span>, <span class="number">0LL</span>, v14, v15, v23);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么目前，对该函数的认识有 </p>
<ul>
<li><p>4017E5 有一些有趣的数据</p>
</li>
<li><p>for 循环中 wait 函数等待子进程发送信号，主进程进行一些操作 </p>
</li>
</ul>
<h2 id="0x02-RE3"><a href="#0x02-RE3" class="headerlink" title="0x02 RE3"></a>0x02 RE3</h2><p>找到 start 函数，对未定义的数据按C，再对start函数开头按p，恢复后找到main函数，熟悉的setjmp longjmp，梦回*CTF</p>
<p>那么我们可以获得的信息是</p>
<ul>
<li>在 AdjustInput 我们的输入为 0101001 组成并存储到一个25x25的二维数组</li>
<li>再到 RecordData 处理，但是该函数没法成型，不过有两个 int 3</li>
<li>下面的longjmp setjmp 相当于一个循环，测试我们经过 RecordData 里的值<ul>
<li>savedregs + 25 * v13 + v11 - 0x28F 相当于lineData的地址</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  v14 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( argc != <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  AdjustInput(argv[<span class="number">1</span>]);</span><br><span class="line">  RecordData(inputArr, lineData, colData);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  v13 = _setjmp(env);</span><br><span class="line">  <span class="keyword">if</span> ( v13 &lt;= <span class="number">24</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = _setjmp(v5);</span><br><span class="line">    <span class="keyword">if</span> ( v11 &lt; byte_50A0[<span class="number">25</span> * v13] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( byte_50A0[<span class="number">25</span> * v13 + <span class="number">1</span> + v11] != *(&amp;savedregs + <span class="number">25</span> * v13 + v11 - <span class="number">0x28F</span>) )<span class="comment">// 比较行</span></span><br><span class="line">        v14 = <span class="number">0</span>;</span><br><span class="line">      longjmp(v5, v11 + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    longjmp(env, v13 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  v12 = _setjmp(v6);</span><br><span class="line">  <span class="keyword">if</span> ( v12 &lt;= <span class="number">24</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = _setjmp(v7);</span><br><span class="line">    <span class="keyword">if</span> ( v10 &lt; byte_5320[<span class="number">25</span> * v12] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( byte_5320[<span class="number">25</span> * v12 + <span class="number">1</span> + v10] != *(&amp;savedregs + <span class="number">25</span> * v12 + v10 - <span class="number">0x50F</span>) )<span class="comment">// 比较列</span></span><br><span class="line">        v14 = <span class="number">0</span>;</span><br><span class="line">      longjmp(v7, v10 + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    longjmp(v6, v12 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v14 == <span class="number">1</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;GOOD JOB&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么关键就是这个 RecordData 函数到底发生什么事情了</p>
<ul>
<li>可以发现有个 int 3</li>
<li>同时下面的数据似曾相识，CAFEB055BF，这就是主进程进行比较的值</li>
<li>在函数末尾还有一处 int 3</li>
</ul>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220804002135047.png" alt="image-20220804002135047"></p>
<p>那么此时一个大概的想法就出来了</p>
<ol>
<li>主进程等待子进程运行</li>
<li>子进程除法int 3 等待主进程调试</li>
<li>主进程判断异常类型（这就是后面的值）</li>
<li>主进程进行 SMC 处理</li>
</ol>
<h2 id="0x03-SMC"><a href="#0x03-SMC" class="headerlink" title="0x03 SMC"></a>0x03 SMC</h2><p>那么我们该如何得到 SMC 后的文件呢，一种方法是直接逆SMC函数，另一种方法是动调获取</p>
<h3 id="Analyze-SMC"><a href="#Analyze-SMC" class="headerlink" title="Analyze SMC"></a>Analyze SMC</h3><p>通过调试（由于主子进程的关系IDA会报些错，直接全部YES即可）和静态分析可知</p>
<ul>
<li><p>sub_4017E5 函数里 fmemopen 的数据</p>
<ul>
<li>第一个值是子进程地址 第二个值是要异或的值但还没处理</li>
</ul>
</li>
</ul>
<p>该原始值进行MD5后，再从第8个字节取倒叙后和主进程的值异或</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220804003204202.png" alt="image-20220804003204202"></p>
<p>（由于准备录视频解题就不贴动调过程了 XD）</p>
<p>那么我们只要取出这异或的值，再手动 patch RE3即可</p>
<p>于是在异或的值下个断点，再右键Edit breakpoint，打印出来即可</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220804003418508.png" alt="image-20220804003418508"></p>
<p>于是去子进程 Shift + F2 选择 python，run 一下得到我们的正确文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xorKey = &#123;<span class="number">8723</span>: <span class="number">2533025110152939745</span>, <span class="number">8739</span>: <span class="number">5590097037203163468</span>, <span class="number">8755</span>: <span class="number">17414346542877855401</span>, <span class="number">8771</span>: <span class="number">17520503086133755340</span>, <span class="number">8787</span>: <span class="number">12492599841064285544</span>, <span class="number">8803</span>: <span class="number">12384833368350302160</span>, <span class="number">8819</span>: <span class="number">11956541642520230699</span>, <span class="number">8835</span>: <span class="number">12628929057681570616</span>, <span class="number">8851</span>: <span class="number">910654967627959011</span>, <span class="number">8867</span>: <span class="number">5684234031469876551</span>, <span class="number">8883</span>: <span class="number">6000358478182005051</span>, <span class="number">8899</span>: <span class="number">3341586462889168127</span>, <span class="number">8915</span>: <span class="number">11094889238442167020</span>, <span class="number">8931</span>: <span class="number">17237527861538956365</span>, <span class="number">8947</span>: <span class="number">17178915143649401084</span>, <span class="number">8963</span>: <span class="number">11176844209899222046</span>, <span class="number">8979</span>: <span class="number">18079493192679046363</span>, <span class="number">8995</span>: <span class="number">7090159446630928781</span>, <span class="number">9011</span>: <span class="number">863094436381699168</span>, <span class="number">9027</span>: <span class="number">6906972144372600884</span>, <span class="number">9043</span>: <span class="number">16780793948225765908</span>, <span class="number">9059</span>: <span class="number">7086655467811962655</span>, <span class="number">9075</span>: <span class="number">13977154540038163446</span>, <span class="number">9091</span>: <span class="number">7066662532691991888</span>, <span class="number">9107</span>: <span class="number">15157921356638311270</span>, <span class="number">9123</span>: <span class="number">12585839823593393444</span>, <span class="number">9139</span>: <span class="number">1360651393631625694</span>, <span class="number">9155</span>: <span class="number">2139328426318955142</span>, <span class="number">9171</span>: <span class="number">2478274715212481947</span>, <span class="number">9187</span>: <span class="number">12876028885252459748</span>, <span class="number">9203</span>: <span class="number">18132176846268847269</span>, <span class="number">9219</span>: <span class="number">17242441603067001509</span>, <span class="number">9235</span>: <span class="number">8492111998925944081</span>, <span class="number">9251</span>: <span class="number">14679986489201789069</span>, <span class="number">9267</span>: <span class="number">13188777131396593592</span>, <span class="number">9283</span>: <span class="number">5298970373130621883</span>, <span class="number">9299</span>: <span class="number">525902164359904478</span>, <span class="number">9315</span>: <span class="number">2117701741234018776</span>, <span class="number">9331</span>: <span class="number">9158760851580517972</span>&#125;</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x2213</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = get_qword(addr)</span><br><span class="line">    key = xorKey[addr]</span><br><span class="line">    dec = data ^ key</span><br><span class="line">    idc.patch_qword(addr, dec)</span><br><span class="line">    addr += <span class="number">16</span></span><br></pre></td></tr></table></figure>

<p>（再把异常数值类型 patch 成 nop 即可）</p>
<h3 id="Debugger-SMC"><a href="#Debugger-SMC" class="headerlink" title="Debugger SMC"></a>Debugger SMC</h3><p>这个思路出自 FallWind 师傅，只能说是曲线救国，太强了！</p>
<p>首先我们想 attach 我们修复后的子进程有几个困扰点</p>
<ul>
<li>主进程在调试中我们没法直接调试</li>
<li>在 401F2F 函数的处理的第二个 int 3 是把函数 SMC 回去（也就是又回到加密状态）</li>
<li>在 401F2F 函数的 for 循环为3，前两个是处理 int 3 第三个是等待子进程结束</li>
</ul>
<p>所以曲线救国的方法就是让主进程结束，子进程不结束</p>
<ol>
<li> patch EasyRe 的RE3资源文件，让在需要SMC的函数的结尾写个死循环</li>
<li> patch RESMC函数 的异或值为0，让主进程不再加密回去</li>
<li> patch 401F2F函数的 for 循环为2，这样主进程就不用等待子进程的结束值</li>
</ol>
<p>这样执行完主程序两个异常处理就结束，然而我们的子进程还卡着，IDA直接attach上</p>
<p>（一会还要录视频今天有点晚了，就先不贴了）</p>
<h2 id="0x04-GetFlag"><a href="#0x04-GetFlag" class="headerlink" title="0x04 GetFlag!"></a>0x04 GetFlag!</h2><p>恢复后的函数，一眼丁真这是数织游戏（事后才知道</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">sub_21F9</span><span class="params">(__int64 input, __int64 data1, __int64 data2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> offsett; <span class="comment">// [rsp+20h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> statee; <span class="comment">// [rsp+24h] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> count2; <span class="comment">// [rsp+28h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> jj; <span class="comment">// [rsp+2Ch] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [rsp+30h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> offset; <span class="comment">// [rsp+34h] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> state; <span class="comment">// [rsp+38h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> lineCount; <span class="comment">// [rsp+3Ch] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> ii; <span class="comment">// [rsp+40h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+44h] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">24</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    ii = <span class="number">0</span>;</span><br><span class="line">    lineCount = <span class="number">0</span>;</span><br><span class="line">    state = <span class="number">0</span>;</span><br><span class="line">    offset = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ( ii &lt;= <span class="number">24</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(<span class="number">25</span> * i + ii + input) )             <span class="comment">// 记录1的连续，设置状态值</span></span><br><span class="line">      &#123;</span><br><span class="line">        ++lineCount;</span><br><span class="line">        state = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( state )                            <span class="comment">// 出现0时保存1个个数</span></span><br><span class="line">        &#123;</span><br><span class="line">          *(data1 + <span class="number">25LL</span> * i + offset) = lineCount;</span><br><span class="line">          lineCount = <span class="number">0</span>;</span><br><span class="line">          ++offset;</span><br><span class="line">        &#125;</span><br><span class="line">        state = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( ++ii == <span class="number">25</span> &amp;&amp; state )                <span class="comment">// 行结尾是1，记录</span></span><br><span class="line">      &#123;</span><br><span class="line">        *(data1 + <span class="number">25LL</span> * i + offset) = lineCount;</span><br><span class="line">        lineCount = <span class="number">0</span>;</span><br><span class="line">        ++offset;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="number">25LL</span> * i + data1) = offset - <span class="number">1</span>;           <span class="comment">// 行的开头记录当前行的offset</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">24</span>; ++j )                   <span class="comment">// 记录列</span></span><br><span class="line">  &#123;</span><br><span class="line">    jj = <span class="number">0</span>;</span><br><span class="line">    count2 = <span class="number">0</span>;</span><br><span class="line">    statee = <span class="number">0</span>;</span><br><span class="line">    offsett = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ( jj &lt;= <span class="number">24</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(<span class="number">25</span> * jj + j + input) )</span><br><span class="line">      &#123;</span><br><span class="line">        ++count2;</span><br><span class="line">        statee = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( statee )</span><br><span class="line">        &#123;</span><br><span class="line">          *(data2 + <span class="number">25LL</span> * j + offsett) = count2;</span><br><span class="line">          count2 = <span class="number">0</span>;</span><br><span class="line">          ++offsett;</span><br><span class="line">        &#125;</span><br><span class="line">        statee = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( ++jj == <span class="number">25</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( statee )</span><br><span class="line">        &#123;</span><br><span class="line">          *(data2 + <span class="number">25LL</span> * j + offsett) = count2;</span><br><span class="line">          count2 = <span class="number">0</span>;</span><br><span class="line">          ++offsett;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="number">25LL</span> * j + data2) = offsett - <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是很明显我们RE3的主函数的对比数据不对，于是这时候就去init段还要个preinit段找</p>
<p>同样的手法是通过偏移来进行了混淆，手动计算即可，最后拿到真实数据</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220804005601281.png" alt="image-20220804005601281"></p>
<p>于是再去在线网站跑 <a target="_blank" rel="noopener" href="https://handsomeone.github.io/Nonogram/">https://handsomeone.github.io/Nonogram/</a></p>
<p>GetFlag!</p>
<p><img src="/2022/08/03/QWB2022-GameMaster-EasyRe/image-20220804005641970.png" alt="image-20220804005641970"></p>
<h1 id="Reference-Article"><a href="#Reference-Article" class="headerlink" title="Reference Article"></a>Reference Article</h1><blockquote>
<p><a target="_blank" rel="noopener" href="http://1.12.239.117:8090/archives/qwb2022-easyre">http://1.12.239.117:8090/archives/qwb2022-easyre</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.leanote.com/post/xp0int/2022-%E5%BC%BA%E7%BD%91%E6%9D%AF%E5%88%9D%E8%B5%9B-Writeup-By-Xp0int#title-4">http://blog.leanote.com/post/xp0int/2022-%E5%BC%BA%E7%BD%91%E6%9D%AF%E5%88%9D%E8%B5%9B-Writeup-By-Xp0int#title-4</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-265924.htm#msg_header_h2_1">https://bbs.pediy.com/thread-265924.htm#msg_header_h2_1</a></p>
</blockquote>

    </div>
    
    <div id = "frozen-btn" class = "center">
    <!-- <button class="green" onclick = "Change()">🎉☕一杯咖啡~</button> -->
    <button class="purple" onclick = "Change()">🍰</button>
    </div>
    
    <!-- <div class = "hide" id = "img">
        <div class="post-list">
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/AliPay.png" alt="DASCTF X SU">
                    <div class="center">
                        🍬
                    </div>
                </div>
            </article>
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/WeChat.png" alt="HFCTF2022">
                    <div class="center">
                        🍪
                    </div>
                </div>
            </article>
        </div>
    </div> -->
    <script>
            function Change()
            {
                var img = document.getElementById("img");
                if(img.className == "hide")
                {
                    img.className="";
                }
                else
                {
                    img.className="hide";
                }
            }
    </script>

    <div class="about">
        <h1>About this Post</h1>
        <p>This post is written by P.Z, licensed under <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>
    <!-- 
        
     -->
<div class="container">
<!-- <div id="waline"></div>
  <script>
    Waline({
      el: '#waline',
      serverURL: 'https://blog-api-pozeep.vercel.app/',  
      visitor: true,
      emoji: [   //这里加了一些表情 
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba',
      ],
       avatar: 'robohash',   //自定义默认头像为随机的机器人
       placeholder: '🍟🍰🧊🍔🍓🍫🍦🍗🍇🍉🍑🥐🍕',   //占位符
    });
  </script>
</div> -->

<!-- <span id="/2022/08/03/QWB2022-GameMaster-EasyRe/" class="leancloud_visitors" data-flag-title="QWB2022-GameMaster &amp; EasyRe">
    <em class="post-meta-item-text">阅读量 </em>
    <i class="waline-visitor-count"></i>
</span> -->

</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Home</a>
                
                <a href="/Diary/Diary.html" class="item">Diary</a>
                
                <a href="/Friends/Friends.html" class="item">Friends</a>
                
                <a href="/CTF/CTF.html" class="item">CTF</a>
                
                <a href="/Book/Book.html" class="item">Book</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/PoZeep" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/39892350" class="item">BiliBili</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 P.Z<br >Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
        
    <span id="sitetime" style="text-align: center;display:block;"></span>


</footer>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 12, 27, 12, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "我已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了*/
    siteTime();
</script>

<!-- 在线通讯Tidio -->

<script src="//code.tidio.co/zmdcv08a6racnaer2so7xybdwby41fsa.js"></script>



        
<script src="/js/main.js"></script>

        
    </body>
</html>