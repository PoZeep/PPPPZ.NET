<!DOCTYPE html>
<html lang="en">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>ACTF2022-Inflated - P.Z&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
    
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
 
  

    <script src='//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'></script>

<meta name="generator" content="Hexo 6.0.0"></head>

<!-- //unpkg.com/@waline/client -->
<!--  -->
    <body data-color-scheme="auto">
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">P.Z&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/Diary/Diary">Diary</a>
            
            
            
            <a class="nav-item" href="/Friends/Friends">Friends</a>
            
            
            
            <a class="nav-item" href="/CTF/CTF">CTF</a>
            
            
            
            <a class="nav-item" href="/Book/Book">Book</a>
            
            
            
            <a class="nav-item" href="/Sundry/Sundry">Sundry</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/PoZeep" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://space.bilibili.com/39892350" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            
            
            
            
            <span>July</span>
            
            
            
            
            
            
            <span>21,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">ACTF2022-Inflated</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="Inflated"><a href="#Inflated" class="headerlink" title="Inflated!!!"></a>Inflated!!!</h1><ol>
<li> C++异常化处理</li>
<li> OLLVM-控制流平坦化</li>
<li> Two Puzzles</li>
</ol>
<h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h2><p>一般碰到C++异常逆向，确定了异常分发、处理部分，直接把call throw改为jmp catch块，再F5即可</p>
<p>PS: 多个catch块根据rdx来当为异常处理数值决定哪个为对应的catch块</p>
<p>（关于以上，这篇讲的很详细）</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://4nsw3r.top/2022/02/03/SCTF-REVERSE-CplusExceptionEncrypt-%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%8E%B0/#Clang-x64">https://4nsw3r.top/2022/02/03/SCTF-REVERSE-CplusExceptionEncrypt-%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%8E%B0/#Clang-x64</a></p>
</blockquote>
<p>然而，这题没这么简单，套了个ollvm！？基于异常处理的ollvm，无论从哪个角度都没法使用之前的老套路</p>
<p>  耐心看完这两篇文章就会有所收获，对于此题的被异常处理搞乱掉的cfg就会有所理解</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/catch/p/3604516.html">https://www.cnblogs.com/catch/p/3604516.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/catch/p/3619379.html">https://www.cnblogs.com/catch/p/3619379.html</a></p>
</blockquote>
<h2 id="OLLVM"><a href="#OLLVM" class="headerlink" title="OLLVM"></a>OLLVM</h2><p>要是平常的ollvm都可以按照这篇来解决</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://bluesadi.github.io/0x401RevTrain-Tools/angr/10_%E5%88%A9%E7%94%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%8E%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/">https://bluesadi.github.io/0x401RevTrain-Tools/angr/10_%E5%88%A9%E7%94%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%8E%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/</a></p>
</blockquote>
<p>其他的原理讲的非常好，问题是这题并不是那么简单，但为了去ollvm我们的思路也是一样的，所以要对ollvm的cfg熟悉，并懂得我们该如何恢复一个被ollvm混淆后的代码</p>
<p>现在就开始写我对这题的看法！</p>
<p>参考Write up:</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Lnkvct/CTF-for-Fun/blob/main/Challenges/Inflated-ACTF2022/writeup.md">https://github.com/Lnkvct/CTF-for-Fun/blob/main/Challenges/Inflated-ACTF2022/writeup.md</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/FW-ltlly/p/16472171.html">https://www.cnblogs.com/FW-ltlly/p/16472171.html</a></p>
<p>lchild师傅的Write up（pdf所以没法给链接）</p>
</blockquote>
<h1 id="0x00-日常查壳"><a href="#0x00-日常查壳" class="headerlink" title="0x00 日常查壳"></a>0x00 日常查壳</h1><p>（感觉好久没写wp了）</p>
<p>无壳64位</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720122120679.png" alt="image-20220720122120679"></p>
<h1 id="0x01-CFG"><a href="#0x01-CFG" class="headerlink" title="0x01 CFG"></a>0x01 CFG</h1><h2 id="GETC"><a href="#GETC" class="headerlink" title="GETC"></a>GETC</h2><p>在讲这题ollvm与异常处理之前，有必要先搞懂我们到底是怎么输入的</p>
<p>一共有三处getc处理我们第一段输入的地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">407629</span><br><span class="line">40553A（专门用来处理箭头）</span><br><span class="line">405676（专门用来处理箭头）</span><br></pre></td></tr></table></figure>

<p>程序最先开始运行的是 407629，这里我们可以输入上下左右箭头与特定的数字</p>
<ul>
<li>如果是数字，程序读取加密进行存放</li>
<li>如果是箭头，会继续进行处理</li>
</ul>
<p>（同时我们的输入还会决定异常类型）</p>
<blockquote>
<p>Official Write up: The value of the first field of the thrown <code>StdObfException</code> object comes from the second input passed to the construct of <code>StdObfException</code>. </p>
</blockquote>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720123419556.png" alt="image-20220720123419556"></p>
<p>（这图好大…有没有什么办法处理这些图片还有博客页面的方法）</p>
<p>那么异常处理先不深究，继续回来箭头如何处理这个问题</p>
<p>那么箭头其实为三字节码，上下左右箭头分别对应 ^[[A ^[[B ^[[C ^[[D</p>
<p>（此时开始动调，我第一次输入为上箭头，同时注意RAX）</p>
<p>那么在 407629 第一次处理箭头会读取为1B</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720123755360.png" alt="image-20220720123755360"></p>
<p>随后到 40553A 读取为5B</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720123842835.png" alt="image-20220720123842835"></p>
<p>最后到达 405676 可以发现我们的上箭头代码所对应的字符为A</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720124119872.png" alt="image-20220720124119872"></p>
<p>以上就解释了第一段输入的处理，等到最后解密第一段输入就会用到此</p>
<h2 id="OLLVM-1"><a href="#OLLVM-1" class="headerlink" title="OLLVM"></a>OLLVM</h2><p>引用这张图，想要去掉ollvm最基本的是要认识这几个块</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/112">https://security.tencent.com/index.php/blog/msg/112</a></p>
</blockquote>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720133325311.png" alt="image-20220720133325311"></p>
<p>先抛去原题，来认识一下这些名词</p>
<ol>
<li>函数的开始地址为序言（Prologue）的地址</li>
<li>序言的后继为主分发器（Main dispatcher）</li>
<li>后继为主分发器的块为预处理器（Predispatcher）</li>
<li>后继为预处理器的块为真实块（Relevant blocks）</li>
<li>无后继的块为retn块</li>
<li>剩下的为无用块与子分发器（Sub dispatchers）</li>
</ol>
<p>那参考文章，总结来说，利用angr符号执行去除控制流平坦化的步骤可以归结为三个步骤：</p>
<ol>
<li>静态分析CFG得到序言/入口块（Prologue）、主分发器（Main dispatcher）、子分发器/无用块（Sub dispatchers）、真实块（Relevant blocks）、预分发器（Predispatcher）和返回块（Return）</li>
<li>利用符号执行恢复真实块的前后关系，重建控制流</li>
<li>根据第二步重建的控制流Patch程序，输出恢复后的可执行文件</li>
</ol>
<p>简单来说就是获取所有的块，利用angr符号执行我们的真实块，查看真实块之间的流程，再抛去我们不要的块，patch程序，完成！</p>
<p>（那么具体的实现看文章）</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://bluesadi.github.io/0x401RevTrain-Tools/angr/10_%E5%88%A9%E7%94%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%8E%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/">https://bluesadi.github.io/0x401RevTrain-Tools/angr/10_%E5%88%A9%E7%94%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%8E%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/</a></p>
</blockquote>
<p>然而这题…，根本不像啊！可以看出这题的CFG根本看不懂，不像单单ollvm混淆过的cfg那么漂亮</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720134654996.png" alt="image-20220720134654996"></p>
<h2 id="Exception-1"><a href="#Exception-1" class="headerlink" title="Exception"></a>Exception</h2><p>为了搞懂CFG为什么成这样了，得先了解下异常的原理，参考原文</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/catch/p/3604516.html">https://www.cnblogs.com/catch/p/3604516.html</a></p>
</blockquote>
<p>对于最基本的thown catch不再赘述，这篇讲到很清楚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://4nsw3r.top/2022/02/03/SCTF-REVERSE-CplusExceptionEncrypt-%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%8E%B0/#Clang-x64">https://4nsw3r.top/2022/02/03/SCTF-REVERSE-CplusExceptionEncrypt-%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%8E%B0/#Clang-x64</a></p>
</blockquote>
<h3 id="异常抛出后，发生了什么事情？"><a href="#异常抛出后，发生了什么事情？" class="headerlink" title="异常抛出后，发生了什么事情？"></a>异常抛出后，发生了什么事情？</h3><ol>
<li><p>如果当前函数没有catch，就沿着函数的调用链继续往上抛，然后出现两种情况</p>
<ul>
<li><p>在某个函数中找到相应的catch</p>
</li>
<li><p>没找到相应的catch，调用 std::terminate() （这个函数是把程序abort）</p>
</li>
</ul>
</li>
<li><p>如果想找到了相应的catch，执行相应的操作</p>
<ul>
<li>程序中<strong>catch的代码块</strong>有个专有名词：<strong>Landing pad</strong></li>
</ul>
</li>
<li><p>  从抛异常到开始 -&gt; 执行Landing pad代码 这整个过程叫作<strong>Stack unwind</strong></p>
</li>
</ol>
<p><strong>Stack unwind</strong></p>
<ol>
<li> 从抛异常函数开始，对调用链上的函数逐个往前查找Landing pad</li>
<li> 如果没有找到Landing pad则把程序abort，如果找到则记下Landing pad的位置，再重新回到抛异常的函数那里开始，一帧一帧地清理调用链上各个函数内部的局部变量，直到 landing pad 所在的函数为止</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cs a; <span class="comment">// stack unwind时被析构。</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cs b;</span><br><span class="line">  <span class="built_in">func1</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cs c;</span><br><span class="line">  <span class="keyword">try</span> </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">func2</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">int</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//进入这里之前， func1, func2已经被unwind.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>stack unwind的过程可以简单看成函数调用的逆过程，这个过程在实现上由一个专门的stack unwind库来实现</p>
<ul>
<li><p>stack unwind库在intel平台上</p>
</li>
<li><p>属于Itanium ABI 接口中的一部分</p>
</li>
<li><p>与具体的语言无关，由系统实现</p>
</li>
<li><p><strong>任何上层语言都可以通过这个接口的基础实现各自的异常处理</strong></p>
</li>
<li><p>GCC就是通过这个接口实现C++的异常处理</p>
</li>
</ul>
<h3 id="Itanium-C-ABI"><a href="#Itanium-C-ABI" class="headerlink" title="Itanium C++ ABI"></a>Itanium C++ ABI</h3><p>ltanium C++ ABI定义了一系列函数以及数据结构来建立整个异常处理的流程及框架，主要函数包括以下列：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_Unwind_RaiseException,</span><br><span class="line">_Unwind_Resume,</span><br><span class="line">_Unwind_DeleteException,</span><br><span class="line">_Unwind_GetGR,</span><br><span class="line">_Unwind_SetGR,</span><br><span class="line">_Unwind_GetIP,</span><br><span class="line">_Unwind_SetIP,</span><br><span class="line">_Unwind_GetRegionStart,</span><br><span class="line">_Unwind_GetLanguageSpecificData,</span><br><span class="line">_Unwind_ForcedUnwind</span><br></pre></td></tr></table></figure>

<p><strong>其中 _Unwind_RaiseException() 函数进行stack unwind</strong>，它在用户执行throw的时被调用</p>
<p>主要功能</p>
<ul>
<li><p>从当前函数开始，对调用链上的每一个函数都调用一个叫做 <strong>personality routine</strong> 的函数（__gxx_personality_v0）</p>
<ul>
<li> personality routine 该函数由上层的语言定义及提供实现</li>
</ul>
</li>
<li><p>_Unwind_RaiseException() 会在内部把函数栈调用现场重现，然后传给 personality routine，该函数主要做两件事情</p>
<ol>
<li>  检查当前函数是否有相对应的catch</li>
<li>  清理调用栈上的局部变量</li>
</ol>
</li>
</ul>
<p>那么稍稍总结一下，就是当程序抛出异常就要进行 stack unwind 操作</p>
<p>而这个操作具体是 _Unwind_RaiseException() 中的 personality routine() 实现了检查catch和清理栈上的局部变量</p>
<h3 id="C-ABI"><a href="#C-ABI" class="headerlink" title="C++ ABI"></a>C++ ABI</h3><p>基于前面介绍的 ltanium ABI，<strong>编译器层面</strong>也定义了一系列 ABI 与之交互</p>
<p>当我们在代码中写下 throw xxx，编译器会分配一个数据结构 <strong>__cxa_exception</strong> 来表示该异常，该异常也有一个头部，定义如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">cxa_exception</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">  std::type_info *    exceptionType;</span><br><span class="line">  <span class="built_in"><span class="keyword">void</span></span> (*exceptionDestructor) (<span class="keyword">void</span> *); </span><br><span class="line">  unexpected_handler    unexpectedHandler;</span><br><span class="line">  terminate_handler    terminateHandler;</span><br><span class="line">  __cxa_exception *    nextException;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span>     handlerCount;</span><br><span class="line">  <span class="keyword">int</span>     handlerSwitchValue;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *     actionRecord;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *     languageSpecificData;</span><br><span class="line">  <span class="keyword">void</span> *     catchTemp;</span><br><span class="line">  <span class="keyword">void</span> *     adjustedPtr;</span><br><span class="line"></span><br><span class="line">  _Unwind_Exception    unwindHeader;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当用户 throw 一个异常时，编译器会帮我们调用相应的函数分配出如下的结构</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220717215150054-16582999766421.png" alt="image-20220717215150054"></p>
<p>其中 __cxa_exception 就是头部，exception_obj 则是 “throw xxx” 中的 xxx，这两部分在内存中是连续的。</p>
<ul>
<li><p>异常对象由函数 __cxa_allocate_exception() 进行创建</p>
</li>
<li><p>最后由 __cxa_free_exception() 进行销毁</p>
</li>
</ul>
<p>当我们在程序里执行了抛出异常的操作，编译器为我们做了如下的事情：</p>
<ol>
<li>调用 __cxa_allocate_exception 函数，分配一个异常对象（__cxa_exception，数据结构如上）</li>
<li>调用 __cxa_throw 函数，这个函数会将异常对象做一些初始化</li>
<li>__cxa_throw() 调用 Itanium ABI 里的 _Unwind_RaiseException() 从而开始 unwind</li>
<li>_Unwind_RaiseException() 对调用链上的函数进行 unwind 时，调用 personality routine()</li>
<li>该异常如能被处理(有相应的 catch)，则 personality routine 会依次对调用链上的函数进行清理</li>
<li><strong>_Unwind_RaiseException() 将控制权转到相应的catch代码</strong></li>
<li>unwind 完成，用户代码继续执行</li>
</ol>
<p>总结太Bravo了！</p>
<h2 id="再看异常处理"><a href="#再看异常处理" class="headerlink" title="再看异常处理"></a>再看异常处理</h2><p>有了这些前置知识，再看题目中的异常，由前面描述可知实现 unwind stack 的具体过程是通过 __gxx_personality_v0（即personality routine）实现</p>
<p>这时候我们再去IDA里调整此函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_Unwind_Reason_Code __fastcall _gxx_personality_v0(</span><br><span class="line">        <span class="keyword">int</span> Version,</span><br><span class="line">        _Unwind_Action actions,</span><br><span class="line">        __int64 exceptionClass,</span><br><span class="line">        _Unwind_Exception *exceptionObject,</span><br><span class="line">        _Unwind_Context *context)</span><br></pre></td></tr></table></figure>

<p>光标在函数，按Y修改类型</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720154638797.png" alt="image-20220720154638797"></p>
<p><strong>scan_eh_tab</strong></p>
<p>回忆__gxx_personality_v0函数功能</p>
<ol>
<li>检查当前函数是否有相应的 catch 语句。</li>
<li>清理当前函数中的局部变量。</li>
</ol>
<p>在personality routine()下的 scan_eh_tab() 该函数有我们最关心的两个值，同时也是<strong>魔改处</strong></p>
<blockquote>
<p>与源码对比：<a target="_blank" rel="noopener" href="https://code.woboq.org/llvm/libcxxabi/src/cxa_personality.cpp.html#__cxxabiv1::scan_eh_tab">https://code.woboq.org/llvm/libcxxabi/src/cxa_personality.cpp.html#__cxxabiv1::scan_eh_tab</a></p>
</blockquote>
<p>Shfit + F1 -&gt; INS 导入结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scan_results</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">int64_t</span> ttypeIndex; </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span>* actionRecord; </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span>* languageSpecificData; </span><br><span class="line"><span class="keyword">uintptr_t</span> landingPad; </span><br><span class="line"><span class="keyword">void</span>* adjustedPtr; </span><br><span class="line">_Unwind_Reason_Code reason; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>光标在scan_eh_tab函数上按Y修改</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scan_eh_tab</span><span class="params">(scan_results *results, _Unwind_Action actions, <span class="keyword">bool</span> native_exception, _Unwind_Exception *unwind_exception, _Unwind_Context *context)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Landing-pad"><a href="#Landing-pad" class="headerlink" title="Landing pad"></a>Landing pad</h3><p>Landing pad（<strong>指向catch块的分发处</strong>，只单单拿到landing pad还不够，这时候还缺少一个对应异常类型ttypeIndex）</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720160405446.png" alt="image-20220720160405446"> </p>
<h3 id="ttypeIndex"><a href="#ttypeIndex" class="headerlink" title="ttypeIndex"></a>ttypeIndex</h3><p>首先要求父类为StdObfException的异常</p>
<p><strong>最后的ttypeIndex由 thrown_object_ptr（由我们的第一段输入所决定的thrown_object_ptr） 和 原始固定固定typeIndex 决定</strong></p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720160818159.png" alt="image-20220720160818159"></p>
<blockquote>
<p>Official Write up: And we have figured out that the <code>ttypeIndex</code> is determined by the first field of the thrown <code>StdObfException</code> object and the <code>lptinfo</code> passed to <code>__cxa_throw</code>.  The value of the first field of the thrown <code>StdObfException</code> object comes from the second input passed to the construct of <code>StdObfException</code>. </p>
</blockquote>
<p>那么这两个值到底具体指的是什么？？</p>
<p>其实上面已经给出了答案，反复调试可知，可以发现我们的第一段输入设置了父类StdObfException</p>
<p>the first field of the thrown <code>StdObfException</code> object 指的就是我们的输入</p>
<p>the <code>lptinfo</code> passed to <code>__cxa_throw</code> 指的就是当 ___cxa_allocate_exception 创建的异常，也就是固定的</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720164747324.png" alt="image-20220720164747324"></p>
<p>现在知道了魔改后的流程是从哪里来到哪里去，人工方式就是跳到landing pad再设置rdx为ttypeIndex就可以到达我们所对应的catch块</p>
<h2 id="什么叫CFG！"><a href="#什么叫CFG！" class="headerlink" title="什么叫CFG！"></a>什么叫CFG！</h2><p>那么现在知道了routine personality 中的 scan_eh_tab被修改了，而IDA平常能识别throw catch这些块的原因就是这些正常的源码</p>
<p><strong>然而landingpad与ttypeIndex都被修改了，所以导致了IDA识别的CFG成了这个样子</strong></p>
<p>我们根本没法用肉眼知道throw的块在哪，只有通过动调才能确定，然而这就导致了原先的deflat脚本都不不行了</p>
<p>原因主要为两点</p>
<ol>
<li>无法确定throw后的块</li>
<li>throw可能对着多个catch块，这时候就通过rdi（ttypeIndex）进行catch块分发（landingPad）</li>
</ol>
<p>原因还有种种就不一一举例，就无法正常原先deflat所需要的CFG块</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220720222946227.png" alt="image-20220720222946227"></p>
<p>以下开始就是跟着官方脚本复现</p>
<p>我们再回忆一下正常的ollvm的执行流程</p>
<p>Prologue（入口块）-&gt; Main dispatcher（主分发器）-&gt; Sub dispathers（子分发器）-&gt; Relevant blocks（真实块）-&gt; Predispather（预分发器）-&gt; Main dispatcher（主分发器）…</p>
<p>总结一下这道题的CFG</p>
<p>我们的下一个真实块取决于系统生产的lptinfo和我们的第一段输入所导致的StdObfException，在每个真实块的结束，我们不只是跳往与预分发器，而是调用 __cxa_throw 进行第二次调度，我们称二次调用为 second dispatch</p>
<p>所以我们的执行流就是</p>
<p>… -&gt; main dispatcher -&gt; sub dispatchers -&gt; relevant block -&gt; throw StdObfException exception -&gt; Secondary dispatchers -&gt; pre-dispatcher -&gt; main dispatcher -&gt; …</p>
<p>除此之外，程序还抛出了一些真正的异常，对于这些异常，第二次调用发生于Landing pad末尾</p>
<p>… -&gt; main dispatcher -&gt; sub dispatchers -&gt; relevant block that throws real exceptions -&gt; the according real LandingPad block -&gt; throw StdObfException exception -&gt; Secondary dispatchers -&gt; pre-dispatcher -&gt; main dispatcher -&gt; …</p>
<h1 id="0x02-Deflat-Solution"><a href="#0x02-Deflat-Solution" class="headerlink" title="0x02 Deflat Solution"></a>0x02 Deflat Solution</h1><p>去该平坦化控制流，有两个步骤：</p>
<ol>
<li>找到所有的真实块</li>
<li>找到真实块之间的关系</li>
</ol>
<h2 id="Find-all-relevant-blocks"><a href="#Find-all-relevant-blocks" class="headerlink" title="Find all relevant blocks"></a>Find all relevant blocks</h2><p>我们可以从主分发器开始寻找，找到所有子分发器的后继者，这些后继者本身不是子分发器</p>
<p>官方WP中一眼丁真发现子分发器由该指令格式组成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sub dispathers such as:</span><br><span class="line">cmp </span><br><span class="line">jx</span><br></pre></td></tr></table></figure>

<p>于是由此区别出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">isCmpRI = <span class="keyword">lambda</span> instr: instr.mnemonic == <span class="string">&quot;cmp&quot;</span> <span class="keyword">and</span>\</span><br><span class="line">  <span class="built_in">hasattr</span>(instr.operands[<span class="number">0</span>], <span class="string">&quot;_X86RegisterOperand__key&quot;</span>) <span class="keyword">and</span>\</span><br><span class="line">  <span class="built_in">hasattr</span>(instr.operands[<span class="number">1</span>], <span class="string">&quot;_X86ImmediateOperand__key&quot;</span>) </span><br><span class="line">isCJmp = <span class="keyword">lambda</span> instr: instr.mnemonic.startswith(<span class="string">&quot;j&quot;</span>) <span class="keyword">and</span> \</span><br><span class="line">  instr.mnemonic != <span class="string">&quot;jmp&quot;</span></span><br><span class="line">isSubDispatcher = <span class="keyword">lambda</span> bb: (<span class="built_in">len</span>(bb.instrs) == <span class="number">2</span>) <span class="keyword">and</span>\</span><br><span class="line">   isCmpRI(bb.instrs[<span class="number">0</span>]) <span class="keyword">and</span> isCJmp(bb.instrs[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>首先判断是否为子分发器，然后排除法找到所有真实块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PatchHelper</span>:</span></span><br><span class="line">  <span class="comment">## ......</span></span><br><span class="line">  <span class="comment"># To get all cfgs</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">block</span>(<span class="params">self, addr</span>):</span></span><br><span class="line">    bb = self.cfg.find_basic_block(addr)</span><br><span class="line">    <span class="keyword">if</span> bb <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      bb = barf.bb_builder.strategy._disassemble_bb(addr, barf.binary.ea_end, &#123;&#125;)</span><br><span class="line">    <span class="keyword">return</span> bb</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_relevant_blocks</span>(<span class="params">cfg, patch_helper, main_dispatcher</span>):</span></span><br><span class="line">  isCmpRI = <span class="keyword">lambda</span> instr: instr.mnemonic == <span class="string">&quot;cmp&quot;</span> <span class="keyword">and</span>\</span><br><span class="line">    <span class="built_in">hasattr</span>(instr.operands[<span class="number">0</span>], <span class="string">&quot;_X86RegisterOperand__key&quot;</span>) <span class="keyword">and</span>\</span><br><span class="line">    <span class="built_in">hasattr</span>(instr.operands[<span class="number">1</span>], <span class="string">&quot;_X86ImmediateOperand__key&quot;</span>) </span><br><span class="line">  isCJmp = <span class="keyword">lambda</span> instr: instr.mnemonic.startswith(<span class="string">&quot;j&quot;</span>) <span class="keyword">and</span> \</span><br><span class="line">    instr.mnemonic != <span class="string">&quot;jmp&quot;</span></span><br><span class="line">  isSubDispatcher = <span class="keyword">lambda</span> bb: (<span class="built_in">len</span>(bb.instrs) == <span class="number">2</span>) <span class="keyword">and</span>\</span><br><span class="line">     isCmpRI(bb.instrs[<span class="number">0</span>]) <span class="keyword">and</span> isCJmp(bb.instrs[<span class="number">1</span>])</span><br><span class="line">  relevant_blocks = []</span><br><span class="line">  visited = <span class="built_in">set</span>()</span><br><span class="line">  q = SimpleQueue()</span><br><span class="line">  q.put(patch_helper.block(main_dispatcher))</span><br><span class="line">  <span class="keyword">while</span> <span class="keyword">not</span> q.empty():</span><br><span class="line">    bb = q.get()</span><br><span class="line">    <span class="comment"># Either Sub Patchers or Relevant blocks? </span></span><br><span class="line">    <span class="keyword">if</span> isSubDispatcher(bb):</span><br><span class="line">      <span class="keyword">for</span> succ, cond <span class="keyword">in</span> bb.branches:</span><br><span class="line">        <span class="keyword">if</span> succ <span class="keyword">in</span> visited:</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        q.put(patch_helper.block(succ))</span><br><span class="line">        visited.add(succ)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      relevant_blocks.append(bb)</span><br><span class="line">  <span class="keyword">return</span> relevant_blocks</span><br></pre></td></tr></table></figure>

<p>Relevant blocks:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*******************relevant blocks************************</span><br><span class="line">main_dispatcher:0x404a80</span><br><span class="line">relevant_blocks: [&#x27;0x409437&#x27;, &#x27;0x406443&#x27;, &#x27;0x404ab8&#x27;, &#x27;0x408031&#x27;, &#x27;0x407842&#x27;, &#x27;0x407d31&#x27;, &#x27;0x407437&#x27;, &#x27;0x407f4f&#x27;, &#x27;0x4076bd&#x27;, &#x27;0x407a6b&#x27;, &#x27;0x40723e&#x27;, &#x27;0x407fc4&#x27;, &#x27;0x409458&#x27;, &#x27;0x407bc7&#x27;, &#x27;0x40732f&#x27;, &#x27;0x407ebc&#x27;, &#x27;0x407566&#x27;, &#x27;0x407960&#x27;, &#x27;0x4070fa&#x27;, &#x27;0x405e7a&#x27;, &#x27;0x4078e3&#x27;, &#x27;0x407e5a&#x27;, &#x27;0x4074ca&#x27;, &#x27;0x405c87&#x27;, &#x27;0x407741&#x27;, &#x27;0x407af5&#x27;, &#x27;0x4072b4&#x27;, &#x27;0x405ded&#x27;, &#x27;0x4077b6&#x27;, &#x27;0x407c6b&#x27;, &#x27;0x4073a4&#x27;, &#x27;0x405b29&#x27;, &#x27;0x4075f9&#x27;, &#x27;0x407a06&#x27;, &#x27;0x4071aa&#x27;, &#x27;0x406cfe&#x27;, &#x27;0x406c94&#x27;, &#x27;0x406ef0&#x27;, &#x27;0x406859&#x27;, &#x27;0x40707d&#x27;, &#x27;0x406b62&#x27;, &#x27;0x406f5f&#x27;, &#x27;0x4065c9&#x27;, &#x27;0x406e5d&#x27;, &#x27;0x406a72&#x27;, &#x27;0x406d7b&#x27;, &#x27;0x406704&#x27;, &#x27;0x406def&#x27;, &#x27;0x406964&#x27;, &#x27;0x40944b&#x27;, &#x27;0x4064a5&#x27;, &#x27;0x405469&#x27;, &#x27;0x405a5f&#x27;, &#x27;0x404fae&#x27;, &#x27;0x40532c&#x27;, &#x27;0x40589c&#x27;, &#x27;0x404d58&#x27;, &#x27;0x4053d3&#x27;, &#x27;0x405923&#x27;, &#x27;0x404ec5&#x27;, &#x27;0x40529a&#x27;, &#x27;0x4057b8&#x27;, &#x27;0x404bc4&#x27;, &#x27;0x405f2a&#x27;, &#x27;0x4056f0&#x27;, &#x27;0x406299&#x27;, &#x27;0x4068f0&#x27;, &#x27;0x4063b0&#x27;, &#x27;0x406bf9&#x27;, &#x27;0x406323&#x27;, &#x27;0x406646&#x27;, &#x27;0x40620f&#x27;, &#x27;0x406b00&#x27;, &#x27;0x4060e7&#x27;, &#x27;0x4067bb&#x27;, &#x27;0x40617c&#x27;, &#x27;0x4069e3&#x27;, &#x27;0x40606d&#x27;, &#x27;0x406521&#x27;, &#x27;0x4051fe&#x27;, &#x27;0x405647&#x27;, &#x27;0x404e14&#x27;, &#x27;0x4055b5&#x27;, &#x27;0x4050cc&#x27;, &#x27;0x40550b&#x27;, &#x27;0x404ca4&#x27;]</span><br></pre></td></tr></table></figure>



<h2 id="Find-the-flow"><a href="#Find-the-flow" class="headerlink" title="Find the flow"></a>Find the flow</h2><p>官网WP指出抽象出来）留个坑，以后熟了试试</p>
<blockquote>
<p>Official Write up: A good idea is to abstract the <code>throw StdObfException -&gt; catch</code> process and do the <em>one basic block symbolic execution</em> (You can refer to <a target="_blank" rel="noopener" href="https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html">Deobfuscation: recovering an OLLVM-protected program</a> or <a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/112">利用符号执行去除控制流平坦化</a> for more information). </p>
</blockquote>
<p>于是官网WP又给了个更有趣的方法，GDB脚本！</p>
<p>为了找到真实块之间的流程，通过普通的执行然后打印真实块需要的信息！</p>
<p>但是我们不一样能得到所有的流程因为部分可能没执行到，但是我们依然可以利用提取出来的信息去恢复部分控制流，并弄清楚如何输入可以恢复更多流程。（怎么好像梦到过我在这写wp…）</p>
<p>生成GDB的脚本如下</p>
<ul>
<li>40A3D4为我们catch块地址</li>
<li>_ZN18StdSubObfExceptionC2Ec为了打印异常类型</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cmds = <span class="string">&quot;&quot;&quot;\</span></span><br><span class="line"><span class="string">set pagination off</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">b *0x40A3D4</span></span><br><span class="line"><span class="string">commands</span></span><br><span class="line"><span class="string">  silent</span></span><br><span class="line"><span class="string">  printf &quot;landingPad: %x\\n&quot;, $rdx</span></span><br><span class="line"><span class="string">  continue</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">b _ZN18StdSubObfExceptionC2Ec</span></span><br><span class="line"><span class="string">commands</span></span><br><span class="line"><span class="string">  silent</span></span><br><span class="line"><span class="string">  printf &quot;selector: %x\\n&quot;, $rsi</span></span><br><span class="line"><span class="string">  continue</span></span><br><span class="line"><span class="string">end </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">define mytrace </span></span><br><span class="line"><span class="string">  break $arg0</span></span><br><span class="line"><span class="string">  commands</span></span><br><span class="line"><span class="string">    silent</span></span><br><span class="line"><span class="string">    printf &quot;%x\\n&quot;, $pc</span></span><br><span class="line"><span class="string">    python gdb.execute(&#x27;continue&#x27;)</span></span><br><span class="line"><span class="string">  end</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> bb <span class="keyword">in</span> relevant_blocks:</span><br><span class="line">    cmds += (<span class="string">f&quot;mytrace *<span class="subst">&#123;<span class="built_in">hex</span>(bb.address)&#125;</span> \n&quot;</span>)</span><br><span class="line">cmds += <span class="string">&quot;run\n&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.gdb&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(cmds)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat teatin</span><br><span class="line">0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef</span><br><span class="line"></span><br><span class="line">gdb inflated -x test.gdb --batch &lt; testin &gt; testout</span><br></pre></td></tr></table></figure>

<p>于是可以获取真实块接下来的landing pad与异常类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1 at 0x40a3d4</span><br><span class="line">......</span><br><span class="line">Breakpoint 88 at 0x404ca4</span><br><span class="line">4075f9</span><br><span class="line">selector: 0</span><br><span class="line">landingPad: 4089bf</span><br><span class="line">4072b4</span><br><span class="line">selector: 0</span><br><span class="line">landingPad: 408503</span><br><span class="line">4075f9</span><br><span class="line">selector: 2</span><br><span class="line">landingPad: 4089bf</span><br><span class="line">4060e7</span><br><span class="line">selector: 0</span><br><span class="line">......</span><br><span class="line">40617c</span><br><span class="line">selector: 0</span><br><span class="line">landingPad: 409100</span><br><span class="line">409437</span><br><span class="line">[Inferior 1 (process 13732) exited normally]</span><br></pre></td></tr></table></figure>

<p>然后就写个PARSER分析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_logs</span>(<span class="params">logfn, prologue, patch_helper</span>):</span></span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(logfn, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    t = f.readlines()</span><br><span class="line">  i = <span class="number">0</span></span><br><span class="line">  selector_s = <span class="string">&quot;selector: &quot;</span></span><br><span class="line">  landingpad_s = <span class="string">&quot;landingPad: &quot;</span></span><br><span class="line">  relations = <span class="built_in">set</span>()</span><br><span class="line">  laddr = prologue</span><br><span class="line">  lselector = <span class="number">0</span></span><br><span class="line">  landingpad = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(t):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      addr = <span class="built_in">int</span>(t[i], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">      i += <span class="number">1</span></span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> laddr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      relations.add((laddr, lselector, addr))</span><br><span class="line">    <span class="keyword">if</span> t[i+<span class="number">1</span>].startswith(selector_s):</span><br><span class="line">      selector = <span class="built_in">int</span>(t[i+<span class="number">1</span>][<span class="built_in">len</span>(selector_s):], <span class="number">16</span>)</span><br><span class="line">      i += <span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> t[i+<span class="number">1</span>].startswith(landingpad_s):</span><br><span class="line">      landingpad = <span class="built_in">int</span>(t[i+<span class="number">1</span>][<span class="built_in">len</span>(landingpad_s):], <span class="number">16</span>)</span><br><span class="line">      relations.add((addr, -<span class="number">1</span>, landingpad))</span><br><span class="line">      addr = landingpad</span><br><span class="line">      <span class="keyword">while</span> <span class="keyword">not</span> patch_helper.is_unreachable(patch_helper.block(addr).direct_branch):</span><br><span class="line">        addr = patch_helper.block(addr).direct_branch</span><br><span class="line">      <span class="keyword">if</span> t[i+<span class="number">2</span>].startswith(selector_s):</span><br><span class="line">        selector = <span class="built_in">int</span>(t[i+<span class="number">2</span>][<span class="built_in">len</span>(selector_s):], <span class="number">16</span>)</span><br><span class="line">      i += <span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> t[i+<span class="number">1</span>].startswith(<span class="string">&quot;[Inferior &quot;</span>):</span><br><span class="line">      i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Warning: %x doesn&#x27;t have selector. &quot;</span>%addr)</span><br><span class="line">      exit(<span class="number">0</span>)</span><br><span class="line">    laddr = addr</span><br><span class="line">    lselector = selector</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">list</span>(relations)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;************************flow******************************&#x27;</span>)</span><br><span class="line">relations = parse_logs(sys.argv[<span class="number">3</span>], prologue, patch_helper)</span><br><span class="line">relations.sort(key = <span class="keyword">lambda</span> x:x)</span><br><span class="line">flow = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> bb, selector, child <span class="keyword">in</span> relations:</span><br><span class="line">  <span class="keyword">if</span> bb <span class="keyword">in</span> flow:</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(flow[bb]) &lt; selector:</span><br><span class="line">      flow[bb].append(-<span class="number">1</span>)</span><br><span class="line">    flow[bb].append(child)</span><br><span class="line">    <span class="keyword">assert</span>(<span class="built_in">len</span>(flow[bb]) == selector+<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    flow[bb] = [child]</span><br><span class="line"><span class="keyword">for</span> (k, v) <span class="keyword">in</span> <span class="built_in">list</span>(flow.items()):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%#x:&#x27;</span> % k, [<span class="built_in">hex</span>(child) <span class="keyword">for</span> child <span class="keyword">in</span> v])</span><br></pre></td></tr></table></figure>

<p>Flows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">************************flow******************************</span><br><span class="line">0x404820: [&#x27;0x4075f9&#x27;]</span><br><span class="line">0x404ab8: [&#x27;0x404ab8&#x27;, &#x27;0x406c94&#x27;]</span><br><span class="line">0x404bc4: [&#x27;0x407bc7&#x27;]</span><br><span class="line">0x404ca4: [&#x27;0x406bf9&#x27;]</span><br><span class="line">0x404ec5: [&#x27;0x4053d3&#x27;]</span><br><span class="line">0x404fae: [&#x27;0x406b00&#x27;]</span><br><span class="line">0x4051fe: [&#x27;0x40707d&#x27;]</span><br><span class="line">0x4053d3: [&#x27;0x406521&#x27;]</span><br><span class="line">0x405469: [&#x27;0x407d31&#x27;]</span><br><span class="line">0x4056f0: [&#x27;0x405a5f&#x27;, &#x27;0x4056f0&#x27;]</span><br><span class="line">0x4057b8: [&#x27;0x404ab8&#x27;]</span><br><span class="line">0x405923: [&#x27;0x405923&#x27;, &#x27;0x406e5d&#x27;]</span><br><span class="line">0x405a5f: [&#x27;0x4067bb&#x27;]</span><br><span class="line">0x405b29: [&#x27;0x406964&#x27;, &#x27;0x406646&#x27;]</span><br><span class="line">0x405c87: [&#x27;0x405c87&#x27;, &#x27;0x407437&#x27;]</span><br><span class="line">0x405f2a: [&#x27;0x405f2a&#x27;, &#x27;0x4063b0&#x27;]</span><br><span class="line">0x4060e7: [&#x27;0x40723e&#x27;]</span><br><span class="line">0x40617c: [&#x27;0x409437&#x27;]</span><br><span class="line">0x40620f: [&#x27;0x405f2a&#x27;]</span><br><span class="line">0x406299: [&#x27;0x404bc4&#x27;, &#x27;0x4057b8&#x27;]</span><br><span class="line">0x4063b0: [&#x27;0x4063b0&#x27;, &#x27;0x405469&#x27;]</span><br><span class="line">0x4064a5: [&#x27;0x406704&#x27;, &#x27;0x40620f&#x27;]</span><br><span class="line">0x406521: [&#x27;0x4074ca&#x27;, &#x27;0x404bc4&#x27;]</span><br><span class="line">0x4065c9: [&#x27;0x40723e&#x27;]</span><br><span class="line">0x406646: [&#x27;0x406964&#x27;]</span><br><span class="line">0x406704: [&#x27;0x405c87&#x27;]</span><br><span class="line">0x4067bb: [&#x27;0x4082b6&#x27;]</span><br><span class="line">0x406964: [&#x27;0x405b29&#x27;, &#x27;0x404ca4&#x27;]</span><br><span class="line">0x4069e3: [&#x27;0x408281&#x27;]</span><br><span class="line">0x406a72: [&#x27;0x404fae&#x27;]</span><br><span class="line">0x406b00: [&#x27;0x406299&#x27;]</span><br><span class="line">0x406bf9: [&#x27;0x405923&#x27;]</span><br><span class="line">0x406c94: [&#x27;0x4074ca&#x27;]</span><br><span class="line">0x406cfe: [&#x27;0x40723e&#x27;]</span><br><span class="line">0x406e5d: [&#x27;0x406e5d&#x27;, &#x27;0x4077b6&#x27;]</span><br><span class="line">0x406f5f: [&#x27;0x406f5f&#x27;, &#x27;0x407566&#x27;]</span><br><span class="line">0x40707d: [&#x27;0x40707d&#x27;, &#x27;0x407960&#x27;]</span><br><span class="line">0x4070fa: [&#x27;0x406f5f&#x27;]</span><br><span class="line">0x4071aa: [&#x27;0x4056f0&#x27;]</span><br><span class="line">0x40723e: [&#x27;0x4072b4&#x27;]</span><br><span class="line">0x4072b4: [&#x27;0x4075f9&#x27;, &#x27;0x4071aa&#x27;]</span><br><span class="line">0x407437: [&#x27;0x407437&#x27;, &#x27;0x4064a5&#x27;]</span><br><span class="line">0x4074ca: [&#x27;0x404ec5&#x27;, &#x27;0x407c6b&#x27;]</span><br><span class="line">0x407566: [&#x27;0x407566&#x27;, &#x27;0x407a6b&#x27;]</span><br><span class="line">0x4075f9: [&#x27;0x4072b4&#x27;, &#x27;-0x1&#x27;, &#x27;0x4060e7&#x27;, &#x27;0x406cfe&#x27;, &#x27;0x4078e3&#x27;, &#x27;0x4065c9&#x27;]</span><br><span class="line">0x4076bd: [&#x27;0x404ec5&#x27;]</span><br><span class="line">0x4077b6: [&#x27;0x406bf9&#x27;, &#x27;0x4070fa&#x27;]</span><br><span class="line">0x4078e3: [&#x27;0x40723e&#x27;]</span><br><span class="line">0x407960: [&#x27;0x4081f5&#x27;]</span><br><span class="line">0x407a6b: [&#x27;0x4070fa&#x27;, &#x27;0x406704&#x27;]</span><br><span class="line">0x407bc7: [&#x27;0x406a72&#x27;, &#x27;0x407bc7&#x27;]</span><br><span class="line">0x407c6b: [&#x27;0x4069e3&#x27;]</span><br><span class="line">0x407d31: [&#x27;0x407d31&#x27;, &#x27;0x407ebc&#x27;]</span><br><span class="line">0x407ebc: [&#x27;0x407ebc&#x27;, &#x27;0x40617c&#x27;]</span><br><span class="line">0x4081f5: [&#x27;0x405b29&#x27;]</span><br><span class="line">0x408281: [&#x27;0x4051fe&#x27;]</span><br><span class="line">0x4082b6: [&#x27;0x4076bd&#x27;]</span><br></pre></td></tr></table></figure>



<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><p>修复程序环节！</p>
<ul>
<li><p>当我们已经确定了执行流程，像抛异常 子分发器什么都是多余的了，统统patch掉</p>
</li>
<li><p>对于后继块只有一个的真实块，只需要jmp过去</p>
</li>
<li><p>对于有多个后继块的，需要通过esi（也就是异常类型）来改成cmp esi, … jz即可</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_branches</span>(<span class="params">self, bb, va_targets</span>):</span></span><br><span class="line">  va_start, size = self.get_patchable_from_relblk(bb)</span><br><span class="line">  <span class="keyword">if</span> size &lt; PatchHelper.JMP_SIZE:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[Warning] patch_jmp at block %x may fail. size: %d.&quot;</span>%(bb.address, size))</span><br><span class="line">  org_start = va_start</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&quot;va_start: <span class="subst">&#123;<span class="built_in">hex</span>(va_start)&#125;</span>, bb addr: <span class="subst">&#123;<span class="built_in">hex</span>(bb.address)&#125;</span>, size: <span class="subst">&#123;size&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="comment">## `cmp esi, v` instr takes 3 bytes while `je xxx` takes 6 bytes</span></span><br><span class="line">  <span class="comment">## And the last jmp instr takes 5 bytes. </span></span><br><span class="line">  total_size = <span class="number">9</span> * <span class="built_in">len</span>(va_targets) - <span class="number">4</span></span><br><span class="line">  <span class="keyword">if</span> size &lt; total_size:</span><br><span class="line">    <span class="comment">## If the nop block at the end of current block is not large enough, </span></span><br><span class="line"> 	  <span class="comment">## try to find another nop block and then jump to it. </span></span><br><span class="line">    nx_va_start, nx_size = self.get_nop_by_size(total_size)</span><br><span class="line">    <span class="keyword">if</span> nx_size == <span class="number">0</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;[Error] `patch_branches` needs a nop block with size larger than %d.&quot;</span>%(total_size))</span><br><span class="line">    self.patch_jmp(va_start, nx_va_start)</span><br><span class="line">    va_start, size = nx_va_start, nx_size</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> i, t <span class="keyword">in</span> <span class="built_in">enumerate</span>(va_targets[:-<span class="number">1</span>]):</span><br><span class="line">    cmp_instr = <span class="built_in">bytes</span>([<span class="number">0x83</span>,<span class="number">0xfe</span>,i])</span><br><span class="line">    self.do_patch(va_start, cmp_instr)</span><br><span class="line">    va_start += <span class="built_in">len</span>(cmp_instr)</span><br><span class="line">    cj_instr = <span class="built_in">bytes</span>([PatchHelper.opcode[<span class="string">&#x27;j&#x27;</span>],PatchHelper.opcode[<span class="string">&#x27;e&#x27;</span>]])</span><br><span class="line">    <span class="keyword">if</span> t == -<span class="number">1</span>:</span><br><span class="line">      <span class="comment">## -1 represent that we do not know the flow for this selector value for now. </span></span><br><span class="line">      cj_instr += struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, self.func_terminate-va_start-<span class="number">6</span>)</span><br><span class="line">      <span class="comment"># cj_instr = asm(f&quot;je &#123;hex(self.func_terminate)&#125;&quot;, vma=va_start)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      cj_instr += struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, t-va_start-<span class="number">6</span>)</span><br><span class="line">      <span class="comment"># cj_instr = asm(f&quot;je &#123;hex(t)&#125;&quot;, vma=va_start)</span></span><br><span class="line">    self.do_patch(va_start, cj_instr)</span><br><span class="line">    va_start += <span class="built_in">len</span>(cj_instr)</span><br><span class="line">  va_start += self.patch_jmp(va_start, va_targets[-<span class="number">1</span>])</span><br><span class="line">  <span class="keyword">if</span> va_start &gt; org_start+size:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[Warning] patches at (%x, %x) overlaps next blk. &quot;</span>%(org_start, va_start))</span><br></pre></td></tr></table></figure>

<p>官方完整脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## filename: deflat.py</span></span><br><span class="line"><span class="keyword">from</span> ast <span class="keyword">import</span> <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> xmlrpc.client <span class="keyword">import</span> Boolean</span><br><span class="line"><span class="keyword">from</span> barf.barf <span class="keyword">import</span> BARF</span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwnlib <span class="keyword">import</span> elf</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> SimpleQueue</span><br><span class="line"><span class="comment"># from pwn import *</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PatchHelper</span>:</span></span><br><span class="line">  opcode = &#123;<span class="string">&#x27;a&#x27;</span> :<span class="number">0x87</span>, <span class="string">&#x27;ae&#x27;</span>:<span class="number">0x83</span>, <span class="string">&#x27;b&#x27;</span> :<span class="number">0x82</span>, <span class="string">&#x27;be&#x27;</span>:<span class="number">0x86</span>, <span class="string">&#x27;c&#x27;</span> :<span class="number">0x82</span>, <span class="string">&#x27;e&#x27;</span> :<span class="number">0x84</span>, <span class="string">&#x27;z&#x27;</span> :<span class="number">0x84</span>, <span class="string">&#x27;g&#x27;</span> :<span class="number">0x8F</span>, </span><br><span class="line">            <span class="string">&#x27;ge&#x27;</span>:<span class="number">0x8D</span>, <span class="string">&#x27;l&#x27;</span> :<span class="number">0x8C</span>, <span class="string">&#x27;le&#x27;</span>:<span class="number">0x8E</span>, <span class="string">&#x27;na&#x27;</span>:<span class="number">0x86</span>, <span class="string">&#x27;nae&#x27;</span>:<span class="number">0x82</span>,<span class="string">&#x27;nb&#x27;</span>:<span class="number">0x83</span>, <span class="string">&#x27;nbe&#x27;</span>:<span class="number">0x87</span>,<span class="string">&#x27;nc&#x27;</span>:<span class="number">0x83</span>,</span><br><span class="line">            <span class="string">&#x27;ne&#x27;</span>:<span class="number">0x85</span>, <span class="string">&#x27;ng&#x27;</span>:<span class="number">0x8E</span>, <span class="string">&#x27;nge&#x27;</span>:<span class="number">0x8C</span>,<span class="string">&#x27;nl&#x27;</span>:<span class="number">0x8D</span>, <span class="string">&#x27;nle&#x27;</span>:<span class="number">0x8F</span>,<span class="string">&#x27;no&#x27;</span>:<span class="number">0x81</span>, <span class="string">&#x27;np&#x27;</span>:<span class="number">0x8B</span>, <span class="string">&#x27;ns&#x27;</span>:<span class="number">0x89</span>,</span><br><span class="line">            <span class="string">&#x27;nz&#x27;</span>:<span class="number">0x85</span>, <span class="string">&#x27;o&#x27;</span> :<span class="number">0x80</span>, <span class="string">&#x27;p&#x27;</span> :<span class="number">0x8A</span>, <span class="string">&#x27;pe&#x27;</span>:<span class="number">0x8A</span>, <span class="string">&#x27;po&#x27;</span>:<span class="number">0x8B</span>, <span class="string">&#x27;s&#x27;</span> :<span class="number">0x88</span>, <span class="string">&#x27;nop&#x27;</span>:<span class="number">0x90</span>,<span class="string">&#x27;jmp&#x27;</span>:<span class="number">0xE9</span>, <span class="string">&#x27;j&#x27;</span>:<span class="number">0x0F</span>&#125;</span><br><span class="line">  JMP_SIZE = <span class="number">5</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_unreachable</span>(<span class="params">self, bb</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bb, <span class="built_in">int</span>):</span><br><span class="line">      bb = self.block(bb)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(bb.instrs)):</span><br><span class="line">      <span class="keyword">if</span> bb.instrs[i].mnemonic != <span class="string">&quot;call&quot;</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      target = bb.instrs[i].operands[<span class="number">0</span>].immediate</span><br><span class="line">      <span class="keyword">if</span> target == self.func_terminate:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">block</span>(<span class="params">self, addr</span>):</span></span><br><span class="line">    bb = self.cfg.find_basic_block(addr)</span><br><span class="line">    <span class="keyword">if</span> bb <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      bb = barf.bb_builder.strategy._disassemble_bb(addr, barf.binary.ea_end, &#123;&#125;)</span><br><span class="line">    <span class="keyword">return</span> bb</span><br><span class="line"></span><br><span class="line"><span class="meta">  @staticmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_imm</span>(<span class="params">operand</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">hasattr</span>(operand, <span class="string">&quot;_X86ImmediateOperand__key&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">  @staticmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_reg</span>(<span class="params">operand</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">hasattr</span>(operand, <span class="string">&quot;_X86RegisterOperand__key&quot;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_call_throw</span>(<span class="params">self, instr</span>):</span></span><br><span class="line">    <span class="keyword">return</span> instr.mnemonic == <span class="string">&quot;call&quot;</span> <span class="keyword">and</span> \</span><br><span class="line">        self.is_imm(instr.operands[<span class="number">0</span>]) <span class="keyword">and</span>\</span><br><span class="line">        instr.operands[<span class="number">0</span>].immediate == self.func_throw</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_call_allocate_exception</span>(<span class="params">self, instr</span>):</span></span><br><span class="line">    <span class="keyword">return</span> instr.mnemonic == <span class="string">&quot;call&quot;</span> <span class="keyword">and</span> \</span><br><span class="line">        self.is_imm(instr.operands[<span class="number">0</span>]) <span class="keyword">and</span>\</span><br><span class="line">        instr.operands[<span class="number">0</span>].immediate == self.func_allocate_exception</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_call_obf_exception</span>(<span class="params">self, instr</span>):</span></span><br><span class="line">    <span class="keyword">return</span> instr.mnemonic == <span class="string">&quot;call&quot;</span> <span class="keyword">and</span> \</span><br><span class="line">        self.is_imm(instr.operands[<span class="number">0</span>]) <span class="keyword">and</span>\</span><br><span class="line">        instr.operands[<span class="number">0</span>].immediate == self.func_obf_exception</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">skip_call_args</span>(<span class="params">self, bb, i</span>):</span></span><br><span class="line">    <span class="keyword">while</span> ((bb.instrs[i].mnemonic <span class="keyword">in</span> [<span class="string">&quot;xor&quot;</span>,<span class="string">&quot;mov&quot;</span>,<span class="string">&quot;lea&quot;</span>]) <span class="keyword">and</span>\</span><br><span class="line">      (<span class="built_in">len</span>(bb.instrs[i].operands) &gt; <span class="number">0</span>) <span class="keyword">and</span> (self.is_reg(bb.instrs[i].operands[<span class="number">0</span>])) <span class="keyword">and</span>\</span><br><span class="line">      (bb.instrs[i].operands[<span class="number">0</span>].name <span class="keyword">in</span> [<span class="string">&quot;edx&quot;</span>, <span class="string">&quot;rdx&quot;</span>, <span class="string">&quot;esi&quot;</span>, <span class="string">&quot;rsi&quot;</span>, <span class="string">&quot;edi&quot;</span>, <span class="string">&quot;rdi&quot;</span>])) <span class="keyword">or</span> \</span><br><span class="line">      bb.instrs[i].mnemonic == <span class="string">&quot;nop&quot;</span>:</span><br><span class="line">      i -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_patchable_from_relblk</span>(<span class="params">self, bb</span>):</span></span><br><span class="line">    i = <span class="number">0</span> </span><br><span class="line">    end = bb.start_address + bb.size</span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(bb.instrs) <span class="keyword">and</span> <span class="keyword">not</span> self.is_call_throw(bb.instrs[i]):</span><br><span class="line">      i += <span class="number">1</span></span><br><span class="line">    i = self.skip_call_args(bb, i-<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="built_in">len</span>(bb.instrs) - <span class="number">1</span>:</span><br><span class="line">      start = end </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      start = bb.instrs[i+<span class="number">1</span>].address</span><br><span class="line">    self.fill_nops(start, end)</span><br><span class="line">    <span class="keyword">return</span> (start, end-start)</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, proj, elf, barf, cfg</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">    self.p = proj</span><br><span class="line">    obj = proj.loader.main_object</span><br><span class="line">    self.func_terminate = obj.symbols_by_name[<span class="string">&quot;__clang_call_terminate&quot;</span>].rebased_addr</span><br><span class="line">    self.func_throw = obj.plt[<span class="string">&quot;__cxa_throw&quot;</span>]</span><br><span class="line">    self.func_allocate_exception = obj.plt[<span class="string">&quot;__cxa_allocate_exception&quot;</span>]</span><br><span class="line">    self.func_obf_exception = obj.symbols_by_name[<span class="string">&quot;_ZN18StdSubObfExceptionC2Ec&quot;</span>].rebased_addr</span><br><span class="line">    self.elf = elf</span><br><span class="line">    self.elfData = <span class="built_in">bytearray</span>(self.elf.data)</span><br><span class="line">    self.barf = barf</span><br><span class="line">    self.cfg = cfg</span><br><span class="line">    self.nops = []</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">append_nop</span>(<span class="params">self, nopblk</span>):</span></span><br><span class="line">    <span class="keyword">if</span> nopblk[<span class="number">1</span>] &gt; <span class="number">0</span>:</span><br><span class="line">      self.nops.append(nopblk)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">finalize</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.nops.sort()</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; <span class="built_in">len</span>(self.nops) - <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">if</span> self.nops[idx][<span class="number">0</span>] + self.nops[idx][<span class="number">1</span>] != self.nops[idx+<span class="number">1</span>][<span class="number">0</span>]:</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      self.nops[idx]=(self.nops[idx][<span class="number">0</span>], self.nops[idx][<span class="number">1</span>]+self.nops[idx+<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">      <span class="keyword">del</span> self.nops[idx+<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fill_nops</span>(<span class="params">self, va_start, va_end</span>):</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="keyword">not</span> self.elf <span class="keyword">is</span> <span class="literal">None</span></span><br><span class="line">    start = self.elf.vaddr_to_offset(va_start)</span><br><span class="line">    end   = self.elf.vaddr_to_offset(va_end)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end):</span><br><span class="line">      self.elfData[i] = PatchHelper.opcode[<span class="string">&#x27;nop&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_nop_by_size</span>(<span class="params">self, min_size</span>):</span></span><br><span class="line">    <span class="keyword">for</span> idx, nop <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.nops):</span><br><span class="line">      <span class="keyword">if</span> nop[<span class="number">1</span>] &gt; min_size:</span><br><span class="line">        <span class="keyword">del</span> self.nops[idx]</span><br><span class="line">        <span class="keyword">return</span> nop</span><br><span class="line">    <span class="keyword">return</span> (-<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">do_patch</span>(<span class="params">self, va_start, codes</span>):</span></span><br><span class="line">    start = self.elf.vaddr_to_offset(va_start)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(codes)):</span><br><span class="line">      self.elfData[start+i] = codes[i]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">patch_jmp</span>(<span class="params">self, va_start, va_target</span>):</span></span><br><span class="line">    offset = va_target - va_start - PatchHelper.JMP_SIZE</span><br><span class="line">    jmp = <span class="built_in">bytes</span>([PatchHelper.opcode[<span class="string">&#x27;jmp&#x27;</span>]])+struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, offset)</span><br><span class="line">    self.do_patch(va_start, jmp)</span><br><span class="line">    <span class="keyword">return</span> PatchHelper.JMP_SIZE</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">patch_branches</span>(<span class="params">self, bb, va_targets</span>):</span></span><br><span class="line">    va_start, size = self.get_patchable_from_relblk(bb)</span><br><span class="line">    <span class="keyword">if</span> size &lt; PatchHelper.JMP_SIZE:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;[Warning] patch_jmp at block %x may fail. size: %d.&quot;</span>%(bb.address, size))</span><br><span class="line">    org_start = va_start</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;va_start: <span class="subst">&#123;<span class="built_in">hex</span>(va_start)&#125;</span>, bb addr: <span class="subst">&#123;<span class="built_in">hex</span>(bb.address)&#125;</span>, size: <span class="subst">&#123;size&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment">## `cmp esi, v` instr takes 3 bytes while `je xxx` takes 6 bytes</span></span><br><span class="line">    <span class="comment">## And the last jmp instr takes 5 bytes. </span></span><br><span class="line">    total_size = (<span class="number">3</span>+<span class="number">6</span>) * <span class="built_in">len</span>(va_targets) - <span class="number">4</span></span><br><span class="line">    <span class="keyword">if</span> size &lt; total_size:</span><br><span class="line">      <span class="comment">## If the nop block at the end of current block is not large enough, </span></span><br><span class="line">   	  <span class="comment">## try to find another nop block and then jump to it. </span></span><br><span class="line">      nx_va_start, nx_size = self.get_nop_by_size(total_size)</span><br><span class="line">      <span class="keyword">if</span> nx_size == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[31m[Error]\033[0m `patch_branches` needs a nop block with size larger than %d.&quot;</span>%(total_size))</span><br><span class="line">      self.patch_jmp(va_start, nx_va_start)</span><br><span class="line">      va_start, size = nx_va_start, nx_size</span><br><span class="line">    <span class="keyword">for</span> i, t <span class="keyword">in</span> <span class="built_in">enumerate</span>(va_targets[:-<span class="number">1</span>]):</span><br><span class="line">      cmp_instr = <span class="built_in">bytes</span>([<span class="number">0x83</span>,<span class="number">0xfe</span>,i])</span><br><span class="line">      self.do_patch(va_start, cmp_instr)</span><br><span class="line">      va_start += <span class="built_in">len</span>(cmp_instr)</span><br><span class="line">      cj_instr = <span class="built_in">bytes</span>([PatchHelper.opcode[<span class="string">&#x27;j&#x27;</span>],PatchHelper.opcode[<span class="string">&#x27;e&#x27;</span>]])</span><br><span class="line">      <span class="keyword">if</span> t == -<span class="number">1</span>:</span><br><span class="line">        <span class="comment">## -1 represent that we do not know the flow for this selector value for now. </span></span><br><span class="line">        cj_instr += struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, self.func_terminate-va_start-<span class="number">6</span>)</span><br><span class="line">        <span class="comment"># cj_instr = asm(f&quot;je &#123;hex(self.func_terminate)&#125;&quot;, vma=va_start)</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        cj_instr += struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, t-va_start-<span class="number">6</span>)</span><br><span class="line">        <span class="comment"># cj_instr = asm(f&quot;je &#123;hex(t)&#125;&quot;, vma=va_start)</span></span><br><span class="line">      self.do_patch(va_start, cj_instr)</span><br><span class="line">      va_start += <span class="built_in">len</span>(cj_instr)</span><br><span class="line">    va_start += self.patch_jmp(va_start, va_targets[-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> va_start &gt; org_start+size:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;[Warning] patches at (%x, %x) overlaps next blk. &quot;</span>%(org_start, va_start))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_relevant_blocks</span>(<span class="params">cfg, patch_helper, main_dispatcher</span>):</span></span><br><span class="line">  isCmpRI = <span class="keyword">lambda</span> instr: instr.mnemonic == <span class="string">&quot;cmp&quot;</span> <span class="keyword">and</span>\</span><br><span class="line">    <span class="built_in">hasattr</span>(instr.operands[<span class="number">0</span>], <span class="string">&quot;_X86RegisterOperand__key&quot;</span>) <span class="keyword">and</span>\</span><br><span class="line">    <span class="built_in">hasattr</span>(instr.operands[<span class="number">1</span>], <span class="string">&quot;_X86ImmediateOperand__key&quot;</span>) </span><br><span class="line">  isCJmp = <span class="keyword">lambda</span> instr: instr.mnemonic.startswith(<span class="string">&quot;j&quot;</span>) <span class="keyword">and</span> \</span><br><span class="line">    instr.mnemonic != <span class="string">&quot;jmp&quot;</span></span><br><span class="line">  isSubDispatcher = <span class="keyword">lambda</span> bb: (<span class="built_in">len</span>(bb.instrs) == <span class="number">2</span>) <span class="keyword">and</span>\</span><br><span class="line">     isCmpRI(bb.instrs[<span class="number">0</span>]) <span class="keyword">and</span> isCJmp(bb.instrs[<span class="number">1</span>])</span><br><span class="line">  relevant_blocks = []</span><br><span class="line">  visited = <span class="built_in">set</span>()</span><br><span class="line">  q = SimpleQueue()</span><br><span class="line">  q.put(patch_helper.block(main_dispatcher))</span><br><span class="line">  <span class="keyword">while</span> <span class="keyword">not</span> q.empty():</span><br><span class="line">    bb = q.get()</span><br><span class="line">    <span class="keyword">if</span> isSubDispatcher(bb):</span><br><span class="line">      patch_helper.append_nop((bb.start_address, bb.size))</span><br><span class="line">      <span class="keyword">for</span> succ, cond <span class="keyword">in</span> bb.branches:</span><br><span class="line">        <span class="keyword">if</span> succ <span class="keyword">in</span> visited:</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        q.put(patch_helper.block(succ))</span><br><span class="line">        visited.add(succ)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      relevant_blocks.append(bb)</span><br><span class="line">  <span class="keyword">return</span> relevant_blocks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_logs</span>(<span class="params">logfn, prologue, patch_helper</span>):</span></span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(logfn, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    t = f.readlines()</span><br><span class="line">  i = <span class="number">0</span></span><br><span class="line">  selector_s = <span class="string">&quot;selector: &quot;</span></span><br><span class="line">  landingpad_s = <span class="string">&quot;landingPad: &quot;</span></span><br><span class="line">  relations = <span class="built_in">set</span>()</span><br><span class="line">  laddr = prologue</span><br><span class="line">  lselector = <span class="number">0</span></span><br><span class="line">  landingpad = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(t):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      addr = <span class="built_in">int</span>(t[i], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">      i += <span class="number">1</span></span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> laddr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      relations.add((laddr, lselector, addr))</span><br><span class="line">    <span class="keyword">if</span> t[i+<span class="number">1</span>].startswith(selector_s):</span><br><span class="line">      selector = <span class="built_in">int</span>(t[i+<span class="number">1</span>][<span class="built_in">len</span>(selector_s):], <span class="number">16</span>)</span><br><span class="line">      i += <span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> t[i+<span class="number">1</span>].startswith(landingpad_s):</span><br><span class="line">      landingpad = <span class="built_in">int</span>(t[i+<span class="number">1</span>][<span class="built_in">len</span>(landingpad_s):], <span class="number">16</span>)</span><br><span class="line">      relations.add((addr, -<span class="number">1</span>, landingpad))</span><br><span class="line">      addr = landingpad</span><br><span class="line">      <span class="keyword">while</span> <span class="keyword">not</span> patch_helper.is_unreachable(patch_helper.block(addr).direct_branch):</span><br><span class="line">        addr = patch_helper.block(addr).direct_branch</span><br><span class="line">      <span class="keyword">if</span> t[i+<span class="number">2</span>].startswith(selector_s):</span><br><span class="line">        selector = <span class="built_in">int</span>(t[i+<span class="number">2</span>][<span class="built_in">len</span>(selector_s):], <span class="number">16</span>)</span><br><span class="line">      i += <span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> t[i+<span class="number">1</span>].startswith(<span class="string">&quot;[Inferior &quot;</span>):</span><br><span class="line">      i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Warning: %x doesn&#x27;t have selector. &quot;</span>%addr)</span><br><span class="line">      exit(<span class="number">0</span>)</span><br><span class="line">    laddr = addr</span><br><span class="line">    lselector = selector</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">list</span>(relations)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_gdb_script</span>(<span class="params">relevant_blocks</span>):</span></span><br><span class="line">  cmds = <span class="string">&quot;&quot;&quot;\</span></span><br><span class="line"><span class="string">set pagination off</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">b *0x40A3D4</span></span><br><span class="line"><span class="string">commands</span></span><br><span class="line"><span class="string">  silent</span></span><br><span class="line"><span class="string">  printf &quot;landingPad: %x\n&quot;, $rdx</span></span><br><span class="line"><span class="string">  continue</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">b _ZN18StdSubObfExceptionC2Ec</span></span><br><span class="line"><span class="string">commands</span></span><br><span class="line"><span class="string">  silent</span></span><br><span class="line"><span class="string">  printf &quot;selector: %x\n&quot;, $rsi</span></span><br><span class="line"><span class="string">  continue</span></span><br><span class="line"><span class="string">end </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">define mytrace </span></span><br><span class="line"><span class="string">  break $arg0</span></span><br><span class="line"><span class="string">  commands</span></span><br><span class="line"><span class="string">    silent</span></span><br><span class="line"><span class="string">    printf &quot;%x\\n&quot;, $pc</span></span><br><span class="line"><span class="string">    python gdb.execute(&#x27;continue&#x27;)</span></span><br><span class="line"><span class="string">  end</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">for</span> bb <span class="keyword">in</span> relevant_blocks:</span><br><span class="line">    cmds += (<span class="string">f&quot;mytrace *<span class="subst">&#123;<span class="built_in">hex</span>(bb.address)&#125;</span> \n&quot;</span>)</span><br><span class="line">  cmds += <span class="string">&quot;run\n&quot;</span></span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.gdb&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(cmds)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Usage: python deflat.py filename function_address(hex) [logfile]&#x27;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># context.arch = &quot;amd64&quot;</span></span><br><span class="line">    <span class="comment"># context.os = &quot;linux&quot;</span></span><br><span class="line">    <span class="comment"># context.endian = &quot;little&quot;</span></span><br><span class="line"></span><br><span class="line">    filename = sys.argv[<span class="number">1</span>]</span><br><span class="line">    start = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    origin = elf.ELF(filename)</span><br><span class="line">    b = angr.Project(filename, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;main_opts&#x27;</span>:&#123;<span class="string">&#x27;custom_base_addr&#x27;</span>: <span class="number">0</span>&#125;&#125;)</span><br><span class="line">    barf = BARF(filename)</span><br><span class="line">    cfg = barf.recover_cfg(start=start)</span><br><span class="line">    patch_helper = PatchHelper(b, origin, barf, cfg)</span><br><span class="line">    blocks = cfg.basic_blocks</span><br><span class="line"></span><br><span class="line">    prologue = start</span><br><span class="line">    main_dispatcher = patch_helper.block(prologue).direct_branch</span><br><span class="line">    relevant_blocks = get_relevant_blocks(cfg, patch_helper, main_dispatcher)</span><br><span class="line">    nop = patch_helper.get_patchable_from_relblk(patch_helper.block(prologue))</span><br><span class="line">    patch_helper.append_nop(nop)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******************relevant blocks************************&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;main_dispatcher:%#x&#x27;</span> % main_dispatcher)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;relevant_blocks:&#x27;</span>, [<span class="built_in">hex</span>(bb.address) <span class="keyword">for</span> bb <span class="keyword">in</span> relevant_blocks])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">4</span>:</span><br><span class="line">      generate_gdb_script(relevant_blocks)</span><br><span class="line">      exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;************************flow******************************&#x27;</span>)</span><br><span class="line">    relations = parse_logs(sys.argv[<span class="number">3</span>], prologue, patch_helper)</span><br><span class="line">    relations.sort(key = <span class="keyword">lambda</span> x:x)</span><br><span class="line">    flow = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> bb, selector, child <span class="keyword">in</span> relations:</span><br><span class="line">      <span class="keyword">if</span> bb <span class="keyword">in</span> flow:</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(flow[bb]) &lt; selector:</span><br><span class="line">          flow[bb].append(-<span class="number">1</span>)</span><br><span class="line">        flow[bb].append(child)</span><br><span class="line">        <span class="keyword">assert</span>(<span class="built_in">len</span>(flow[bb]) == selector+<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        flow[bb] = [child]</span><br><span class="line">    <span class="keyword">for</span> (k, v) <span class="keyword">in</span> <span class="built_in">list</span>(flow.items()):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%#x:&#x27;</span> % k, [<span class="built_in">hex</span>(child) <span class="keyword">for</span> child <span class="keyword">in</span> v])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;************************patch*****************************&#x27;</span>)</span><br><span class="line">    patch_helper.finalize()</span><br><span class="line">    <span class="keyword">for</span> (parent, childs) <span class="keyword">in</span> <span class="built_in">list</span>(flow.items()):</span><br><span class="line">      <span class="comment">## Patch jmps</span></span><br><span class="line">      blk = patch_helper.block(parent)</span><br><span class="line">      patch_helper.patch_branches(blk, childs)</span><br><span class="line">      <span class="comment">## Nop call allocate_exception and call obf_exception</span></span><br><span class="line">      <span class="keyword">for</span> idx, instr <span class="keyword">in</span> <span class="built_in">enumerate</span>(blk.instrs):</span><br><span class="line">        <span class="keyword">if</span> patch_helper.is_call_allocate_exception(instr) <span class="keyword">or</span>\</span><br><span class="line">          patch_helper.is_call_obf_exception(instr):</span><br><span class="line">          <span class="comment"># si = patch_helper.skip_call_args(blk, idx-1)+1</span></span><br><span class="line">          <span class="comment"># start = blk.instrs[si].address</span></span><br><span class="line">          start = instr.address</span><br><span class="line">          end = instr.address + instr.size</span><br><span class="line">          patch_helper.fill_nops(start, end)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename + <span class="string">&#x27;.recovered&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="built_in">bytes</span>(patch_helper.elfData))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Successful! The recovered file: %s&#x27;</span> % (filename + <span class="string">&#x27;.recovered&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>Work flow:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python deflat.py inflated <span class="number">0x404820</span></span><br><span class="line">$ gdb inflated -x test.gdb --batch &lt; testin &gt; testout</span><br><span class="line">$ python deflat.py inflated <span class="number">0x404820</span> testout</span><br></pre></td></tr></table></figure>

<p>（按照以上流程，test.gdb可能会报个错，程序把本身有个\n是脚本中需要打印的，但直接转义成真换行了需要手动恢复）</p>
<p>观看修复后的流程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  v3 = <span class="built_in">fileno</span>(stdin);</span><br><span class="line">  <span class="built_in">tcgetattr</span>(v3, &amp;intermiosBufBackup);</span><br><span class="line">  <span class="built_in">cfmakeraw</span>(&amp;intermiosBuf);</span><br><span class="line">  <span class="built_in">tcsetattr</span>(v3, <span class="number">0</span>, &amp;intermiosBuf);</span><br><span class="line">  *(_OWORD *)v196 = <span class="number">0LL</span>;</span><br><span class="line">  v195 = <span class="number">0LL</span>;</span><br><span class="line">  *(_OWORD *)s = <span class="number">0LL</span>;</span><br><span class="line">  *(_QWORD *)&amp;v196[<span class="number">13</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v124 = &amp;v168;</span><br><span class="line">  v123 = &amp;v167;</span><br><span class="line">  v164 = v199;</span><br><span class="line">  v187 = &amp;v198;</span><br><span class="line">  v186 = &amp;v96;</span><br><span class="line">  v185 = &amp;v97;</span><br><span class="line">  v184 = &amp;v100;</span><br><span class="line">  v122 = &amp;s[<span class="number">12</span>];</span><br><span class="line">  v108 = v103;</span><br><span class="line">  v163 = &amp;v197;</span><br><span class="line">  v183 = &amp;v99;</span><br><span class="line">  v162 = &amp;v166;</span><br><span class="line">  ......</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v72 = v4;</span><br><span class="line">    v98 = <span class="built_in">getc</span>(stdin);</span><br><span class="line">    v73 = v98 &lt;&lt; <span class="number">24</span>;</span><br><span class="line">    v74 = v98 &lt;&lt; <span class="number">24</span> == <span class="number">0x1B000000</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v98 &lt;&lt; <span class="number">24</span> == <span class="number">0x31000000</span> )</span><br><span class="line">      v74 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v73 == <span class="number">0x37000000</span> )</span><br><span class="line">      v74 = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v73 == <span class="number">0x33000000</span> )</span><br><span class="line">      v74 = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v73 == <span class="number">0x34000000</span> )</span><br><span class="line">      v74 = <span class="number">5</span>;</span><br><span class="line">    v101 = v5;</span><br><span class="line">    v102 = v72;</span><br><span class="line">    v119 = v72;</span><br><span class="line">    <span class="keyword">if</span> ( v74 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v74 == <span class="number">1</span> )</span><br><span class="line">        _clang_call_terminate(<span class="number">5LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v74 == <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v107 = v102 + (<span class="number">4LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)v101));</span><br><span class="line">        v85 = v98;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( v74 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v107 = v102 + (<span class="number">5LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)v101));</span><br><span class="line">        v85 = v98;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v74 == <span class="number">4</span> )</span><br><span class="line">          v107 = v102 + (<span class="number">6LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)v101));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v107 = v102 + (<span class="number">7LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)v101));</span><br><span class="line">        v85 = v98;</span><br><span class="line">      &#125;</span><br><span class="line">      s[v101] = v85;</span><br><span class="line">      v119 = v107;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = v101 + <span class="number">1</span>;</span><br><span class="line">    v174 = v119;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v101 != <span class="number">11</span> );</span><br><span class="line">  s[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">  v69 = <span class="built_in">fileno</span>(stdin);</span><br><span class="line">  <span class="built_in">tcsetattr</span>(v69, <span class="number">0</span>, &amp;intermiosBufBackup);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; <span class="number">5</span>; ++i )</span><br><span class="line">    *((_BYTE *)v136 + i) = byte_40E0F3[i] - byte_40E0F8[i];</span><br><span class="line">  v188 = &amp;v190;</span><br><span class="line">  v190 = v136[<span class="number">0</span>];</span><br><span class="line">  v189 = <span class="number">4LL</span>;</span><br><span class="line">  v191 = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(&amp;v190, v122);</span><br><span class="line">  v26 = v188;</span><br><span class="line">  v175 = v188;</span><br><span class="line">  *(_OWORD *)v188 = xmmword_40E040;</span><br><span class="line">  v26[<span class="number">4</span>] = <span class="number">639210836</span>;</span><br><span class="line">  *((_BYTE *)v26 + <span class="number">20</span>) = <span class="number">16</span>;</span><br><span class="line">  *(_QWORD *)((<span class="keyword">char</span> *)v26 + <span class="number">34</span>) = <span class="number">0x1005E763241AA6B1</span>LL;</span><br><span class="line">  *(_OWORD *)((<span class="keyword">char</span> *)v26 + <span class="number">21</span>) = xmmword_40E148;</span><br><span class="line">  __cxa_begin_catch(v26);</span><br><span class="line">  v155 = <span class="built_in">strlen</span>(v122);</span><br><span class="line">  v128 = <span class="number">0LL</span>;</span><br><span class="line">  v113 = <span class="number">0</span>;</span><br><span class="line">  v125 = v155;</span><br><span class="line">  v147 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v133 = v125 - <span class="number">1</span>;</span><br><span class="line">    v86 = v122[v147];</span><br><span class="line">    v160 = v128;</span><br><span class="line">    v110 = v113;</span><br><span class="line">    v176 = v147;</span><br><span class="line">    <span class="built_in">isalnum</span>(v86);</span><br><span class="line">    v50 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v160 + <span class="number">1</span>);</span><br><span class="line">    *(&amp;v95 + (<span class="keyword">int</span>)v160) = v86;</span><br><span class="line">    v181 = v176 + <span class="number">1</span>;</span><br><span class="line">    v130 = v50;</span><br><span class="line">    v112 = v110;</span><br><span class="line">    v146 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)v50 == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v106 = <span class="number">0LL</span>;</span><br><span class="line">        v149 = v146;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v199[v106 + <span class="number">16</span>] = byte_40E071[v106] - byte_40E0B2[v106];</span><br><span class="line">          ++v106;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v106 &lt; <span class="number">0x41</span> );</span><br><span class="line">        v56 = v163;</span><br><span class="line">        *(_QWORD *)v163 = v164;</span><br><span class="line">        v165 = <span class="number">64LL</span>;</span><br><span class="line">        v169 = (_OWORD *)std::__cxx11::basic_string&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;,std::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_create(</span><br><span class="line">                           v56,</span><br><span class="line">                           &amp;v165,</span><br><span class="line">                           <span class="number">0LL</span>);</span><br><span class="line">        v9 = (<span class="keyword">void</span> **)v163;</span><br><span class="line">        v10 = v169;</span><br><span class="line">        *(_QWORD *)v163 = v169;</span><br><span class="line">        v11 = v165;</span><br><span class="line">        *(_QWORD *)v164 = v165;</span><br><span class="line">        v12 = MEMORY[<span class="number">5</span>];</span><br><span class="line">        v13 = MEMORY[<span class="number">0x15</span>];</span><br><span class="line">        v14 = MEMORY[<span class="number">0x25</span>];</span><br><span class="line">        v10[<span class="number">3</span>] = MEMORY[<span class="number">0x35</span>];</span><br><span class="line">        v10[<span class="number">2</span>] = v14;</span><br><span class="line">        v10[<span class="number">1</span>] = v13;</span><br><span class="line">        *v10 = v12;</span><br><span class="line">        *(_QWORD *)v187 = v11;</span><br><span class="line">        *((_BYTE *)v10 + v11) = <span class="number">0</span>;</span><br><span class="line">        v15 = v149;</span><br><span class="line">        *(&amp;v95 + v15) = std::__cxx11::basic_string&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;,std::allocator&lt;<span class="keyword">char</span>&gt;&gt;::<span class="built_in">find</span>(</span><br><span class="line">                          v9,</span><br><span class="line">                          (<span class="keyword">unsigned</span> <span class="keyword">int</span>)*(&amp;v95 + v149),</span><br><span class="line">                          <span class="number">0LL</span>);</span><br><span class="line">        v177 = *v9;</span><br><span class="line">        <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v177)</span></span>;</span><br><span class="line">        v146 = v149 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v149 != <span class="number">3</span> );</span><br><span class="line">      v17 = *v186;</span><br><span class="line">      *v183 = (<span class="number">4</span> * *v57) | ((<span class="keyword">unsigned</span> __int8)*v186 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">3</span>;</span><br><span class="line">      v18 = *v185;</span><br><span class="line">      *v59 = (<span class="number">16</span> * v17) | ((<span class="keyword">unsigned</span> __int8)*v185 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">      *v184 = *v58 + (v18 &lt;&lt; <span class="number">6</span>);</span><br><span class="line">      v152 = v110;</span><br><span class="line">      v151 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v6 = v151;</span><br><span class="line">        v7 = (<span class="keyword">unsigned</span> __int8)*(&amp;v99 + v151) / <span class="number">0xA</span>u;</span><br><span class="line">        v8 = v152;</span><br><span class="line">        v199[v152 + <span class="number">96</span>] = (<span class="keyword">unsigned</span> __int8)*(&amp;v99 + v151) % <span class="number">0xA</span>u;</span><br><span class="line">        v199[v8 + <span class="number">97</span>] = v7;</span><br><span class="line">        v151 = v6 + <span class="number">1</span>;</span><br><span class="line">        v152 = v8 + <span class="number">2</span>;</span><br><span class="line">        v182 = v8 + <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v6 != <span class="number">2</span> );</span><br><span class="line">      v130 = <span class="number">0LL</span>;</span><br><span class="line">      v112 = v182;</span><br><span class="line">    &#125;</span><br><span class="line">    v128 = v130;</span><br><span class="line">    v113 = v112;</span><br><span class="line">    v125 = v133;</span><br><span class="line">    v147 = v181;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v133 );</span><br><span class="line">  __cxa_end_catch();</span><br><span class="line">  v193 = <span class="number">152788034LL</span>;</span><br><span class="line">  v192[<span class="number">3</span>] = xmmword_40E130;</span><br><span class="line">  v192[<span class="number">2</span>] = xmmword_40E120;</span><br><span class="line">  v192[<span class="number">1</span>] = xmmword_40E110;</span><br><span class="line">  v192[<span class="number">0</span>] = xmmword_40E100;</span><br><span class="line">  v138 = <span class="number">152788034LL</span>;</span><br><span class="line">  cipher_helper&lt;<span class="number">12037464u</span>,StList&lt;<span class="number">0ul</span>,<span class="number">1ul</span>,<span class="number">2ul</span>,<span class="number">3ul</span>,<span class="number">4ul</span>,<span class="number">5ul</span>,<span class="number">6ul</span>,<span class="number">7ul</span>,<span class="number">8ul</span>,<span class="number">9ul</span>,<span class="number">10ul</span>,<span class="number">11ul</span>,<span class="number">12ul</span>,<span class="number">13ul</span>,<span class="number">14ul</span>,<span class="number">15ul</span>,<span class="number">16ul</span>,<span class="number">17ul</span>,<span class="number">18ul</span>,<span class="number">19ul</span>,<span class="number">20ul</span>,<span class="number">21ul</span>,<span class="number">22ul</span>,<span class="number">23ul</span>,<span class="number">24ul</span>,<span class="number">25ul</span>,<span class="number">26ul</span>,<span class="number">27ul</span>,<span class="number">28ul</span>,<span class="number">29ul</span>,<span class="number">30ul</span>,<span class="number">31ul</span>,<span class="number">32ul</span>,<span class="number">33ul</span>,<span class="number">34ul</span>,<span class="number">35ul</span>,<span class="number">36ul</span>,<span class="number">37ul</span>,<span class="number">38ul</span>,<span class="number">39ul</span>&gt;&gt;::<span class="built_in">get_array</span>(</span><br><span class="line">    <span class="number">152788034LL</span>,</span><br><span class="line">    <span class="string">&quot;Knows the futility yet does it anyway. &quot;</span>);</span><br><span class="line">  v55 = v138;</span><br><span class="line">  *(_OWORD *)(v138 + <span class="number">56</span>) = xmmword_40E16D;</span><br><span class="line">  *(_OWORD *)(v55 + <span class="number">40</span>) = xmmword_40E15D;</span><br><span class="line">  *(_QWORD *)(v55 + <span class="number">72</span>) = <span class="number">0x6FF0E70B5B3F60A4</span>LL;</span><br><span class="line">  v137 = (<span class="keyword">void</span> *)<span class="number">0x6FF0E70B5B3F60A4</span>LL;</span><br><span class="line">  __cxa_begin_catch((<span class="keyword">void</span> *)<span class="number">0x6FF0E70B5B3F60A4</span>LL);</span><br><span class="line">  v145 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v67 = v145;</span><br><span class="line">    *((_DWORD *)v192 + <span class="number">2</span> * v145) ^= <span class="number">0x9005408</span>u;</span><br><span class="line">    v145 = v67 + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v67 != <span class="number">8</span> );</span><br><span class="line">  __cxa_end_catch();</span><br><span class="line">  *(_OWORD *)v75 = xmmword_40E030;</span><br><span class="line">  *((_QWORD *)v75 + <span class="number">2</span>) = <span class="number">0x48D1556A814FF991</span>LL;</span><br><span class="line">  *((_QWORD *)v75 + <span class="number">5</span>) = <span class="number">0x48B0E10161EA8322</span>LL;</span><br><span class="line">  v25 = <span class="number">-2.526699287193993e95</span>;</span><br><span class="line">  *(_OWORD *)(v75 + <span class="number">24</span>) = xmmword_40E185;</span><br><span class="line">  __cxa_begin_catch(v75);</span><br><span class="line">  v121 = <span class="number">0LL</span>;</span><br><span class="line">  v109 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v27 = v121;</span><br><span class="line">    v179 = (<span class="keyword">unsigned</span> __int64 *)v192 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v121 / <span class="number">9uLL</span>;</span><br><span class="line">    v28 = *v179;</span><br><span class="line">    v29 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v121 % <span class="number">9</span>;</span><br><span class="line">    v30 = <span class="built_in">pow</span>(v25, (<span class="keyword">double</span>)(<span class="keyword">int</span>)((<span class="keyword">unsigned</span> <span class="keyword">int</span>)v121 % <span class="number">9</span> + <span class="number">1</span>));</span><br><span class="line">    v178 = v28;</span><br><span class="line">    v31 = v28 % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)(v30 + <span class="number">0.5</span>);</span><br><span class="line">    y = (<span class="keyword">double</span>)v29;</span><br><span class="line">    v32 = <span class="built_in">pow</span>(<span class="number">11.0</span>, (<span class="keyword">double</span>)v29) + <span class="number">0.5</span>;</span><br><span class="line">    v33 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)v32;</span><br><span class="line">    v25 = v32 - <span class="number">9.223372036854776e18</span>;</span><br><span class="line">    v158 = v27;</span><br><span class="line">    v157 = v109;</span><br><span class="line">    v111 = v109;</span><br><span class="line">    <span class="keyword">if</span> ( v31 &lt; v33 )</span><br><span class="line">    &#123;</span><br><span class="line">      v111 = v157 + <span class="number">1</span>;</span><br><span class="line">      v51 = v199[(<span class="keyword">int</span>)v157 + <span class="number">96</span>];</span><br><span class="line">      v52 = <span class="built_in">pow</span>(v25, y) + <span class="number">0.5</span>;</span><br><span class="line">      v53 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)v52;</span><br><span class="line">      v25 = v52 - <span class="number">9.223372036854776e18</span>;</span><br><span class="line">      *v179 = v178 + v51 * v53;</span><br><span class="line">    &#125;</span><br><span class="line">    v121 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v158 + <span class="number">1</span>);</span><br><span class="line">    v109 = v111;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( (_DWORD)v158 != <span class="number">80</span> );</span><br><span class="line">  __cxa_end_catch();</span><br><span class="line">  v88 = <span class="number">1</span>;</span><br><span class="line">  v140 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v60 = v108;</span><br><span class="line">    v108[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    *(_QWORD *)v60 = <span class="number">0LL</span>;</span><br><span class="line">    v171 = *((_QWORD *)v192 + v140);</span><br><span class="line">    v126 = <span class="number">0LL</span>;</span><br><span class="line">    v170 = v140;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v19 = v126;</span><br><span class="line">      v20 = v126 + <span class="number">1</span>;</span><br><span class="line">      v21 = <span class="built_in">pow</span>(v25, (<span class="keyword">double</span>)((<span class="keyword">int</span>)v126 + <span class="number">1</span>));</span><br><span class="line">      v22 = v171 % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)(v21 + <span class="number">0.5</span>);</span><br><span class="line">      v23 = <span class="built_in">pow</span>(<span class="number">11.0</span>, (<span class="keyword">double</span>)v19) + <span class="number">0.5</span>;</span><br><span class="line">      v24 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)v23;</span><br><span class="line">      v25 = v23 - <span class="number">9.223372036854776e18</span>;</span><br><span class="line">      v103[v22 / v24] = <span class="number">1</span>;</span><br><span class="line">      v141 = <span class="number">1LL</span>;</span><br><span class="line">      v89 = v88;</span><br><span class="line">      v126 = v20;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v20 != <span class="number">9</span> );</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v61 = v89;</span><br><span class="line">      <span class="keyword">if</span> ( !v103[v141] )</span><br><span class="line">        v61 = <span class="number">0</span>;</span><br><span class="line">      ++v141;</span><br><span class="line">      v115 = v61;</span><br><span class="line">      v89 = v61;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v141 != <span class="number">10</span> );</span><br><span class="line">    v140 = v170 + <span class="number">1</span>;</span><br><span class="line">    v131 = <span class="number">0LL</span>;</span><br><span class="line">    v87 = v115;</span><br><span class="line">    v88 = v115;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v170 != <span class="number">8</span> );</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v68 = v108;</span><br><span class="line">    v108[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    *(_QWORD *)v68 = <span class="number">0LL</span>;</span><br><span class="line">    v172 = (<span class="keyword">double</span>)((<span class="keyword">int</span>)v131 + <span class="number">1</span>);</span><br><span class="line">    v40 = (<span class="keyword">double</span>)(<span class="keyword">int</span>)v131;</span><br><span class="line">    v173 = (<span class="keyword">double</span>)(<span class="keyword">int</span>)v131;</span><br><span class="line">    v161 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v131;</span><br><span class="line">    v142 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v62 = v142;</span><br><span class="line">      v63 = *((_QWORD *)v192 + v142);</span><br><span class="line">      v64 = v63 % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)(<span class="built_in">pow</span>(v40, v172) + <span class="number">0.5</span>);</span><br><span class="line">      v65 = <span class="built_in">pow</span>(<span class="number">11.0</span>, v173) + <span class="number">0.5</span>;</span><br><span class="line">      v66 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)v65;</span><br><span class="line">      v40 = v65 - <span class="number">9.223372036854776e18</span>;</span><br><span class="line">      v103[v64 / v66] = <span class="number">1</span>;</span><br><span class="line">      v142 = v62 + <span class="number">1</span>;</span><br><span class="line">      v144 = <span class="number">1LL</span>;</span><br><span class="line">      v90 = v87;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v62 != <span class="number">8</span> );</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v71 = v90;</span><br><span class="line">      <span class="keyword">if</span> ( !v103[v144] )</span><br><span class="line">        v71 = <span class="number">0</span>;</span><br><span class="line">      ++v144;</span><br><span class="line">      v116 = v71;</span><br><span class="line">      v90 = v71;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v144 != <span class="number">10</span> );</span><br><span class="line">    v131 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v161 + <span class="number">1</span>);</span><br><span class="line">    v132 = <span class="number">0LL</span>;</span><br><span class="line">    v92 = v116;</span><br><span class="line">    v87 = v116;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( (_DWORD)v131 != <span class="number">9</span> );</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v54 = v108;</span><br><span class="line">    v108[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    *(_QWORD *)v54 = <span class="number">0LL</span>;</span><br><span class="line">    v135 = <span class="number">3</span> * ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)v132 / <span class="number">3</span>);</span><br><span class="line">    v134 = <span class="number">3</span> * ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)v132 % <span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">    v129 = <span class="number">0LL</span>;</span><br><span class="line">    v159 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v132;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v34 = v129;</span><br><span class="line">      v35 = *((_QWORD *)v192 + (<span class="keyword">int</span>)(v135 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v129 / <span class="number">3</span>));</span><br><span class="line">      v36 = (v134 + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v129 % <span class="number">3</span>) % <span class="number">9</span>;</span><br><span class="line">      v37 = v35 % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)(<span class="built_in">pow</span>(v40, (<span class="keyword">double</span>)(v36 + <span class="number">1</span>)) + <span class="number">0.5</span>);</span><br><span class="line">      v38 = <span class="built_in">pow</span>(<span class="number">11.0</span>, (<span class="keyword">double</span>)v36) + <span class="number">0.5</span>;</span><br><span class="line">      v39 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)v38;</span><br><span class="line">      v40 = v38 - <span class="number">9.223372036854776e18</span>;</span><br><span class="line">      v103[v37 / v39] = <span class="number">1</span>;</span><br><span class="line">      v129 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v34 + <span class="number">1</span>);</span><br><span class="line">      v150 = <span class="number">1LL</span>;</span><br><span class="line">      v94 = v92;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v34 != <span class="number">8</span> );</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v70 = v94;</span><br><span class="line">      <span class="keyword">if</span> ( !v103[v150] )</span><br><span class="line">        v70 = <span class="number">0</span>;</span><br><span class="line">      ++v150;</span><br><span class="line">      v104 = v70;</span><br><span class="line">      v94 = v70;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v150 != <span class="number">10</span> );</span><br><span class="line">    v132 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v159 + <span class="number">1</span>);</span><br><span class="line">    v92 = v104;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( (_DWORD)v159 != <span class="number">8</span> );</span><br><span class="line">  v48 = v108;</span><br><span class="line">  v108[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)v48 = <span class="number">0LL</span>;</span><br><span class="line">  v127 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v41 = v127;</span><br><span class="line">    v42 = <span class="number">9</span> - v127;</span><br><span class="line">    <span class="keyword">if</span> ( !(_DWORD)v127 )</span><br><span class="line">      v42 = <span class="number">0</span>;</span><br><span class="line">    v43 = *((_QWORD *)v192 + v42);</span><br><span class="line">    v44 = v127 + <span class="number">1</span>;</span><br><span class="line">    v45 = v43 % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)(<span class="built_in">pow</span>(v40, (<span class="keyword">double</span>)((<span class="keyword">int</span>)v127 + <span class="number">1</span>)) + <span class="number">0.5</span>);</span><br><span class="line">    v46 = <span class="built_in">pow</span>(<span class="number">11.0</span>, (<span class="keyword">double</span>)v41) + <span class="number">0.5</span>;</span><br><span class="line">    v47 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)v46;</span><br><span class="line">    v40 = v46 - <span class="number">9.223372036854776e18</span>;</span><br><span class="line">    v103[v45 / v47] = <span class="number">1</span>;</span><br><span class="line">    v143 = <span class="number">1LL</span>;</span><br><span class="line">    v91 = v104;</span><br><span class="line">    v127 = v44;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v44 != <span class="number">9</span> );</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v49 = v91;</span><br><span class="line">    <span class="keyword">if</span> ( !v103[v143] )</span><br><span class="line">      v49 = <span class="number">0</span>;</span><br><span class="line">    ++v143;</span><br><span class="line">    v117 = v49;</span><br><span class="line">    v91 = v49;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v143 != <span class="number">10</span> );</span><br><span class="line">  v16 = v108;</span><br><span class="line">  v108[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)v16 = <span class="number">0LL</span>;</span><br><span class="line">  v139 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v76 = v139 + <span class="number">1</span>;</span><br><span class="line">    v77 = v139 == <span class="number">8</span>;</span><br><span class="line">    v78 = v139 + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v139 == <span class="number">8</span> )</span><br><span class="line">      v78 = <span class="number">0</span>;</span><br><span class="line">    v79 = *((_QWORD *)v192 + v139);</span><br><span class="line">    v80 = v79 % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)(<span class="built_in">pow</span>(v40, (<span class="keyword">double</span>)(v78 + <span class="number">1</span>)) + <span class="number">0.5</span>);</span><br><span class="line">    v81 = <span class="built_in">pow</span>(<span class="number">11.0</span>, (<span class="keyword">double</span>)v78) + <span class="number">0.5</span>;</span><br><span class="line">    v82 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">int</span>)v81;</span><br><span class="line">    v40 = v81 - <span class="number">9.223372036854776e18</span>;</span><br><span class="line">    v103[v80 / v82] = <span class="number">1</span>;</span><br><span class="line">    v148 = <span class="number">1LL</span>;</span><br><span class="line">    v93 = v117;</span><br><span class="line">    v139 = v76;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !v77 );</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v83 = v93;</span><br><span class="line">    <span class="keyword">if</span> ( !v103[v148] )</span><br><span class="line">      v83 = <span class="number">0</span>;</span><br><span class="line">    ++v148;</span><br><span class="line">    v118 = v83;</span><br><span class="line">    v93 = v83;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v148 != <span class="number">10</span> );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="0x03-Solve-the-Puzzles"><a href="#0x03-Solve-the-Puzzles" class="headerlink" title="0x03 Solve the Puzzles"></a>0x03 Solve the Puzzles</h1><h2 id="PART-ONE"><a href="#PART-ONE" class="headerlink" title="PART ONE"></a>PART ONE</h2><p>之前也提到过，由于我们的输入部分流可能执行不到，很明显我们刚刚根本没有输入上下左右箭头啥的</p>
<p>所以关于处理上下左右箭头的代码无了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line"> &#123;</span><br><span class="line">   v72 = v4;</span><br><span class="line">   input1 = <span class="built_in">getc</span>(stdin);</span><br><span class="line">   v73 = input1 &lt;&lt; <span class="number">24</span>;</span><br><span class="line">   shift_input1 = input1 &lt;&lt; <span class="number">24</span> == <span class="number">0x1B000000</span>;</span><br><span class="line">   <span class="keyword">if</span> ( input1 &lt;&lt; <span class="number">24</span> == <span class="number">0x31000000</span> )</span><br><span class="line">     shift_input1 = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">if</span> ( v73 == <span class="number">0x37000000</span> )</span><br><span class="line">     shift_input1 = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">if</span> ( v73 == <span class="number">0x33000000</span> )</span><br><span class="line">     shift_input1 = <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">if</span> ( v73 == <span class="number">0x34000000</span> )</span><br><span class="line">     shift_input1 = <span class="number">5</span>;</span><br><span class="line">   count = v5;</span><br><span class="line">   v102 = v72;</span><br><span class="line">   v119 = v72;</span><br><span class="line">   <span class="keyword">if</span> ( shift_input1 )</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> ( shift_input1 == <span class="number">1</span> )</span><br><span class="line">       _clang_call_terminate((<span class="keyword">void</span> *)<span class="number">5</span>);</span><br><span class="line">     <span class="keyword">if</span> ( shift_input1 == <span class="number">2</span> )</span><br><span class="line">     &#123;</span><br><span class="line">       v107 = v102 + (<span class="number">4LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)count));</span><br><span class="line">       org_input = input1;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> ( shift_input1 == <span class="number">3</span> )</span><br><span class="line">     &#123;</span><br><span class="line">       v107 = v102 + (<span class="number">5LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)count));</span><br><span class="line">       org_input = input1;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">     &#123;</span><br><span class="line">       <span class="keyword">if</span> ( shift_input1 == <span class="number">4</span> )</span><br><span class="line">         v107 = v102 + (<span class="number">6LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)count));</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">         v107 = v102 + (<span class="number">7LL</span> &lt;&lt; (<span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)count));</span><br><span class="line">       org_input = input1;</span><br><span class="line">     &#125;</span><br><span class="line">     s[count] = org_input;</span><br><span class="line">     v119 = v107;</span><br><span class="line">   &#125;</span><br><span class="line">   v5 = count + <span class="number">1</span>;</span><br><span class="line">   v174 = v119;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">while</span> ( count != <span class="number">11</span> );</span><br></pre></td></tr></table></figure>

<p>这个时候就可以更改我们的输入（指的是输入箭头再输入字符）再来一遍</p>
<p>成功解析出我们的第一段输入</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220721003105302.png" alt="image-20220721003105302"></p>
<p>由于两个文件分析过程不贴了，可以直接看官方WP给出的源码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> part1_size = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">while</span>(count &lt; part1_size) &#123;</span><br><span class="line">  <span class="keyword">char</span> a = <span class="built_in">getchar</span>();</span><br><span class="line">  <span class="keyword">if</span> (a == <span class="number">27</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getchar</span>() == <span class="number">91</span>) &#123;</span><br><span class="line">      <span class="keyword">char</span> c = <span class="built_in">getchar</span>();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">rmCjJ0</span>(<span class="literal">true</span>, c);</span><br><span class="line">      &#125; <span class="built_in"><span class="keyword">catch</span></span>(Le3KW5 &amp;cc) &#123;</span><br><span class="line">        <span class="keyword">char</span> c = cc.state;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">65</span>) &#123;</span><br><span class="line">          state += <span class="number">0ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">66</span>) &#123;</span><br><span class="line">          state += <span class="number">2ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">67</span>) &#123;</span><br><span class="line">          state += <span class="number">1ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">68</span>) &#123;</span><br><span class="line">          state += <span class="number">3ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      flag[count] = c;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a==<span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    state += <span class="number">4ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">    flag[count] = a;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a==<span class="string">&#x27;7&#x27;</span>) &#123;</span><br><span class="line">    state += <span class="number">5ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">    flag[count] = a;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a==<span class="string">&#x27;3&#x27;</span>) &#123;</span><br><span class="line">    state += <span class="number">6ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">    flag[count] = a;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a==<span class="string">&#x27;4&#x27;</span>) &#123;</span><br><span class="line">    state += <span class="number">7ull</span> &lt;&lt; (<span class="number">3</span> * count);</span><br><span class="line">    flag[count] = a;</span><br><span class="line">  &#125;</span><br><span class="line">  count += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ... Second Part ...</span></span><br><span class="line"><span class="comment">// Check Part</span></span><br><span class="line"><span class="keyword">if</span> (... &amp;&amp; state == <span class="number">0xb3e659480</span>) &#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="built_in">LIT</span>(<span class="string">&quot;Congratulation! \n&quot;</span>) &lt;&lt; <span class="built_in">LIT</span>(<span class="string">&quot;Your flag is ACTF&#123;&quot;</span>) &lt;&lt; flag &lt;&lt; <span class="built_in">LIT</span>(<span class="string">&quot;_amazing!&#125;&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="PART-TWO"><a href="#PART-TWO" class="headerlink" title="PART TWO"></a>PART TWO</h2><p>这个部分完全跟着lchild的分析来了</p>
<p>接着就是第二段输入</p>
<p>首先是经过一段Base64解码操作，再经过取模除十操作得到一个数组</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> ( (_DWORD)v50 == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v106 = <span class="number">0LL</span>;</span><br><span class="line">      v149 = v146;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        baseTable[v106 + <span class="number">16</span>] = byte_40E071[v106] - byte_40E0B2[v106];<span class="comment">// baseTable</span></span><br><span class="line">        ++v106;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v106 &lt; <span class="number">0x41</span> );</span><br><span class="line">      v56 = (__int64)v163;</span><br><span class="line">      *(_QWORD *)v163 = v164;</span><br><span class="line">      v165 = <span class="number">64LL</span>;</span><br><span class="line">      v169 = (_OWORD *)std::__cxx11::basic_string&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;,std::allocator&lt;<span class="keyword">char</span>&gt;&gt;::_M_create(</span><br><span class="line">                         v56,</span><br><span class="line">                         &amp;v165,</span><br><span class="line">                         <span class="number">0LL</span>);</span><br><span class="line">      v9 = (<span class="keyword">void</span> **)v163;</span><br><span class="line">      v10 = v169;</span><br><span class="line">      *(_QWORD *)v163 = v169;</span><br><span class="line">      v11 = v165;</span><br><span class="line">      *(_QWORD *)v164 = v165;</span><br><span class="line">      v12 = MEMORY[<span class="number">5</span>];</span><br><span class="line">      v13 = MEMORY[<span class="number">0x15</span>];</span><br><span class="line">      v14 = MEMORY[<span class="number">0x25</span>];</span><br><span class="line">      v10[<span class="number">3</span>] = MEMORY[<span class="number">0x35</span>];</span><br><span class="line">      v10[<span class="number">2</span>] = v14;</span><br><span class="line">      v10[<span class="number">1</span>] = v13;</span><br><span class="line">      *v10 = v12;</span><br><span class="line">      *(_QWORD *)v187 = v11;</span><br><span class="line">      *((_BYTE *)v10 + v11) = <span class="number">0</span>;</span><br><span class="line">      v15 = v149;</span><br><span class="line">      *(&amp;copy_input1 + v15) = std::__cxx11::basic_string&lt;<span class="keyword">char</span>,std::char_traits&lt;<span class="keyword">char</span>&gt;,std::allocator&lt;<span class="keyword">char</span>&gt;&gt;::<span class="built_in">find</span>(</span><br><span class="line">                                v9,</span><br><span class="line">                                (<span class="keyword">unsigned</span> <span class="keyword">int</span>)*(&amp;copy_input1 + v149),</span><br><span class="line">                                <span class="number">0LL</span>);</span><br><span class="line">      v177 = *v9;</span><br><span class="line">      <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v177)</span></span>;</span><br><span class="line">      v146 = v149 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v149 != <span class="number">3</span> );</span><br><span class="line">    v17 = *v186;</span><br><span class="line">    *v183 = (<span class="number">4</span> * *v57) | ((<span class="keyword">unsigned</span> __int8)*v186 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">3</span>;</span><br><span class="line">    v18 = *v185;</span><br><span class="line">    *v59 = (<span class="number">16</span> * v17) | ((<span class="keyword">unsigned</span> __int8)*v185 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">    *v184 = *v58 + (v18 &lt;&lt; <span class="number">6</span>);</span><br><span class="line">    v152 = v110;</span><br><span class="line">    v151 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;                                         <span class="comment">// 对输入进行操作分值操作</span></span><br><span class="line">      v6 = v151;</span><br><span class="line">      v7 = (<span class="keyword">unsigned</span> __int8)*(&amp;v99 + v151) / <span class="number">0xA</span>u;</span><br><span class="line">      v8 = v152;</span><br><span class="line">      baseTable[v152 + <span class="number">96</span>] = (<span class="keyword">unsigned</span> __int8)*(&amp;v99 + v151) % <span class="number">0xA</span>u;</span><br><span class="line">      baseTable[v8 + <span class="number">97</span>] = v7;</span><br><span class="line">      v151 = v6 + <span class="number">1</span>;</span><br><span class="line">      v152 = v8 + <span class="number">2</span>;</span><br><span class="line">      v182 = v8 + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v6 != <span class="number">2</span> );</span><br><span class="line">    v130 = <span class="number">0LL</span>;</span><br><span class="line">    v112 = v182;</span><br><span class="line">  &#125;</span><br><span class="line">  v128 = v130;</span><br><span class="line">  v113 = v112;</span><br><span class="line">  copy_len = v133;</span><br><span class="line">  v147 = v181;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v133 );                               <span class="comment">// 以上是对input进行了base64解码</span></span><br></pre></td></tr></table></figure>

<p>之后计算了九个数值，和一堆pang臭的代码，不过干的事情不是很复杂</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220721003955450.png" alt="image-20220721003955450"></p>
<p>第一个循环是复制，后两个循环判断行列，不难发现这是个数独，拿网站一把梭了</p>
<blockquote>
<p>具体参考lchild师傅的Write up </p>
<p># <a target="_blank" rel="noopener" href="https://sudoku.vip/sudoku-x-solver/">https://sudoku.vip/sudoku-x-solver/</a></p>
</blockquote>
<h1 id="0x04-GetFlag"><a href="#0x04-GetFlag" class="headerlink" title="0x04 GetFlag!!"></a>0x04 GetFlag!!</h1><p>第一个解密就直接移回去即可</p>
<p>第二个解密出数独的值，列移动，取出值恢复原权位值，最后Base64即可！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">s = []</span><br><span class="line">t = <span class="number">0xB3E659480</span></span><br><span class="line"><span class="comment"># 每3个字节为一次输入</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">    s.append(t &amp; <span class="number">0x7</span>) </span><br><span class="line">    t &gt;&gt;= <span class="number">3</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> t == <span class="number">0</span></span><br><span class="line">key = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>: key += <span class="string">&#x27;↑&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">1</span>: key += <span class="string">&#x27;→&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">2</span>: key += <span class="string">&#x27;↓&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">3</span>: key += <span class="string">&#x27;←&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">4</span>: key += <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">5</span>: key += <span class="string">&#x27;7&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">6</span>: key += <span class="string">&#x27;3&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">7</span>: key += <span class="string">&#x27;4&#x27;</span> </span><br><span class="line"><span class="built_in">print</span>(key) <span class="comment"># ??↓↓→←→←3417</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">values = [<span class="number">0x00000000331b6d84</span>, <span class="number">0x0000000054cab29a</span>, <span class="number">0x000000000cd0afcd</span>,</span><br><span class="line"><span class="number">0x000000006636db08</span>, <span class="number">0x0000000000021528</span>, <span class="number">0x0000000005d62020</span>, <span class="number">0x00000000070bc7c1</span>,</span><br><span class="line"><span class="number">0x00000000006739bd</span>, <span class="number">0x00000000001b084a</span>]</span><br><span class="line">table = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> values:</span><br><span class="line">    table.append([])</span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    value = i</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        table[-<span class="number">1</span>].append(<span class="built_in">int</span>(value % <span class="number">11</span>))</span><br><span class="line">        s += <span class="string">&quot;%2d&quot;</span> % (value % <span class="number">11</span>)</span><br><span class="line">        value /= <span class="number">11</span></span><br><span class="line"> <span class="comment">#   print(s[2: ] + s[: 2])</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"> 0 0 0 0 0 0 0 4 0</span></span><br><span class="line"><span class="string"> 0 0 5 0 0 0 7 6 0</span></span><br><span class="line"><span class="string"> 0 0 0 0 4 0 0 1 0</span></span><br><span class="line"><span class="string"> 0 0 0 0 0 0 0 8 0</span></span><br><span class="line"><span class="string"> 0 6 3 9 0 0 0 0 0</span></span><br><span class="line"><span class="string"> 0 0 0 0 3 0 5 0 0</span></span><br><span class="line"><span class="string"> 2 9 0 0 8 0 6 0 0</span></span><br><span class="line"><span class="string"> 0 7 0 0 9 3 0 0 0</span></span><br><span class="line"><span class="string"> 3 0 0 0 0 1 0 0 0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(sum(table, []).count(0))</span></span><br><span class="line"><span class="comment"># https://sudoku.vip/sudoku-x-solver/</span></span><br><span class="line"></span><br><span class="line">solves = [</span><br><span class="line">[<span class="number">8</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>],</span><br><span class="line">[<span class="number">4</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">2</span>],</span><br><span class="line">[<span class="number">7</span>, <span class="number">2</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">5</span>],</span><br><span class="line">[<span class="number">9</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">3</span>],</span><br><span class="line">[<span class="number">5</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">6</span>],</span><br><span class="line">[<span class="number">2</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>],</span><br><span class="line">[<span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>],</span><br><span class="line">[<span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">4</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数独列右移</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    solves[i] = [solves[i][-<span class="number">1</span>]] + solves[i][: -<span class="number">1</span>]</span><br><span class="line"><span class="comment">#    print(solves[i])</span></span><br><span class="line"></span><br><span class="line">numbers = []</span><br><span class="line"><span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">            <span class="keyword">if</span> table[y][x] == <span class="number">0</span>: </span><br><span class="line"><span class="comment">#                print(table[y][x])</span></span><br><span class="line">                numbers.append(solves[y][x])</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(numbers) % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(numbers), <span class="number">2</span>):</span><br><span class="line">    flag += <span class="built_in">chr</span>(numbers[i] + <span class="number">10</span> * numbers[i + <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># print(flag)</span></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(<span class="built_in">str</span>.encode(flag)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ↑↑↓↓→←→←3417</span></span><br><span class="line"><span class="comment"># WT05ICpTW0tcPyYxETgMGTBDUSphES1TLgwtVUwd</span></span><br></pre></td></tr></table></figure>

<p>最后输入上上下下右左右左3417再二段</p>
<p>GetFlag!!</p>
<p><img src="/2022/07/21/ACTF2022-Inflated/image-20220721005233195.png" alt="image-20220721005233195"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>对于我这种0 throw catch小白0 ollvm小白，过程中是补了不少文章…学识尚浅如果有错误的地方欢迎指出，一定会严加学习修改！</p>
<p>最后拿到flag，也是对这题的一个happy ending，真是REVERSE生涯中目前做的最难的一题了</p>
<p>回忆起最开始wjh师傅教我的unicorn再到Helen师傅出的login，这次又上了台阶！逆向真是越来越有趣了。–7.21 00:55</p>

    </div>

    <p style= "text-align:center">
        让我看看我被读了 
    <b><span id="/2022/07/21/ACTF2022-Inflated/" class="waline-visitor-count"/>...</b> 次呢🎉</p>
    
    <div id = "frozen-btn" class = "center">
    <!-- <button class="green" onclick = "Change()">🎉☕一杯咖啡~</button> -->
    <button class="purple" onclick = "Change()">🍰</button>
    </div>
    
    <div class = "hide" id = "img">
        <div class="post-list">
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/AliPay.png" alt="DASCTF X SU">
                    <div class="center">
                        支付宝
                    </div>
                </div>
            </article>
            <article class="post-list-item">
                <div class="content">
                    <img src="/img/Coffee/WeChat.png" alt="HFCTF2022">
                    <div class="center">
                        微信
                    </div>
                </div>
            </article>
        </div>
    </div>
    <script>
            function Change()
            {
                var img = document.getElementById("img");
                if(img.className == "hide")
                {
                    img.className="";
                }
                else
                {
                    img.className="hide";
                }
            }
    </script>

    <div class="about">
        <h1>About this Post</h1>
        <p>This post is written by P.Z, licensed under <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>
    <!-- 
        
     -->
<div class="container">
<div id="waline"></div>
  <script>
    Waline({
      el: '#waline',
      serverURL: 'https://blog-api-5rvxh62nz-pozeep.vercel.app/',  
      visitor: true,
      emoji: [   //这里加了一些表情 
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba',
      ],
       avatar: 'robohash',   //自定义默认头像为随机的机器人
       placeholder: '评论什么好呢',   //占位符
    });
  </script>
</div>

<!-- <span id="/2022/07/21/ACTF2022-Inflated/" class="leancloud_visitors" data-flag-title="ACTF2022-Inflated">
    <em class="post-meta-item-text">阅读量 </em>
    <i class="waline-visitor-count"></i>
</span> -->

</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item">Home</a>
                
                <a href="/Diary/Diary.html" class="item">Diary</a>
                
                <a href="/Friends/Friends.html" class="item">Friends</a>
                
                <a href="/CTF/CTF.html" class="item">CTF</a>
                
                <a href="/Book/Book.html" class="item">Book</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a target="_blank" rel="noopener" href="https://github.com/PoZeep" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/39892350" class="item">BiliBili</a>
                
            </div>
            
        </div>
        <span>&copy; 2022 P.Z<br >Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
        
    <span id="sitetime" style="text-align: center;display:block;"></span>


</footer>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 12, 27, 12, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "我已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了*/
    siteTime();
</script>

<!-- 在线通讯Tidio -->

<script src="//code.tidio.co/zmdcv08a6racnaer2so7xybdwby41fsa.js"></script>



        
<script src="/js/main.js"></script>

        
    </body>
</html>